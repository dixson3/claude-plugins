---
name: yf:chronicle_diary
description: Generate diary entries from open chronicles and close them
arguments:
  - name: plan_idx
    description: "Optional plan index to filter chronicles (e.g., 0007-b4m2k). Only processes chronicles tagged with plan:<idx>."
    required: false
---

## Activation Guard

Before proceeding, check that yf is active:

```bash
ACTIVATION=$(bash "${CLAUDE_PLUGIN_ROOT}/scripts/yf-activation-check.sh")
IS_ACTIVE=$(echo "$ACTIVATION" | jq -r '.active')
```

If `IS_ACTIVE` is not `true`, read the `reason` and `action` fields from `$ACTIVATION` and tell the user:

> Yoshiko Flow is not active: {reason}. {action}

Then stop. Do not execute the remaining steps.

## Tools

```bash
YFT="$CLAUDE_PLUGIN_ROOT/scripts/yf-task-cli.sh"
```

# Chronicler Diary Skill

Generate consolidated diary entries from open chronicle tasks.

## Instructions

Use the `yf_chronicle_diary` agent to:
1. Query all open chronicle tasks
2. Group tasks by theme/topic
3. Generate diary markdown files
4. Close the processed tasks

## Behavior

When invoked with `/yf:chronicle_diary`:

1. **Query tasks**: List all open tasks with `ys:chronicle` label (optionally filtered by `plan:<idx>`)
2. **Check chronicle gate**: If `plan_idx` specified, check for open `ys:chronicle-gate` task. If gate is still open, warn: "Plan still executing â€” diary will capture partial arc. Proceed anyway?" If no gate or gate closed, proceed.
3. **Launch agent**: Use the `yf_chronicle_diary` agent to process
4. **Generate files**: Create diary entries in `docs/diary/`
5. **Close tasks**: Mark processed tasks as closed

### Agent Invocation

If `plan_idx` is specified:
```bash
bash "$YFT" list --label=ys:chronicle --label=plan:<idx> --status=open
```

If no `plan_idx`:
```bash
bash "$YFT" list --label=ys:chronicle --status=open
```

The diary agent:
- Reads all matching open chronicle tasks
- Groups by theme (may combine related topics)
- Generates markdown diary entries
- Returns JSON with filenames and content

### Diary Entry Format

Filename: `docs/diary/YY-MM-DD.HH-MM.<topic>.md`

```markdown
# Diary Entry: <Title>

**Date**: YYYY-MM-DD HH:MM
**Operator**: <resolved operator name>
**Topics**: feature, planning
**Chronicle IDs**: abc123, def456

## Summary
Narrative journal entry describing the arc of work.

## Decisions
- Key decision 1 and rationale
- Key decision 2 and rationale

## Next Steps
- [ ] Action item 1
- [ ] Action item 2

---
*Generated by chronicler from 2 chronicle tasks*
```

## Expected Output

Report includes: chronicle task count, theme groupings, generated diary file paths (with titles and source chronicles), close status for each task, and total counts.

## Pre-Push Integration

The diary skill is designed to run before git push:

1. Pre-push hook detects open chronicles
2. Signals to run `/yf:chronicle_diary`
3. Diary entries are staged with the push
4. Chronicles are closed

If no open chronicles exist, reports nothing to process. Diary entries are written to `docs/diary/` (created by preflight).
