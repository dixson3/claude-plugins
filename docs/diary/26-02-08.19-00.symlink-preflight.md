# Diary Entry: Zero-Commit Rule Management — Symlink-Based Preflight

**Date**: 2026-02-08 19:00
**Topics**: preflight, symlinks, config-model, migration
**Plan**: 17
**Chronicle IDs**: marketplace-cfr

## Summary

Completed the transition from file-copy-based rule management to symlink-based. The yf plugin now leaves zero committed artifacts outside `plugins/` — all 9 rules in `.claude/rules/` are gitignored symlinks pointing back to `plugins/yf/rules/`, and configuration lives entirely in the gitignored `.claude/yf.local.json`.

The motivation was simple: enabling a plugin for a repo shouldn't pollute its git history with control files. Previously, preflight copied rules into `.claude/rules/` (committed), maintained checksums for conflict detection, and split config across a committed `yf.json` and a local `yf.local.json`. Now there's a single source of truth for rules (the plugin source), no checksums (symlinks can't diverge), and a single local config file.

## Decisions

- **Symlinks over gitignored copies**: Symlinks give a single source of truth — edits to `plugins/yf/rules/` are immediately active without re-syncing. This also eliminates the entire checksum/conflict detection system, which was the most complex part of `plugin-preflight.sh`.
- **CLAUDE.local.md concatenation rejected**: Considered merging all rules into a single file but rejected it — loses per-rule granularity, conflicts with user-owned CLAUDE.local.md, and prevents conditional rule loading (e.g., skipping chronicle rules when chronicler is disabled).
- **Relative vs absolute symlinks**: When the plugin is inside the project tree (`plugins/yf/`), relative symlinks are created (`../../plugins/yf/rules/yf-beads.md`). When loaded from outside (e.g., a plugin cache), absolute paths are used. The `compute_link_target()` function handles this distinction.
- **Local-only config (v3)**: Consolidated the two-file model (committed `yf.json` + local `yf.local.json`) into a single local file. The setup skill no longer asks "share config with team?" — config is always local.
- **Verified symlink safety first**: Phase 1 was a 5-minute experiment creating a test symlink and confirming Claude Code loads rules through symlinks. This de-risked the entire approach before committing to the rewrite.

## Implementation Highlights

- `plugin-preflight.sh` went from ~455 lines to ~180 lines (net -266 lines across the full changeset)
- Removed: `sha256_file()`, all checksum logic, conflict detection, `cp` operations, `yf.json` write logic
- Added: `compute_link_target()` for relative/absolute path computation, `readlink`-based fast path
- Migration chain now handles 4 formats: `plugin-lock.json` (v0) → `yf.json` v1 → `yf.json` v2 → `yf.local.json` v3
- Regular files (from old copies) are automatically migrated to symlinks on preflight run
- Lock format: `mode: "symlink"`, `link` field replaces `checksum` per rule entry
- Deleted `unit-preflight-conflict.yaml` (conflict detection is meaningless with symlinks)
- Added `unit-preflight-symlinks.yaml` with 6 new test cases
- All 245 unit tests pass

## Challenges

- Test harness runs preflight in a temp directory where the plugin root is outside the project tree, so symlinks are absolute — had to adjust test assertions to check for `plugins/yf/rules/` pattern instead of assuming relative paths
- `jq -e` with null values leaked output in assertions — switched to `jq -r '.field // "absent"'` pattern
- `bd create --type=gate` not supported in beads v0.49.4 — used `--type=task` with gate labels as workaround

## Next Steps

- [ ] Consider making `.beads/` local-only (same pattern — gitignore, `bd init` on first run)
- [ ] Monitor for any issues with symlinks on different platforms or CI environments

---
*Generated by chronicler from 1 chronicle bead*
