# Diary Entry: Zero-Commit Rule Management — Symlink-Based Preflight

**Date**: 2026-02-08 19:00
**Operator**: James Dixson
**Topics**: preflight, symlinks, config-model, migration
**Plan**: 17
**Chronicle IDs**: marketplace-cfr

## Summary

Plan 17 tackled a problem James had been eyeing since the consolidation: enabling a plugin for a repo should not pollute its git history with control files. The previous preflight system copied rules into `.claude/rules/` as committed files, maintained checksums for conflict detection, and split config across a committed `yf.json` and a local `yf.local.json`. James wanted zero committed artifacts outside `plugins/` -- everything managed by the plugin should be either a symlink or gitignored.

We started with a five-minute experiment: create a test symlink in `.claude/rules/` pointing to a plugin rule file and confirm Claude Code loads rules through symlinks. It did, and that de-risked the entire approach before we committed to the rewrite. From there, we replaced the file-copy mechanism in `plugin-preflight.sh` with symlink creation. When the plugin lives inside the project tree (the `plugins/yf/` case), relative symlinks are created via a `compute_link_target()` function. When loaded from outside the tree, such as Claude Code's plugin cache, absolute paths are used instead.

The simplification was dramatic. The preflight script went from roughly 455 lines to 180 lines, shedding `sha256_file()`, all checksum logic, conflict detection, and `cp` operations. The lock format changed to use `mode: "symlink"` with a `link` field replacing `checksum` per rule entry. Regular files left over from old installations are automatically migrated to symlinks on the next preflight run. The migration chain now handles four formats spanning the full history from `plugin-lock.json` v0 through to `yf.local.json` v3.

We also collapsed the two-file config model into a single gitignored `yf.local.json`, since the entire point of committed config was moot when the plugin leaves no committed footprint. The setup skill no longer asks about sharing config with the team. All nine rules in `.claude/rules/` are now gitignored symlinks, and configuration lives entirely in the gitignored local file. We deleted the conflict detection test scenario (meaningless with symlinks), added `unit-preflight-symlinks.yaml` with six new cases, and finished with all 245 unit tests passing.

## Decisions

- **Symlinks over gitignored copies**: Symlinks give a single source of truth — edits to `plugins/yf/rules/` are immediately active without re-syncing. This also eliminates the entire checksum/conflict detection system, which was the most complex part of `plugin-preflight.sh`.
- **CLAUDE.local.md concatenation rejected**: Considered merging all rules into a single file but rejected it — loses per-rule granularity, conflicts with user-owned CLAUDE.local.md, and prevents conditional rule loading (e.g., skipping chronicle rules when chronicler is disabled).
- **Relative vs absolute symlinks**: When the plugin is inside the project tree (`plugins/yf/`), relative symlinks are created (`../../plugins/yf/rules/yf-beads.md`). When loaded from outside (e.g., a plugin cache), absolute paths are used. The `compute_link_target()` function handles this distinction.
- **Local-only config (v3)**: Consolidated the two-file model (committed `yf.json` + local `yf.local.json`) into a single local file. The setup skill no longer asks "share config with team?" — config is always local.
- **Verified symlink safety first**: Phase 1 was a 5-minute experiment creating a test symlink and confirming Claude Code loads rules through symlinks. This de-risked the entire approach before committing to the rewrite.

## Implementation Highlights

- `plugin-preflight.sh` went from ~455 lines to ~180 lines (net -266 lines across the full changeset)
- Removed: `sha256_file()`, all checksum logic, conflict detection, `cp` operations, `yf.json` write logic
- Added: `compute_link_target()` for relative/absolute path computation, `readlink`-based fast path
- Migration chain now handles 4 formats: `plugin-lock.json` (v0) → `yf.json` v1 → `yf.json` v2 → `yf.local.json` v3
- Regular files (from old copies) are automatically migrated to symlinks on preflight run
- Lock format: `mode: "symlink"`, `link` field replaces `checksum` per rule entry
- Deleted `unit-preflight-conflict.yaml` (conflict detection is meaningless with symlinks)
- Added `unit-preflight-symlinks.yaml` with 6 new test cases
- All 245 unit tests pass

## Challenges

- Test harness runs preflight in a temp directory where the plugin root is outside the project tree, so symlinks are absolute — had to adjust test assertions to check for `plugins/yf/rules/` pattern instead of assuming relative paths
- `jq -e` with null values leaked output in assertions — switched to `jq -r '.field // "absent"'` pattern
- `bd create --type=gate` not supported in beads v0.49.4 — used `--type=task` with gate labels as workaround

## Next Steps

- [ ] Consider making `.beads/` local-only (same pattern — gitignore, `bd init` on first run)
- [ ] Monitor for any issues with symlinks on different platforms or CI environments

---
*Generated by chronicler from 1 chronicle bead*
