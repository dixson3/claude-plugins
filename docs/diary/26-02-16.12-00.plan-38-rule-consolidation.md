# Diary Entry: Plan 38 -- Rule Consolidation, Migration Pruning, and Plan-Intake Enforcement

**Date**: 2026-02-16
**Operator**: James Dixson
**Topics**: implementation, architecture, plan-38
**Chronicle IDs**: marketplace-6rj, marketplace-6y9, marketplace-k8a, marketplace-kuz, marketplace-m6g

## Summary

GitHub issue #11 reported that the agent was bypassing `plan_intake` when told to "implement the following plan" -- the most critical lifecycle gate was being skipped. James traced the root cause to rule dilution: with 24 separate rule files, the agent's context was spread thin enough that hard enforcement rules carried no more weight than advisory suggestions. Plan 38 attacked the problem from two directions -- reducing rule count and adding structural enforcement -- and we implemented all 7 phases in a single session.

The centerpiece was consolidating all 24 rule files into a single prioritized `yf-rules.md`. We organized the rules into 5 tiers: hard enforcement (beads source of truth, plan intake, formula dispatch), plan lifecycle (auto-chain, phrase triggers, breakdown, completion report), swarm execution (comment protocol, nesting, reactive bugfix), session protocol (beads quick ref, landing the plane), and advisory monitoring (swarm bridges, chronicle/archive worthiness, spec drift). This reduced approximately 1400 lines across 24 files to roughly 210 lines in one file, ensuring the agent reads critical rules before advisory ones.

The second prong was upgrading the beads safety net in `code-gate.sh` from an advisory warning (exit 0) to a blocking response (exit 2 with JSON). We added a 60-second TTL cache to avoid `bd list` queries on every Edit/Write, exempt file patterns matching the plan-gate exemptions, and an escape hatch via `.yoshiko-flow/plan-intake-skip` for cases where the gate is genuinely unnecessary.

With the core changes in place, we swept through additional cleanup: pruning approximately 93 lines of migration logic from `plugin-preflight.sh` that was no longer needed, merging `pump-state.sh` and `swarm-state.sh` into a unified `dispatch-state.sh`, simplifying `setup-project.sh` by removing AGENTS.md management, and inlining the standalone `install-beads-push-hook.sh` script. The version bumped from 2.18.1 to 2.19.0 with 536 unit tests passing.

## Decisions

- Organized consolidated rules by priority (hard enforcement first) rather than alphabetically or by feature area, so the agent reads critical rules before advisory ones
- Used a 60-second TTL cache for the beads check to balance responsiveness with performance -- cache invalidation happens naturally as the user progresses through plan intake
- Kept `mark-retrying` as a no-op for pump store in dispatch-state.sh rather than erroring, since the pump doesn't have retry semantics
- Removed all migration code rather than deprecating it -- the plugin marketplace handles versioning, so projects always get the current version

## Metrics

- 24 rule files deleted, 1 created (~210 lines)
- 3 scripts deleted (pump-state.sh, swarm-state.sh, install-beads-push-hook.sh), 1 created (dispatch-state.sh)
- ~93 lines of migration code removed from plugin-preflight.sh
- 15+ test files updated, 3 deleted, 1 created
- 536 unit tests passing
- Version: 2.18.1 -> 2.19.0

## Next Steps

- [ ] Commit and push the changes
- [ ] Verify the plugin loads correctly with `claude --plugin-dir ./plugins/yf`
- [ ] Manual test: create a plan file without beads, attempt Edit -> should be BLOCKED
- [ ] Manual test: create `.yoshiko-flow/plan-intake-skip` -> Edit should be allowed

---
*Generated by chronicler from 5 chronicle beads*
