# Diary Entry: Implicit Swarm Formula Triggering (v2.14.0)

**Date**: 2026-02-13 23:25
**Topics**: feature, swarm, planning
**Chronicle IDs**: marketplace-csp, marketplace-30d

## Summary

Implemented Plan 29: Implicit Swarm Formula Triggering, completing the arc from plan start to full delivery in a single session. This release (v2.14.0) adds five triggers that make swarm formulas fire automatically based on lifecycle events, task semantics, and runtime signals -- eliminating the need for manual `formula:` label assignment on every task.

The plan comprised 6 tasks (T1-T5 plus docs/tests), all closed successfully. The final commit (44d0713) touched 27 files (15 modified, 12 new) with 477 tests passing, including 34 new assertions across 4 test suites.

### What Was Built

**T1 -- Auto Formula Selection**: A new `swarm_select_formula` skill that assigns `formula:<name>` labels automatically during `plan_create_beads` Step 8b. Uses heuristic keyword matching: implement maps to feature-build, fix to bugfix, research to research-spike, review to code-review, test to build-test. Atomic tasks are skipped to avoid unnecessary overhead.

**T2 -- Nested Composition**: A `compose` field on formula steps that triggers sub-swarms via `swarm_run`. A depth parameter (max 2) prevents infinite recursion. Scoped state clearing in `swarm-state.sh` ensures nested swarms don't collide. The feature-build formula's implement step now composes build-test automatically.

**T3 -- Reactive Bugfix**: A new `swarm_react` skill that spawns the bugfix formula when a `REVIEW:BLOCK` verdict or test failure is detected. Integrated as Step 6b in `swarm_dispatch`. Uses a `mark-retrying` command in `swarm-state.sh` for state tracking. Design-level BLOCKs are excluded from triggering. Includes a `reactive_bugfix:false` config escape hatch.

**T4 -- Qualification Gate**: A new `swarm_qualify` skill that runs the code-review formula before plan completion. Step 9c in `plan_create_beads` creates a gate bead, and Step 3e in `plan_execute` checks qualification status. `plan-exec.sh` records the start SHA and returns a qualifying status. The gate is configurable as blocking, advisory, or disabled.

**T5 -- Planning Research Advisory**: A new `swarm-planning-research` rule that suggests the research-spike formula when heavy planning research is detected (3+ web searches). The research-spike formula is marked `planning_safe:true` to distinguish it from implementation formulas.

## Decisions

- Kept formula selection heuristic-based rather than ML/embedding approaches -- simpler, more predictable, and easier to debug when a wrong formula is assigned.
- Max compose depth set to 2 as a balance between flexibility (feature-build composing build-test) and safety (no runaway recursion).
- Reactive bugfix uses label-based dedup (`ys:bugfix-attempt`) rather than a state file -- this approach survives session restarts and context compaction.
- Qualification gate defaults to blocking mode -- conservative by default, relaxable per-project via config.

## Next Steps

- [ ] Push commit 44d0713 to remote
- [ ] Close root epic marketplace-atu
- [ ] End-to-end validation of auto-formula selection during a real plan_create_beads run
- [ ] Test nested composition with feature-build composing build-test
- [ ] Verify reactive bugfix triggers correctly on REVIEW:BLOCK

---
*Generated by chronicler from 2 chronicle beads*
