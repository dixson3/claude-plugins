# Diary Entry: Implicit Swarm Formula Triggering (v2.14.0)

**Date**: 2026-02-13 23:25
**Operator**: James Dixson
**Topics**: feature, swarm, planning
**Chronicle IDs**: marketplace-csp, marketplace-30d

## Summary

With the swarm infrastructure from v2.13.0 in place, the next friction point was obvious: every task needed a manual `formula:` label to trigger swarm dispatch. James wanted formulas to fire automatically based on lifecycle events, task semantics, and runtime signals, eliminating that manual step entirely. We implemented Plan 29 in a single session, taking it from plan start to full delivery as v2.14.0.

The plan comprised six tasks, and we worked through them methodically. We began with auto formula selection -- a new `swarm_select_formula` skill that assigns `formula:<name>` labels automatically during `plan_create_beads` Step 8b, using heuristic keyword matching to route tasks: "implement" maps to `feature-build`, "fix" to `bugfix`, "research" to `research-spike`, "review" to `code-review`, "test" to `build-test`. Atomic tasks are skipped to avoid unnecessary overhead.

Next came nested composition, adding a `compose` field on formula steps that triggers sub-swarms via `swarm_run`. A depth parameter capped at 2 prevents infinite recursion, and scoped state clearing in `swarm-state.sh` ensures nested swarms don't collide. The `feature-build` formula's implement step now composes `build-test` automatically. We then built reactive bugfix -- a `swarm_react` skill that spawns the bugfix formula when a `REVIEW:BLOCK` verdict or test failure is detected, integrated as Step 6b in `swarm_dispatch` with label-based dedup (`ys:bugfix-attempt`) that survives session restarts.

The qualification gate followed as a new `swarm_qualify` skill that runs the `code-review` formula before plan completion, with configurable blocking, advisory, or disabled modes. Finally, a planning research advisory rule suggests the `research-spike` formula when heavy planning research is detected (3+ web searches). The final commit touched 27 files with 477 tests passing, including 34 new assertions across 4 test suites.

## Decisions

- Kept formula selection heuristic-based rather than ML/embedding approaches -- simpler, more predictable, and easier to debug when a wrong formula is assigned.
- Max compose depth set to 2 as a balance between flexibility (feature-build composing build-test) and safety (no runaway recursion).
- Reactive bugfix uses label-based dedup (`ys:bugfix-attempt`) rather than a state file -- this approach survives session restarts and context compaction.
- Qualification gate defaults to blocking mode -- conservative by default, relaxable per-project via config.

## Next Steps

- [ ] Push commit 44d0713 to remote
- [ ] Close root epic marketplace-atu
- [ ] End-to-end validation of auto-formula selection during a real plan_create_beads run
- [ ] Test nested composition with feature-build composing build-test
- [ ] Verify reactive bugfix triggers correctly on REVIEW:BLOCK

---
*Generated by chronicler from 2 chronicle beads*
