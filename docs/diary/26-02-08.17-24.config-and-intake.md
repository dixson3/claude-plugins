# Diary Entry: Two-File Config Model & Plan Intake Enforcement

**Date**: 2026-02-08 17:24
**Operator**: James Dixson
**Topics**: feature, planning
**Chronicle IDs**: marketplace-0rt, marketplace-a36

## Summary

This session delivered two back-to-back improvements that built directly on Plan 14's preflight overhaul. The first need was team-readiness: James wanted teams to be able to share yf settings via git, which the single gitignored config file could not support. The second need emerged organically during the first -- Plan 15's own implementation exposed a gap in the plan intake lifecycle that Plan 16 then fixed.

## Plan 15: Two-File Config Model (v2.2.0)

We split `.claude/yf.json` into a committable shared config and a gitignored local overrides file. The shared `yf.json` carries the version, enabled flag, and config block with `artifact_dir` and `chronicler_enabled`. The local `yf.local.json` holds user-specific overrides and the preflight lock state. We built a sourceable shell library at `yf-config.sh` with five functions that replaced the four-line inline jq guard blocks scattered across all hooks, and used jq's recursive merge (`.[0] * .[1]`) so local values always win. The full migration chain was preserved from `plugin-lock.json` through `yf.json` v1 to the new v2 split format. The setup wizard gained a fourth question asking whether to commit config as shared or keep it local-only.

## Plan 16: Plan Intake Enforcement (v2.3.0)

Plan 15 itself was the proof that we needed Plan 16. During Plan 15's implementation, the plan was provided inline and the agent skipped the intake rule entirely -- no plan file was saved, no beads were created, and the lifecycle was bypassed. This was the same class of failure we had addressed in Plan 11, but the behavioral rule alone was not enough to prevent it. We responded with a three-part fix: a concrete `/yf:plan_intake` skill that encapsulates the five-step intake checklist as an invocable action, a beads safety net in `code-gate.sh` that warns on the first non-exempt Edit or Write if the active plan has no beads, and a simplified `yf-plan-intake.md` rule that now just says "invoke `/yf:plan_intake`" instead of listing manual steps. James chose warn-not-block for the safety net because missing beads is ambiguous -- the developer might be editing files unrelated to the plan.

## Technical Insights

- **jq `//` pitfall with booleans**: `jq '.field // true'` treats `false` as falsy. Use `if .field == null then true else .field end` instead.
- **pipefail + pipe chains**: Under `set -euo pipefail`, `bd list | jq` fails if both sides error, even with `|| echo "0"`. Wrap in `( set +e; ... ) || true` for fail-open semantics.
- **YAML heredoc gotcha**: Inline heredocs with JSON (`echo '[{"id":"..."}]'`) confuse YAML parsers. Use `printf` with escaped quotes instead.

## Test Coverage

- Plan 15: 15 new tests (8 config merge + 7 v1â†’v2 migration), all existing scenarios updated
- Plan 16: 12 new tests (6 intake hook + 3 skill existence + 3 renumbered)
- Total: 239 unit tests, all passing

---
*Generated by chronicler from 2 chronicle beads*
