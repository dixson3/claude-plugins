# Diary Entry: Two-File Config Model & Plan Intake Enforcement

**Date**: 2026-02-08 17:24
**Topics**: feature, planning
**Chronicle IDs**: marketplace-0rt, marketplace-a36

## Summary

Two back-to-back improvements to the yf plugin's reliability and team-readiness. Plan 15 split the single gitignored config file into a committable shared config + local overrides, enabling teams to share yf settings via git. Plan 16 then addressed a gap exposed during Plan 15's own implementation: the plan intake rule was purely behavioral and got skipped, so we added a concrete skill (`yf:plan_intake`) and a hook-level warning to make the right path easy and the wrong path visible.

## Plan 15: Two-File Config Model (v2.2.0)

Split `.claude/yf.json` into:
- **`.claude/yf.json`** — committable shared config (`{version: 2, enabled, config: {artifact_dir, chronicler_enabled}}`)
- **`.claude/yf.local.json`** — gitignored local overrides + preflight lock state

Key decisions:
- **jq recursive merge** (`.[0] * .[1]`) for merge semantics — local always wins
- **Sourceable shell library** (`yf-config.sh`) with 5 functions, replacing 4-line inline jq guards across all hooks
- **Full migration chain** preserved: plugin-lock.json (v0) → yf.json v1 → yf.json v2 + yf.local.json
- **Setup wizard Q4** asks whether to commit config (shared) or keep local-only

## Plan 16: Plan Intake Enforcement (v2.3.0)

Motivated by Plan 15 itself being implemented without the intake lifecycle (plan was provided inline, agent skipped the rule, no plan file saved, no beads created).

Three-part fix:
- **`yf:plan_intake` skill** — encapsulates the 5-step checklist as a concrete invocable action
- **`code-gate.sh` beads safety net** — warns on first non-exempt Edit/Write if active plan has no beads (warn not block, one-shot via marker)
- **Rule simplification** — `yf-plan-intake.md` now says "invoke `/yf:plan_intake`" instead of listing manual steps

Key decisions:
- Warn-not-block: missing beads is ambiguous (could be editing files unrelated to the plan)
- Subshell with `set +e`: avoids `pipefail` failures when `bd` errors in uninitialized directories
- One-shot marker (`.plan-intake-ok`): created regardless of outcome to prevent re-checking

## Technical Insights

- **jq `//` pitfall with booleans**: `jq '.field // true'` treats `false` as falsy. Use `if .field == null then true else .field end` instead.
- **pipefail + pipe chains**: Under `set -euo pipefail`, `bd list | jq` fails if both sides error, even with `|| echo "0"`. Wrap in `( set +e; ... ) || true` for fail-open semantics.
- **YAML heredoc gotcha**: Inline heredocs with JSON (`echo '[{"id":"..."}]'`) confuse YAML parsers. Use `printf` with escaped quotes instead.

## Test Coverage

- Plan 15: 15 new tests (8 config merge + 7 v1→v2 migration), all existing scenarios updated
- Plan 16: 12 new tests (6 intake hook + 3 skill existence + 3 renumbered)
- Total: 239 unit tests, all passing

---
*Generated by chronicler from 2 chronicle beads*
