# Diary Entry: Plan 23 Shipped -- Setup-Managed .gitignore and AGENTS.md Cleanup

**Date**: 2026-02-09 17:50
**Operator**: James Dixson
**Topics**: session-close, plan-23, setup, preflight
**Chronicle IDs**: marketplace-w4k

## Summary

We shipped Plan 23 as v2.10.0 in this session, addressing a gap that had been bothering us since the plugin started being installed in external projects: the yf plugin had no automated way to manage the project environment after setup. Projects needed manual `.gitignore` entries for yf artifacts, and leftover `AGENTS.md` content from beads-cli could accumulate without cleanup.

The solution centered on a new `setup-project.sh` script integrated into the preflight system, handling two concerns: sentinel-block management in `.gitignore` and bd-content cleanup in `AGENTS.md`. James chose the sentinel marker pattern (`# >>> yf-managed >>>` / `# <<< yf-managed <<<`) following established conventions from conda, poetry, and nvm, which makes block replacement idempotent and clearly identifies managed sections.

The most interesting technical challenge was an awk compatibility issue that surfaced during implementation. The `-v` flag in awk cannot handle multi-line strings, which broke the initial block-replacement approach. We rewrote it as a three-pass concatenation -- before block, new block, after block -- preserving bash 3.2 compatibility for macOS's default shell. This was the kind of portability concern that only surfaces when you commit to supporting the stock macOS toolchain.

We dogfooded the solution immediately by replacing the hand-crafted `.gitignore` entries in the marketplace repo itself with the sentinel block, making the plugin the single source of truth for its own ignored files. All 348 unit tests passed, including 10 new scenarios for `setup-project.sh`. A pre-existing preflight symlink test needed fixing as well -- it had broken due to new setup-project output matching "up to date." The working tree was clean and pushed to main.

## Decisions

- **Sentinel markers for idempotent block management** -- Used `# >>> yf-managed >>>` / `# <<< yf-managed <<<` delimiters, following the established pattern from conda, poetry, and nvm. This makes block replacement idempotent and clearly identifies managed sections.
- **Three-pass awk for block replacement** -- Avoided the awk `-v` multi-line string bug by splitting replacement into before/new/after concatenation. This maintains bash 3.2 compatibility required for macOS default shell.
- **Marketplace repo dogfooding** -- Replaced hand-crafted .gitignore entries in the marketplace repo itself with the sentinel block, making the plugin the single source of truth.
- **AGENTS.md cleanup strategy** -- Delete the entire file when it contains only bd-generated content; preserve non-bd sections in mixed files.

## Next Steps

- [ ] marketplace-8gq: PostToolUse ambient session log (P4)
- [ ] marketplace-zcv: Clean up stale chronicle dedup files (P4)
- [ ] marketplace-8hv: Add archive auto-drafts at pre-push (P4)

---
*Generated by chronicler from 1 chronicle bead*
