# Diary Entry: Plugin Manifest Schema Compliance

**Date**: 2026-02-08 11:45
**Operator**: James Dixson
**Topics**: bugfix, plugin-system
**Chronicle IDs**: marketplace-3b2

## Summary

We hit a wall when users tried to install marketplace plugins via Claude Code's `/plugin` command -- installation failed outright. The root cause turned out to be Claude Code's strict JSON schema validation on `plugin.json`. Our custom fields, `dependencies` and `artifacts`, which powered the preflight sync engine, were rejected as unrecognized keys. The preflight system had been working fine when plugins were loaded via `--plugin-dir`, but the `/plugin` installation path enforced a tighter schema than we had accounted for.

The fix was straightforward once we understood the boundary. We split the plugin configuration into two files: `plugin.json` retains only the fields that Claude Code's official schema recognizes, while a new `preflight.json` carries the custom preflight configuration -- dependencies, artifact declarations, and sync metadata. The preflight script was updated to read from `preflight.json` instead of `plugin.json` for its custom fields, while still pulling `version` from `plugin.json` since that field is part of the official schema.

Both the workflows and chronicler plugins received the split treatment, with new `preflight.json` files created alongside their stripped-down `plugin.json` manifests. We updated the preflight script in `scripts/plugin-preflight.sh`, adjusted two test scenarios to reflect the new paths, and updated CLAUDE.md documentation. The naming choice of `preflight.json` was deliberate, matching the existing naming pattern of `preflight-wrapper.sh` and `plugin-preflight.sh`. All 129 unit tests passed, and both plugins installed cleanly through the `/plugin` command afterward.

## Decisions

- **Separate file over removal**: Rather than abandoning the preflight system or trying to nest custom data under an allowed key, we created a companion `preflight.json` file. This is the cleanest separation of concerns â€” Claude Code owns `plugin.json`, our preflight system owns `preflight.json`.
- **Naming consistency**: Used `preflight.json` to match the existing naming pattern (preflight system, `preflight-wrapper.sh`, `plugin-preflight.sh`).
- **Version stays in plugin.json**: The preflight script still reads `version` from `plugin.json` (it's a valid schema field), only `dependencies` and `artifacts` moved to `preflight.json`.

## Files Changed

- `plugins/workflows/.claude-plugin/preflight.json` (new)
- `plugins/chronicler/.claude-plugin/preflight.json` (new)
- `plugins/workflows/.claude-plugin/plugin.json` (stripped custom fields)
- `plugins/chronicler/.claude-plugin/plugin.json` (stripped custom fields)
- `scripts/plugin-preflight.sh` (reads from preflight.json)
- `tests/scenarios/unit-chronicler-init.yaml` (updated paths)
- `tests/scenarios/unit-plan-intake.yaml` (updated paths)
- `CLAUDE.md` (documentation updated)

## Next Steps

- [x] All 129 unit tests passing
- [x] Both plugins install via `/plugin` command

---
*Generated by chronicler from 1 chronicle bead*
