# Diary Entry: Formula Refactor -- Replace Swarm Orchestration with Direct Dispatch

**Date**: 2026-02-25
**Operator**: James Dixson
**Topics**: refactor, formula-dispatch, swarm-removal, skill-rename, architecture-simplification
**Chronicle IDs**: task-0001-0b32o

## Summary

The swarm orchestration layer had grown into a three-deep call stack -- `swarm_run` invoked `swarm_dispatch`, which could trigger `swarm_react` -- and the indirection was costing more than it delivered. James directed a wholesale replacement: collapse the stack into a single `formula_execute` skill that handles qualification, selection, and dispatch in one pass. The refactor touched 48 files across the entire yf plugin surface, producing a net deletion of over 2,300 lines.

We started by creating the four new formula skills -- `plugins/yf/skills/formula_execute/SKILL.md`, `plugins/yf/skills/formula_qualify/SKILL.md`, `plugins/yf/skills/formula_select/SKILL.md`, and `plugins/yf/skills/formula_list/SKILL.md` -- each absorbing the responsibilities of their swarm-prefixed predecessors. The reactive bugfix logic that had lived in the standalone `swarm_react` skill was inlined directly into formula_execute's Step 3i, eliminating a round-trip that added latency without adding clarity. The three swarm agents (`yf_swarm_researcher`, `yf_swarm_reviewer`, `yf_swarm_tester`) became `yf_formula_researcher`, `yf_formula_reviewer`, and `yf_formula_tester` under `plugins/yf/agents/`.

On the infrastructure side, `plugins/yf/scripts/swarm-worktree.sh` was replaced by `plugins/yf/scripts/formula-worktree.sh`, and the store namespace inside `plugins/yf/scripts/dispatch-state.sh` was renamed from "swarm" to "formula". The specification layer followed suit: `docs/specifications/IG/swarm-execution.md` was removed and replaced by a new `docs/specifications/IG/formula-execution.md`. References across the PRD, EDD, coder IG, chronicler IG, plan lifecycle IG, and task system IG were all updated. The `compose` field in formula JSON files was dropped entirely at the operator's direction -- `formula_execute` simply ignores compose fields, and the two affected formulas (`code-implement.formula.json` and `feature-build.formula.json`) had compose references removed.

The test suite required the most careful attention. Six swarm-specific scenario files were deleted (`unit-swarm-comment-protocol.yaml`, `unit-swarm-lifecycle.yaml`, `unit-swarm-nesting.yaml`, `unit-swarm-qualify.yaml`, `unit-swarm-reactive.yaml`, `unit-swarm-formula-select.yaml`) and replaced by two new formula-aligned scenarios (`unit-formula-comment-protocol.yaml`, `unit-formula-lifecycle.yaml`). Several surviving scenarios had grep patterns and assertions updated to match the new heading formats. The full suite still passes at 877 assertions with zero failures, confirming behavioral parity.

The refactor was not tracked through the formal plan lifecycle. Once committed, zero references to "swarm" will remain anywhere under `plugins/yf/`.

## Decisions

- **Compose field dropped entirely**: Rather than translating compose semantics into the formula model, James directed its removal. Formula execution ignores compose fields, and existing formulas had their compose references cleaned out.
- **Reactive logic inlined**: The `swarm_react` skill's bugfix behavior was absorbed into formula_execute Step 3i rather than being preserved as a separate skill, reducing the dispatch surface from three skills to one.
- **Naming convention**: All swarm-prefixed identifiers (skills, agents, scripts, store namespaces) were renamed to formula-prefixed equivalents without abbreviation or further restructuring.

## Next Steps

- [ ] Commit the formula refactor (48 files changed, currently uncommitted on working tree)
- [ ] Bump plugin version (significant code change requires semver increment per Plan 0063's pre-push hook)
- [ ] Update CHANGELOG.md with the formula refactor entry

---
*Generated by chronicler from 1 chronicle entry*
