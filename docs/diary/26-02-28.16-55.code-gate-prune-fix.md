# Diary Entry: Fix code-gate.sh blocking after plan task pruning

**Date**: 2026-02-28 16:55
**Operator**: James Dixson
**Topics**: bugfix, plan-lifecycle, code-gate
**Chronicle IDs**: chron-0001-758vb, chron-0001-6g1wa, chron-0001-ost7i

## Summary

Fixed a race condition between plan completion and the code-gate safety net. When a plan completed, `plan-exec.sh` would prune all closed tasks and return "completed" — but the plan file's `Status:` line stayed "Active" because only the agent-driven `plan_engage` skill updated it. After the code-gate's 60-second cache expired, it would re-read the plan file, find "Active" status with zero epics (all pruned), and incorrectly block all edits.

The fix was surgical: write "Completed" into the plan file and `_index.md` as part of the `plan-exec.sh` completion flow, before pruning tasks. This makes the completed state durable and self-contained — the code-gate's existing `grep -q 'Status: Completed'` bypass handles the rest.

## Decisions

- Chose to fix in `plan-exec.sh` rather than `code-gate.sh` because the root cause is that pruning creates an inconsistent state — the plan file should reflect completion before tasks disappear
- Added both a "post-prune completed" test (Case 9) and an "Active-then-Completed transition" test (Case 10) to cover the exact scenario from the bug report

## Next Steps

- [ ] Close GitHub issue #42 after merge

---
*Generated by chronicler from 3 chronicle tasks*
