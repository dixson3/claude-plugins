# Diary Entry: Remove bd prime hooks from yf preflight

**Date**: 2026-02-20 17:10
**Operator**: James Dixson
**Topics**: preflight, hooks, token-optimization
**Chronicle IDs**: yf-2bn

## Summary

We discovered that `bd prime` was injecting roughly 3,000 characters of redundant static documentation into every session via its `SessionStart` and `PreCompact` hooks in `.claude/settings.local.json`. The beads-cli tool installs these hooks through `bd setup claude`, but yf already supersedes them with its own plugin-level hooks (`session-recall.sh` and `pre-compact.sh`). Having both present meant wasted prompt cache tokens on duplicate content every session.

We updated two scripts to handle proactive removal. In `plugin-preflight.sh`, we added detection and removal of `bd prime` hooks before the fast-path check, forcing a full resync when hooks are cleaned. In `beads-setup.sh`, we added Step 5b after git hook uninstall to catch hooks that get auto-installed by `bd init` during Phase 1 initialization. Both scripts use grep-based detection on `settings.local.json` and delegate removal to `bd setup claude --remove --project` for idempotent cleanup. The fix was small and self-contained, so we dismissed the gate and implemented directly.

## Decisions

- Used `bd setup claude --remove --project` rather than manual jq surgery — leverages bd's own removal command, future-proofs against format changes
- Placed cleanup before fast-path in preflight — hooks need cleaning regardless of whether rules are up to date
- Gate was dismissed (Plan 48 had no beads) — implementation was small enough to proceed directly

## Next Steps

- [x] Implementation complete and verified
- [x] Idempotency confirmed (second run shows "up to date")

---
*Generated by chronicler from 1 chronicle bead*
