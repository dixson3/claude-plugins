# Diary Entry: Remove bd prime hooks from yf preflight

**Date**: 2026-02-20 17:10
**Topics**: preflight, hooks, token-optimization
**Chronicle IDs**: yf-2bn

## Summary

Implemented proactive removal of `bd prime` Claude Code hooks from `.claude/settings.local.json`. The beads-cli tool installs its own `SessionStart` and `PreCompact` hooks via `bd setup claude`, but yf already supersedes these with plugin-level hooks (`session-recall.sh`, `pre-compact.sh`). When both are present, `bd prime` injects ~3k chars of redundant static documentation every session, wasting prompt cache tokens.

Two scripts were updated:
- `plugin-preflight.sh` — detects and removes `bd prime` hooks before the fast-path check, forcing a full resync when hooks are cleaned
- `beads-setup.sh` — adds Step 5b after git hook uninstall to catch hooks auto-installed by `bd init` during Phase 1 initialization

Both use grep-based detection on `settings.local.json` and delegate removal to `bd setup claude --remove --project` for idempotent cleanup.

## Decisions

- Used `bd setup claude --remove --project` rather than manual jq surgery — leverages bd's own removal command, future-proofs against format changes
- Placed cleanup before fast-path in preflight — hooks need cleaning regardless of whether rules are up to date
- Gate was dismissed (Plan 48 had no beads) — implementation was small enough to proceed directly

## Next Steps

- [x] Implementation complete and verified
- [x] Idempotency confirmed (second run shows "up to date")

---
*Generated by chronicler from 1 chronicle bead*
