# Diary Entry: Automating the Cleanup Nobody Wanted to Do by Hand -- Plan 0060

**Date**: 2026-02-24
**Operator**: James Dixson
**Topics**: session-cleanup, plan-lifecycle, automation, session-prune, specifications
**Chronicle IDs**: chron-0001-c6jxf, chron-0001-y9tu0

## Summary

The v3.0.0 migration had been a four-plan sprint -- Plans 0056 through 0059 rewrote the task engine, aligned specifications, caught stale references, and audited the test suite. Those plans landed ten commits touching the marketplace catalog, plugin manifest, preflight declarations, and four plan documents in rapid succession. The draft chronicle `chron-0001-c6jxf` captured this wave of activity as a single auto-detected signal: something significant had changed across the entire structural skeleton of the plugin.

But the migration left behind debris. After Plan 0059 closed its tasks and the session wound down, James noticed the `.yoshiko-flow/` directory was littered with artifacts nobody had cleaned up: six closed chronicle JSON files that had already been processed into diary entries, two completed plan epics with all children long since closed, and orphaned gates -- `ys:chronicle-gate` and `ys:qualification-gate` tasks left open because the gate-closing logic only fires when work tasks close, not when a plan itself completes. Cleaning this by hand during the Plan 0059 session made the problem visible; Plan 0060 set out to make it never happen again.

The implementation centered on a new `completed-plans` subcommand in `plugins/yf/scripts/session-prune.sh`. The `do_completed_plans()` function works in three passes: first it finds orphaned gates whose sibling work tasks are all closed and shuts them; then it identifies plan epics where every child task has completed and closes those; finally it walks `.yoshiko-flow/chronicler/*.json` and removes any file where the status reads `"closed"`. The subcommand was wired into the existing `all` sequence after `drafts`, so a bare `session-prune.sh all` picks it up automatically.

Two integration points ensured the cleanup runs at the right moments. Step 8b in `plugins/yf/skills/session_land/SKILL.md` invokes `session-prune.sh completed-plans` after the standard session prune, catching plan artifacts that the ephemeral/tasks/drafts passes do not cover. Step 0.5 in `plugins/yf/skills/plan_intake/SKILL.md` runs the same cleanup before a new plan lifecycle begins, preventing stale state from accumulating across plans within a single session. Both are fail-open -- cleanup failures do not block the operation they are attached to.

The specifications came first, as they should. PRD gained REQ-026 for completed-plan cleanup. The implementation guide added UC-027 (session-land integration) and UC-028 (plan-intake integration), and UC-002 was updated to reflect the new subcommand in the session-prune contract. The test coverage matrix picked up UC-042 for the new capability. During code review, a critical subshell variable scope bug was caught -- a piped `while read` loop was silently losing state because the loop body ran in a subshell. The fix moved the logic to avoid the pipe, and all 860 tests passed clean.

This was a quiet plan -- no new capabilities, no architectural shifts -- but it closed a gap that had been accumulating since the first plan epic was created. Every completed plan now cleans up after itself, and the next session starts with a clear workspace instead of a pile of artifacts from the last one.

## Decisions

- **Fail-open cleanup at both integration points**: Cleanup failures must never block session landing or plan intake. The `2>/dev/null || true` pattern ensures that a corrupt chronicle file or unexpected task state degrades gracefully rather than halting the workflow.
- **Specs before implementation**: Even for a small plan, the specification-first approach caught the UC-002 update that would have been missed if we had gone straight to code.

## Next Steps

- [ ] Verify `session-prune.sh completed-plans --dry-run` output in a session with mixed open/closed state
- [ ] Create `unit-session-prune-completed.yaml` test scenario for UC-042

---
*Generated by chronicler from 2 chronicle entries*
