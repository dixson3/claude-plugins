# Diary Entry: Preflight System Overhaul and Setup Wizard

**Date**: 2026-02-08 16:33
**Operator**: James Dixson
**Topics**: preflight, configuration, setup-wizard, hooks, testing
**Chronicle IDs**: marketplace-vh4

## Summary

Plan 14 was driven by a straightforward goal: make the yf plugin self-contained and configuration-aware so that projects can enable or disable features without modifying plugin source. The session began with the preflight script itself, which lived at the marketplace root in `scripts/plugin-preflight.sh`. We relocated it into the plugin directory at `plugins/yf/scripts/plugin-preflight.sh` and rewired it to resolve its own plugin root via `BASH_SOURCE`, eliminating any dependency on the marketplace directory structure. This was essential for portability -- the plugin needs to work identically whether loaded from the source tree or from Claude Code's plugin cache. The old 404-line marketplace-level script was deleted and replaced with a 389-line self-contained version inside the plugin.

James wanted a guided setup experience rather than expecting users to hand-edit JSON, so we built `/yf:setup` as an interactive configuration wizard. It reads existing `.claude/yf.json` config if present, asks three questions via `AskUserQuestion` (enable YF, artifact directory, chronicler enabled), merges the answers into `yf.json` without wiping the `preflight` section, and runs the preflight script to reconcile artifacts. When no `yf.json` exists and there is no old lock file to migrate, the preflight script emits a `YF_SETUP_NEEDED` signal to prompt the user toward the wizard.

We then addressed the hooks. All four behavioral hooks -- `code-gate.sh`, `exit-plan-gate.sh`, `plan-exec-guard.sh`, and `pre-push-diary.sh` -- received an enabled guard block at the top that reads `enabled` from `.claude/yf.json` and exits immediately when disabled, ensuring zero overhead for opt-out projects. The `pre-push-diary.sh` hook gained a second guard for `config.chronicler_enabled`, allowing projects to keep the plan lifecycle active while disabling chronicle behavior independently.

The preflight system itself became config-aware in a deeper way. When `enabled` is `false`, all rules are removed from the project. When `chronicler_enabled` is `false`, the two chronicle-specific rules (`yf-watch-for-chronicle-worthiness.md` and `yf-plan-transition-chronicle.md`) are skipped during installation. This conditional rule installation was a key design goal -- projects can adopt the plan lifecycle without the chronicle overhead.

A notable bug surfaced during development: jq's `//` (alternative) operator treats JSON `false` as falsy, so `jq '.enabled // true'` returns `true` even when `enabled` is explicitly `false`. We fixed this with explicit null-check patterns (`if .enabled == null then true else .enabled end`) and applied the pattern consistently across the preflight script and all hook guard blocks.

We closed the session with three new test scenarios -- `unit-preflight-chronicler.yaml`, `unit-preflight-disabled.yaml`, and `unit-preflight-setup.yaml` -- and updated several existing scenarios for the new paths and config-aware behavior. The plugin was bumped from v2.0.0 to v2.1.0.

## Decisions

- **Self-contained preflight over marketplace-level script**: Moved the preflight script into the plugin directory rather than keeping it at the marketplace root. The plugin should not depend on its hosting context — it needs to work from any location Claude Code might cache it.
- **Enabled guard pattern over config file check**: Each hook reads `yf.json` directly rather than relying on a sentinel file or environment variable. This keeps the hooks stateless and idempotent — they derive behavior from the single source of truth.
- **Null-check over jq `//` for booleans**: Used `if .field == null then default else .field end` instead of `.field // default`. The `//` operator conflates `null`, `false`, and missing fields, which is incorrect for boolean configuration.
- **Separate chronicler guard in pre-push-diary**: Added a second guard block specific to `chronicler_enabled` rather than bundling it into the general enabled check. This allows the hook to respect both toggles independently — a project can be enabled but have chronicler off.
- **Interactive wizard over config file editing**: Provided `/yf:setup` as a guided experience rather than expecting users to hand-edit `yf.json`. The wizard handles schema correctness and runs preflight automatically after configuration changes.

## Next Steps

- [ ] Validate the `YF_SETUP_NEEDED` signal flow end-to-end in a fresh project that has never run the setup wizard
- [ ] Consider adding a `yf:status` skill that reports the current configuration and artifact state without prompting for changes
- [ ] Monitor whether the fast-path optimization in preflight (version+checksum+count skip) correctly handles the transition from v2.0.0 lock files to v2.1.0

---
*Generated by chronicler from 1 chronicle bead*
