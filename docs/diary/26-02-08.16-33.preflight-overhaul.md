# Diary Entry: Preflight System Overhaul and Setup Wizard

**Date**: 2026-02-08 16:33
**Topics**: preflight, configuration, setup-wizard, hooks, testing
**Chronicle IDs**: marketplace-vh4

## Summary

Completed Plan 14, which overhauled the preflight system and introduced a per-project setup wizard. The primary motivation was making the yf plugin self-contained and configuration-aware, so that projects can enable/disable features without modifying plugin source.

The preflight script (`plugin-preflight.sh`) was moved from the marketplace root (`scripts/`) into the plugin itself (`plugins/yf/scripts/`). It now resolves its own plugin root via `BASH_SOURCE`, eliminating any dependency on the marketplace directory structure. This makes the plugin portable — it works identically whether loaded from the source tree or the Claude Code plugin cache. The old marketplace-level `scripts/plugin-preflight.sh` (404 lines) was deleted and replaced with the new self-contained version (389 lines) inside the plugin.

A new `/yf:setup` skill was added as an interactive configuration wizard. It reads existing `.claude/yf.json` config (if present), asks three questions via `AskUserQuestion` (enable YF, artifact directory, chronicler enabled), merges the answers into `yf.json` without wiping the `preflight` section, and runs the preflight script to reconcile artifacts. The wizard is idempotent — it works for both first-run and reconfiguration. When no `yf.json` exists and there is no old lock file to migrate, the preflight script now outputs a `YF_SETUP_NEEDED` signal to prompt the user to run the wizard.

All four behavioral hooks (`code-gate.sh`, `exit-plan-gate.sh`, `plan-exec-guard.sh`, `pre-push-diary.sh`) received an enabled guard block at the top. The guard reads `enabled` from `.claude/yf.json` and exits 0 immediately when disabled, ensuring zero overhead for projects that opt out. The `pre-push-diary.sh` hook received an additional chronicler guard that checks `config.chronicler_enabled`, allowing projects to keep the plan lifecycle active while disabling chronicle-related behavior.

The preflight system itself became config-aware. When `enabled` is `false`, all rules are removed from the project. When `chronicler_enabled` is `false`, the two chronicle-specific rules (`yf-watch-for-chronicle-worthiness.md` and `yf-plan-transition-chronicle.md`) are skipped during installation. This conditional rule installation was a key design goal — projects can use the plan lifecycle without the chronicle overhead.

A notable bug was discovered and fixed during development: jq's `//` (alternative) operator treats JSON `false` as falsy, causing `jq '.enabled // true'` to return `true` even when `enabled` is explicitly `false`. The fix was to use explicit null-check patterns: `if .enabled == null then true else .enabled end`. This pattern was applied consistently across the preflight script and all hook guard blocks.

Three new test scenarios were added: `unit-preflight-chronicler.yaml` (validates conditional chronicle rule installation), `unit-preflight-disabled.yaml` (validates rule removal when disabled), and `unit-preflight-setup.yaml` (validates the setup signal and fresh config creation). Several existing test scenarios were updated to reflect the new self-contained script paths and config-aware behavior. The plugin version was bumped from v2.0.0 to v2.1.0.

## Decisions

- **Self-contained preflight over marketplace-level script**: Moved the preflight script into the plugin directory rather than keeping it at the marketplace root. The plugin should not depend on its hosting context — it needs to work from any location Claude Code might cache it.
- **Enabled guard pattern over config file check**: Each hook reads `yf.json` directly rather than relying on a sentinel file or environment variable. This keeps the hooks stateless and idempotent — they derive behavior from the single source of truth.
- **Null-check over jq `//` for booleans**: Used `if .field == null then default else .field end` instead of `.field // default`. The `//` operator conflates `null`, `false`, and missing fields, which is incorrect for boolean configuration.
- **Separate chronicler guard in pre-push-diary**: Added a second guard block specific to `chronicler_enabled` rather than bundling it into the general enabled check. This allows the hook to respect both toggles independently — a project can be enabled but have chronicler off.
- **Interactive wizard over config file editing**: Provided `/yf:setup` as a guided experience rather than expecting users to hand-edit `yf.json`. The wizard handles schema correctness and runs preflight automatically after configuration changes.

## Next Steps

- [ ] Validate the `YF_SETUP_NEEDED` signal flow end-to-end in a fresh project that has never run the setup wizard
- [ ] Consider adding a `yf:status` skill that reports the current configuration and artifact state without prompting for changes
- [ ] Monitor whether the fast-path optimization in preflight (version+checksum+count skip) correctly handles the transition from v2.0.0 lock files to v2.1.0

---
*Generated by chronicler from 1 chronicle bead*
