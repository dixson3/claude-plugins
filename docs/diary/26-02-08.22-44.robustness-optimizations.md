# Diary Entry: Robustness Fixes and Script Optimizations (v2.7.1)

**Date**: 2026-02-08 22:44
**Operator**: James Dixson
**Topics**: refactoring, robustness
**Chronicle IDs**: marketplace-i1a

## Summary

We had accumulated enough hooks, scripts, and rules at this point that a comprehensive robustness review felt overdue. The session began with a systematic walkthrough of every trigger path for chronicle and archivist beads, covering all five hooks, six scripts, and eleven rule files in the yf plugin. Rather than waiting for failures in production, we mapped each path end-to-end and assessed failure scenarios by likelihood and impact.

The review surfaced three concrete issues worth fixing immediately. The most consequential was a plan detection bug: both `chronicle-check.sh` and `archive-suggest.sh` were grabbing the first open epic as "the plan," which would silently attach the wrong plan label whenever multiple epics were open. We fixed this by filtering explicitly for the `exec:executing` label. The second issue was silent error swallowing in `pre-push-diary.sh`, where `2>/dev/null` was discarding all stderr from chronicle-check -- changed to `2>&1` so errors surface in push output without blocking. The third was a fragile arithmetic expression in `archive-suggest.sh` that would fail on empty input, resolved with a `set +e` subshell pattern.

With the robustness fixes in place, we turned to DRY optimizations across the codebase. Seven refactoring changes touched eight files, the most significant being the consolidation of three copy-paste flag-check functions in `yf-config.sh` into a single parameterized `_yf_check_flag` helper (78 to 62 lines), and the extraction of side effects from `plan-exec.sh`'s `status` subcommand into a dedicated `close_chronicle_gates` mutation. James decided to ship both the robustness fixes and all seven optimizations together since none introduced behavioral changes and all 275 tests passed cleanly.

## Robustness Fixes

- **Plan detection was picking the wrong epic**: `chronicle-check.sh` and `archive-suggest.sh` grabbed the first open epic as "the plan." With multiple epics open, the wrong plan label would be applied. Fixed by filtering for the `exec:executing` label explicitly.
- **Silent error swallowing**: `pre-push-diary.sh` discarded all stderr from `chronicle-check.sh` with `2>/dev/null`. Changed to `2>&1` so errors are visible in push output while remaining non-blocking.
- **Fragile arithmetic**: `archive-suggest.sh` used `$(( $(...) ))` which fails on empty input. Replaced with a `set +e` subshell pattern.

## Optimizations

Seven DRY/simplification changes across the codebase:

1. **yf-config.sh** (78 -> 62 lines): Three copy-paste flag-check functions consolidated into `_yf_check_flag` parameterized helper
2. **pre-push-diary.sh** (71 -> 60 lines): Duplicate chronicle/archive warning blocks replaced with `warn_open_beads` function
3. **plugin-preflight.sh**: `is_chronicle_rule`/`is_archivist_rule` merged into `is_feature_rule` with thin wrappers
4. **plan-exec.sh**: Dead `COUNT` variable removed; chronicle gate auto-close extracted from `status` (a query) into `close_chronicle_gates` (a mutation) -- no more side effects in read-only commands
5. **pump-state.sh**: Write-only `done` dict removed -- `mark-done` now simply deletes from `dispatched`
6. **code-gate.sh**: Beads safety-net skips entirely when `docs/plans/` is empty, avoiding `bd` queries on every Edit/Write

## Decisions

- **Implemented Options A + D immediately** (plan detection fix + error surfacing): low effort, address real issues, no added complexity
- **Deferred Option B** (archive auto-drafts at pre-push): would add a parallel system mirroring chronicle-check for archives; may not be needed if rule-based suggestions work well enough
- **All 7 optimizations were safe to ship**: no behavioral changes, all 275 tests pass

## Failure Scenarios Assessed

Mapped every trigger path for chronicle and archivist beads. Key findings:
- Chronicle/archive asymmetry at pre-push (chronicles auto-draft, archives only warn) -- intentional, may revisit
- Dedup key drift could create duplicate drafts if reason strings change slightly -- low impact
- Auto-chain bypass when `engage_plan` precedes ExitPlanMode loses planning context -- medium concern, known limitation

---
*Generated by chronicler from 1 chronicle bead*
