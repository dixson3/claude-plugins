# Plan: Remove beads-cli dependency — replace with file-based task system

## Context

The yf plugin depends on beads-cli (`bd`) as its persistent work store for plan tasks, chronicles, archives, issues, and swarm molecules. This external dependency adds installation friction (requires `brew install dixson3/tap/beads-cli`), maintains a separate dolt database, and gates all yf functionality behind a CLI availability check. The file-based replacement stores all work items as JSON files under `.yoshiko-flow/` subdirectories, keeping the same ID conventions and operational semantics while eliminating the external dependency entirely.

## Design Decisions

- **File format**: JSON (shell scripts already depend on `jq`; dispatch-state files are JSON)
- **Git tracking**: All task directories are gitignored (ephemeral runtime state; permanent records stay in `docs/plans/` and `docs/diary/`)
- **Molecules**: Separate `.yoshiko-flow/molecules/` directory
- **Agent interface**: Wrapper script `yf-task-cli.sh` (agents call `bash $CLAUDE_PLUGIN_ROOT/scripts/yf-task-cli.sh <cmd> <args>`)
- **Version bump**: Plugin version 3.0.0 (breaking change)

## Directory Layout

```
.yoshiko-flow/
  config.json                          # Committed (unchanged)
  config.local.json                    # Gitignored (unchanged)
  tasks/                               # Plan epics + tasks (gitignored)
    task-0001-abc12/                   # Epic directory
      _epic.json                       # Epic metadata
      task-0001-abc12.01.json          # Child task
      task-0001-abc12.02.json          # Child task
  chronicler/                          # Chronicle entries (gitignored)
    chron-0001-def56.json
  archivist/                           # Archive entries (gitignored)
    arch-0001-jkl90.json
  todos/                               # Standalone TODOs (gitignored)
    todo-0001-mno12.json
  molecules/                           # Swarm wisps (gitignored)
    mol-0001-xyz98.json
  issues/                              # Staged project issues (gitignored)
    issue-0001-pqr34.json
  # Existing ephemeral state files unchanged
  task-pump.json
  swarm-state.json
  plan-gate
```

**ID convention**: Epics are `task-NNNN-xxxxx`; child tasks are `task-NNNN-xxxxx.NN` (epic prefix + dot + zero-padded task index). Chronicles: `chron-NNNN-xxxxx`. Archives: `arch-NNNN-xxxxx`. Molecules: `mol-NNNN-xxxxx`. Issues: `issue-NNNN-xxxxx`. TODOs: `todo-NNNN-xxxxx`.

## Task File Schema

```json
{
  "id": "task-0001-abc12.01",
  "type": "task",
  "title": "Implement API endpoint",
  "status": "open",
  "priority": 2,
  "description": "...",
  "design": "...",
  "acceptance": "...",
  "notes": "...",
  "labels": ["plan:0054-gs93u", "agent:yf_code_writer"],
  "parent": "task-0001-abc12",
  "dependencies": ["task-0001-abc12.01"],
  "deferred": false,
  "comments": [
    { "timestamp": "2026-02-23T14:30:00Z", "protocol": "FINDINGS", "content": "..." }
  ],
  "created": "2026-02-23T12:00:00Z",
  "updated": "2026-02-23T14:30:00Z",
  "closed_at": null,
  "close_reason": null
}
```

Gates add: `"resolved": false, "resolve_reason": null`. Molecules have their own schema with `steps[]` array, `formula`, `feature`, `squashed_at`, `squash_summary`.

## Shell Library API

**`yf-tasks.sh`** — sourceable library with `yft_*` functions. **`yf-task-cli.sh`** — thin CLI wrapper dispatching to `yf-tasks.sh`.

Core functions (matching `bd` interface for minimal script changes):
- `yft_create --type=<type> --title=<t> [--description=<d>] [--parent=<id>] [-l <labels>] [--silent]` — returns new ID
- `yft_show <id> [--json] [--comments]` — read entity
- `yft_update <id> [--status=<s>] [--defer=<bool>] [-l <labels>]` — modify fields
- `yft_close <id> [--reason=<r>]` — set status=closed
- `yft_delete <id>` — remove file
- `yft_list [--type=<t>] [--status=<s>] [-l <labels>] [--ready] [--limit=<n>] [--json]` — glob + jq filter
- `yft_count [--type=<t>] [--status=<s>] [-l <labels>]` — count matches
- `yft_label_list <id> [--json]` / `yft_label_add <id> <label>` / `yft_label_remove <id> <label>`
- `yft_dep_add <dependent> <dependency>` — append to dependencies array
- `yft_comment <id> "<protocol>: <content>"` — append to comments array
- `yft_gate_list [--json]` / `yft_gate_resolve <id> --reason=<r>`
- `yft_mol_wisp <formula> --var key=val` / `yft_mol_show <id>` / `yft_mol_step_close <mol> <step>` / `yft_mol_squash <id> --summary=<s>`
- `yft_cleanup [--older-than <days>] [--ephemeral]`
- `_yft_find_file <id>` — resolve ID prefix to filesystem path

## Implementation Parts

### Part 1 — Foundation: Shell library + CLI wrapper

**Files to create:**
- `plugins/yf/scripts/yf-tasks.sh` — core library with all `yft_*` functions
- `plugins/yf/scripts/yf-task-cli.sh` — CLI wrapper (`bash yf-task-cli.sh <cmd> <args>`)

**Files to modify:**
- `plugins/yf/scripts/yf-id.sh` — extend `yf_generate_id` to support new prefixes (`task`, `chron`, `arch`, `mol`, `issue`, `todo`) with scope pointing to `.yoshiko-flow/` subdirectories

### Part 2 — Activation gate + preflight

**Files to modify:**
- `plugins/yf/scripts/yf-activation-check.sh` — remove `bd` availability condition (3-part gate becomes 2-part)
- `plugins/yf/scripts/yf-config.sh` — remove `yf_bd_available()`, update `yf_is_enabled()`
- `plugins/yf/.claude-plugin/preflight.json` — remove beads-setup, add directory entries for new subdirs
- `plugins/yf/.claude-plugin/plugin.json` — remove `bd`-matching hook entries, bump to 3.0.0

**Files to delete:**
- `plugins/yf/scripts/beads-setup.sh`
- `plugins/yf/hooks/bd-safety-net.sh`
- `plugins/yf/skills/beads_setup/` (entire directory)

### Part 3 — Core scripts migration

**Files to modify (replace all `bd` calls with `yft_*`):**
- `plugins/yf/scripts/plan-exec.sh` — heaviest script (~20 distinct `bd` calls)
- `plugins/yf/scripts/chronicle-check.sh`
- `plugins/yf/scripts/chronicle-staleness.sh`
- `plugins/yf/scripts/chronicle-validate.sh`
- `plugins/yf/scripts/plan-chronicle.sh`
- `plugins/yf/scripts/archive-suggest.sh`
- `plugins/yf/scripts/session-recall.sh` — also move `.beads/` markers to `.yoshiko-flow/`
- `plugins/yf/scripts/session-prune.sh`
- `plugins/yf/scripts/plan-prune.sh` — epic completion = `rm -rf .yoshiko-flow/tasks/<epic-dir>/`
- `plugins/yf/scripts/swarm-worktree.sh` — replace beads-setup with directory creation + symlinks

### Part 4 — Hooks migration

**Files to modify:**
- `plugins/yf/hooks/code-gate.sh` — replace `bd list` with `yft_list`
- `plugins/yf/hooks/pre-push-land.sh` — replace `bd list` with `yft_list`
- `plugins/yf/hooks/pre-push-diary.sh` — replace `bd list` with `yft_list`
- `plugins/yf/hooks/session-end.sh` — replace `bd list`, move markers from `.beads/` to `.yoshiko-flow/`
- `plugins/yf/hooks/pre-compact.sh` — remove `bd` guard
- `plugins/yf/hooks/exit-plan-gate.sh` — verify/update any `bd` references
- `plugins/yf/hooks/worktree-create.sh` — remove beads-setup call
- `plugins/yf/hooks/plan-exec-guard.sh` — embed guard into `yft_update`/`yft_close` or update matchers

**Files to delete:**
- `plugins/yf/hooks/bd-safety-net.sh` (if not already deleted in Part 2)

### Part 5 — Skills rewrite

**Rename:** `plan_create_beads/` → `plan_create_tasks/`

**All skills rewritten to use `bash $CLAUDE_PLUGIN_ROOT/scripts/yf-task-cli.sh <cmd>` instead of `bd <cmd>`:**
- Plan lifecycle: `plan_create_tasks`, `plan_execute`, `plan_pump`, `plan_intake`, `plan_breakdown`, `plan_engage`, `plan_select_agent`, `plan_dismiss_gate`
- Swarm: `swarm_run`, `swarm_dispatch`, `swarm_status`, `swarm_qualify`, `swarm_react`, `swarm_select_formula`, `swarm_list_formulas`
- Chronicle: `chronicle_capture`, `chronicle_diary`, `chronicle_recall`, `chronicle_disable`
- Archive: `archive_capture`, `archive_process`, `archive_disable`, `archive_suggest`
- Issue: `issue_capture`, `issue_process`, `issue_disable`, `issue_plan`
- Engineer: `engineer_reconcile`, `engineer_update`, `engineer_suggest_updates`
- Session: `session_land`
- Delete: `beads_setup` skill
- Update: `plugin_setup` — remove beads-cli installation step

### Part 6 — Agents rewrite

All 13 agent `.md` files updated: replace `bd <cmd>` with `bash "$YFT" <cmd>` pattern where `YFT="${CLAUDE_PLUGIN_ROOT}/scripts/yf-task-cli.sh"`:
- `yf_code_writer.md`, `yf_code_reviewer.md`, `yf_code_tester.md`, `yf_code_researcher.md`
- `yf_swarm_researcher.md`, `yf_swarm_reviewer.md`, `yf_swarm_tester.md`
- `yf_chronicle_diary.md`, `yf_chronicle_recall.md`
- `yf_archive_process.md`, `yf_issue_triage.md`
- `yf_engineer_synthesizer.md`, `yf_regression_check.md`

### Part 7 — Rules + documentation

**Files to modify:**
- `plugins/yf/rules/yf-rules.md` — remove all `bd` references; "beads" → "tasks"; drop rule 1.0 bd condition; update rule 1.1 to reference `yft_list`; update rule 1.2 to reference `plan_create_tasks`
- `plugins/yf/README.md` — rewrite beads-related sections for file-based architecture
- `plugins/yf/DEVELOPERS.md` — update capability table, remove beads references
- Root `CLAUDE.md` — update plugin description (version 3.0.0, remove "doctor-driven beads repair")
- `CHANGELOG.md` — document v3.0.0 breaking change

### Part 8 — Tests

**Delete obsolete scenarios:** `unit-bd-safety-net.yaml`, `unit-beads-setup.yaml`, `unit-beads-git.yaml`, `integ-beads-setup.yaml`

**Rewrite scenarios** that mock or call `bd`: `unit-activation.yaml`, `unit-code-gate.yaml`, `unit-code-gate-chronicle.yaml`, `unit-code-gate-intake.yaml`, `unit-plan-exec-gate.yaml`, `unit-plan-exec-chronicle.yaml`, `unit-plan-state-machine.yaml`, `unit-pre-push-land.yaml`, `unit-session-end.yaml`, `unit-session-recall.yaml`, `unit-session-prune.yaml`, `unit-plan-prune.yaml`, `unit-swarm-lifecycle.yaml`, `unit-swarm-comment-protocol.yaml`, `unit-swarm-reactive.yaml`, `unit-pump-dispatch.yaml`, `unit-formula-dispatch.yaml`

**New scenarios:** `unit-yf-tasks.yaml` (library functions), `unit-yf-task-cli.yaml` (CLI wrapper), `unit-task-ready.yaml` (dependency resolution), `unit-molecule-lifecycle.yaml` (wisp/squash)

**Test harness update:** Replace `bd_list_contains` and `bd_count` assertions with `file_exists`, `json_field`, and custom assertions on `.yoshiko-flow/` task files.

## Verification

1. **Unit tests**: `bash tests/run-tests.sh --unit-only` — all existing + new scenarios pass
2. **Activation gate**: `bash plugins/yf/scripts/yf-activation-check.sh` returns `{"active":true}` without `bd` installed
3. **Plan lifecycle**: Create a plan, run `plan_create_tasks`, execute via `plan-exec.sh start/status/next`, verify task files appear and update in `.yoshiko-flow/tasks/`
4. **Swarm dispatch**: Run `yf-task-cli.sh mol wisp feature-build.formula.json --var feature="test"`, verify molecule file in `.yoshiko-flow/molecules/`
5. **Chronicle/archive/issue**: Run capture skills, verify files appear in respective directories
6. **Epic cleanup**: When all tasks close and `plan-exec.sh status` returns "completed", verify the epic directory is removed
7. **Grep audit**: `grep -r 'command -v bd\|bd create\|bd list\|bd show\|bd update\|bd close\|bd comment\|bd label\|bd dep\|bd gate\|bd mol\|bd init\|bd config\|bd doctor\|bd vc\|bd delete\|bd count\|bd ready\|bd admin\|beads-cli\|beads-setup' plugins/yf/` returns zero results
