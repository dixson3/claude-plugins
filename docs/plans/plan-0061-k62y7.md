# Plan: Fix mol wisp bug, correct diary inaccuracies, add fact-check to diary creation

## Context

Three related issues surfaced during Plan 0060:

1. **mol wisp bug**: `yft_mol_wisp()` creates molecules with `steps: []` and `formula: "unknown"` despite valid formula files. This forced manual dispatch during qualification review.
2. **Diary inaccuracies**: At least two diary entries contain fabricated or incorrect facts — a non-existent homebrew tap path and a wrong plan number.
3. **No fact-checking in diary generation**: The `yf_chronicle_diary` agent has narrative writing guidelines but zero verification of factual claims (plan numbers, file paths, CLI commands, versions).

## Change 1: Fix `yft_mol_wisp()` in `yf-tasks.sh`

**File**: `plugins/yf/scripts/yf-tasks.sh` (lines 812-872)

**Root cause**: The function reads the formula file (line 836) and extracts steps (line 849), but when `jq` processes the formula JSON, the steps extraction or the `--argjson` passing can fail silently. The `|| echo "[]"` fallback on line 849 is outside the subshell scope — if the jq pipe fails, `steps_json` may be empty rather than `[]`, causing `--argjson steps ""` to fail and the entire `jq -n` on line 852 to produce broken output.

**Fix**: Add validation after reading the formula file, and use `-c` (compact) flag for reliable `--argjson` passing:

```bash
# After line 836, validate formula JSON
if ! echo "$formula_json" | jq empty 2>/dev/null; then
  echo "Error: invalid formula JSON: $formula_path" >&2
  formula_json='{}'
fi

# Line 849: use -c for compact output, proper fallback
steps_json=$(echo "$formula_json" | jq -c '.steps // []' 2>/dev/null)
if [[ -z "$steps_json" ]]; then
  steps_json="[]"
fi
```

Also close `todo-0001-lsv08` after fix is verified.

## Change 2: Fix diary inaccuracies

### 2a. `docs/diary/26-02-23.18-00.beads-removal-v3.md` line 10

**Incorrect**: `brew install dixson3/tap/beads-cli`
**Correct**: `brew install beads`

The homebrew tap `dixson3/tap/beads-cli` does not exist. The actual beads-cli was installed via `brew install beads`.

### 2b. `docs/diary/26-02-18.beads-plugin-removal.md` line 1, 5, 10, 16, 18

**Incorrect**: Claims to be "Plan 47" throughout.
**Correct**: Should reference Plan 42 ("Plugin Activation Gate and Beads Dependency Enforcement").

The actual Plan 47 is "Reconcile GitHub Issues and TODO Register" (confirmed in `docs/plans/plan-47.md`). The diary's content — replacing `yf_beads_installed()` with `yf_bd_available()`, removing plugin dependency from `preflight.json` — matches Plan 42's scope, not Plan 47's. Also update the topics line to say `plan:42` instead of `plan:47`, and the "Plans 42-47" arc reference to "Plans 42-46".

### 2c. `docs/diary/26-02-18.beads-plugin-removal.md` line 34

**Incorrect**: `*Generated by chronicler from 2 chronicle beads*`
**Correct**: `*Generated by chronicler from 2 chronicle entries*`

Typo: "beads" instead of "entries".

## Change 3: Add fact-check step to diary agent

**File**: `plugins/yf/agents/yf_chronicle_diary.md`

Add a **Step 4.5: Fact-Check Entries** between Step 4 (Generate) and Step 5 (Output). This is an integrated validation pass within the existing agent — no new agent needed (keeps it simple, avoids extra dispatch overhead).

Insert after the Writing Guidelines section and before Step 5:

```markdown
### Step 4.5: Fact-Check Entries

Before output, verify all concrete claims in the generated narrative:

1. **Plan references**: For each `plan-NN` or `Plan NN` mentioned, verify the plan file
   exists (`docs/plans/plan-NN.md` or `docs/plans/plan-00NN-*.md`) and the title matches
   the narrative's description of what the plan did.
2. **File paths**: For each file path mentioned in the narrative, verify it exists
   (or existed) via `git ls-files` or `git log --all -- <path>`.
3. **CLI commands**: For each shell command referenced (install commands, CLI tools),
   verify against the codebase — check scripts, hooks, and README for the canonical form.
4. **Version numbers**: If a version bump is mentioned, verify via `git log --oneline`
   or `CHANGELOG.md`.

If a claim cannot be verified, rewrite the sentence to remove or qualify it rather than
leaving a potentially fabricated detail. Flag unverifiable claims with a markdown comment
`<!-- UNVERIFIED: ... -->` so the operator can review.
```

## Files to Modify

| File | Change |
|------|--------|
| `plugins/yf/scripts/yf-tasks.sh` | Fix `yft_mol_wisp()` JSON validation (lines 834-849) |
| `docs/diary/26-02-23.18-00.beads-removal-v3.md` | Fix `brew install` reference (line 10) |
| `docs/diary/26-02-18.beads-plugin-removal.md` | Fix Plan 47→42 references (lines 1, 5, 10, 16, 18, 34) |
| `plugins/yf/agents/yf_chronicle_diary.md` | Add Step 4.5 fact-check (after line 84) |

## Verification

```bash
# 1. Test mol wisp fix:
YFT="plugins/yf/scripts/yf-task-cli.sh"
MOL_ID=$(bash "$YFT" mol wisp plugins/yf/formulas/code-review.formula.json --var feature="test")
jq '.formula, (.steps | length)' .yoshiko-flow/molecules/${MOL_ID}.json
# Expected: "code-review" and 2 (not "unknown" and 0)
bash "$YFT" delete "$MOL_ID" --force  # cleanup

# 2. Verify diary fixes by reading corrected files

# 3. Run existing tests:
bash tests/run-tests.sh --unit-only
```
