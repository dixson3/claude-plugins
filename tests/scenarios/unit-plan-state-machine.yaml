name: "Unit: plan-exec.sh — plan state machine transitions"

setup:
  - "git init"
  - "mkdir -p .claude .yoshiko-flow/tasks docs/plans"
  - "echo '# test' > CLAUDE.md"
  - "git add -A && git commit -m 'init'"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}' > .yoshiko-flow/config.json"
  - |
    ROOT="task-sm-001"
    T1="task-sm-002"
    T2="task-sm-003"
    cat > .yoshiko-flow/tasks/${ROOT}.json << TASKJSON
    {"id":"${ROOT}","type":"epic","title":"State Machine Test Epic","status":"open","labels":["ys:plan","plan:99"],"created":"2026-01-01T00:00:00Z"}
    TASKJSON
    cat > .yoshiko-flow/tasks/${T1}.json << TASKJSON
    {"id":"${T1}","type":"task","title":"Task A","status":"open","labels":["ys:plan","plan:99"],"parent":"${ROOT}","created":"2026-01-01T00:00:01Z"}
    TASKJSON
    cat > .yoshiko-flow/tasks/${T2}.json << TASKJSON
    {"id":"${T2}","type":"task","title":"Task B","status":"open","labels":["ys:plan","plan:99"],"parent":"${ROOT}","created":"2026-01-01T00:00:02Z"}
    TASKJSON
    echo "$ROOT" > .test-epic-id
    echo "$T1" > .test-task1-id
    echo "$T2" > .test-task2-id

steps:
  # Case 1: Missing args → exit 1
  - name: "missing_args_exit_1"
    run: |
      bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" 2>&1
      true
    assertions:
      - type: output_contains
        value: "Usage:"

  # Case 2: Unknown command → exit 1
  - name: "unknown_command_exit_1"
    run: |
      bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" badcommand foo 2>&1 || true
    assertions:
      - type: output_contains
        value: "Unknown command"

  # Case 3: start outputs "State: executing"
  - name: "start_outputs_executing"
    run: |
      ROOT=$(cat .test-epic-id)
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "State: executing"

  # Case 4: start records start-sha label on epic
  - name: "start_records_sha"
    run: |
      ROOT=$(cat .test-epic-id)
      EXPECTED=$(git rev-parse HEAD)
      # Read labels from task file
      LABELS=$(jq -r '.labels[]' "$WORK_DIR/.yoshiko-flow/tasks/${ROOT}.json" 2>/dev/null)
      SHA_LABEL=$(echo "$LABELS" | grep '^start-sha:' | head -1)
      RECORDED="${SHA_LABEL#start-sha:}"
      echo "expected=$EXPECTED recorded=$RECORDED"
      [ "$EXPECTED" = "$RECORDED" ] && echo "OK: start-sha matches HEAD"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: start removes plan-gate file (unblocks edits)
  - name: "start_removes_gate_file"
    run: |
      echo '99' > "$WORK_DIR/.yoshiko-flow/plan-gate"
      ROOT=$(cat .test-epic-id)
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: file_not_exists
        path: ".yoshiko-flow/plan-gate"
      - type: output_contains
        value: "Plan gate removed"

  # Case 6: start is idempotent (double start succeeds)
  - name: "start_idempotent"
    run: |
      ROOT=$(cat .test-epic-id)
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "State: executing"

  # Case 7: completed state when all tasks closed (including auto-created chronicles)
  - name: "completed_when_tasks_closed"
    run: |
      ROOT=$(cat .test-epic-id)
      # Close all open/in_progress task files for plan:99 by updating their status
      for f in "$WORK_DIR/.yoshiko-flow/tasks"/task-sm-*.json; do
        [ -f "$f" ] || continue
        TYPE=$(jq -r '.type' "$f" 2>/dev/null)
        [ "$TYPE" = "epic" ] && continue
        jq '.status = "closed"' "$f" > "$f.tmp" && mv "$f.tmp" "$f"
      done
      # Also close any auto-created chronicle tasks
      for f in "$WORK_DIR/.yoshiko-flow/tasks"/task-*.json; do
        [ -f "$f" ] || continue
        HAS_PLAN=$(jq -r '.labels // [] | any(. == "plan:99")' "$f" 2>/dev/null)
        [ "$HAS_PLAN" = "true" ] || continue
        TYPE=$(jq -r '.type' "$f" 2>/dev/null)
        [ "$TYPE" = "epic" ] && continue
        jq '.status = "closed"' "$f" > "$f.tmp" && mv "$f.tmp" "$f"
      done
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" status "$ROOT" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "completed"

teardown:
  - "rm -f .test-epic-id .test-task1-id .test-task2-id"
  - "rm -rf .yoshiko-flow"
