name: "Unit: Engineer capability â€” preflight directories and code-gate exemption"
setup:
  - "mkdir -p .claude/rules .yoshiko-flow docs/plans docs/diary"

steps:
  # Case 1: Preflight creates specification directories
  - name: "preflight_creates_spec_directories"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json" "$WORK_DIR/.yoshiko-flow/lock.json"
      rm -rf "$WORK_DIR/.claude/rules/yf"
      rm -rf "$WORK_DIR/docs/specifications"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
      # Verify directories created
      FAIL=false
      for dir in docs/specifications docs/specifications/EDD docs/specifications/IG; do
        if [ ! -d "$WORK_DIR/$dir" ]; then
          echo "FAIL: $dir not created"
          FAIL=true
        fi
      done
      if $FAIL; then exit 1; fi
      echo "OK: all specification directories created"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Consolidated rule file installed as symlink
  - name: "engineer_rules_installed"
    run: |
      if [ ! -L "$WORK_DIR/.claude/rules/yf/yf-rules.md" ]; then
        echo "FAIL: yf-rules.md not installed or not a symlink"
        exit 1
      fi
      # Verify consolidated rules contain engineer content
      if grep -q 'Specification Drift' "$WORK_DIR/.claude/rules/yf/yf-rules.md"; then
        echo "OK: consolidated rule installed with engineer content"
      else
        echo "FAIL: yf-rules.md missing engineer content"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Code-gate exempts docs/specifications/ when gate active
  - name: "gate_exempt_specifications"
    run: |
      echo '{"plan_idx":"34"}' > "$WORK_DIR/.yoshiko-flow/plan-gate"
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/docs/specifications/PRD.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 4: Code-gate exempts docs/specifications/EDD/ when gate active
  - name: "gate_exempt_edd_specs"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/docs/specifications/EDD/CORE.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 5: Code-gate exempts docs/specifications/IG/ when gate active
  - name: "gate_exempt_ig_specs"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/docs/specifications/IG/auth.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 6: Code-gate still blocks non-exempt files when gate active
  - name: "gate_blocks_non_exempt"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1 || true
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "2"

  # Cleanup
  - name: "cleanup_gate"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/plan-gate"
      echo "OK: cleaned up"
    assertions:
      - type: exit_code
        value: "0"

  # Case 8: Specification directory structure matches expected layout
  - name: "spec_directory_structure"
    run: |
      # After preflight, verify the expected structure
      FAIL=false
      for dir in docs/specifications docs/specifications/EDD docs/specifications/IG; do
        if [ ! -d "$WORK_DIR/$dir" ]; then
          echo "FAIL: missing $dir"
          FAIL=true
        fi
      done
      $FAIL && exit 1
      echo "OK: spec directory structure correct"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: Reconciliation config defaults to blocking
  - name: "reconciliation_config_default"
    run: |
      # Default when not set should be "blocking"
      RESULT=$(jq -r '.config.engineer.reconciliation_mode // "blocking"' "$WORK_DIR/.yoshiko-flow/config.json" 2>/dev/null || echo "blocking")
      echo "mode=$RESULT"
      [ "$RESULT" = "blocking" ] && echo "OK: default is blocking"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: Engineer reconcile skill exists
  - name: "reconcile_skill_exists"
    run: |
      test -f "$PLUGIN_DIR/plugins/yf/skills/engineer_reconcile/SKILL.md" && echo "OK: reconcile skill exists"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 11: Engineer suggest_updates skill exists
  - name: "suggest_updates_skill_exists"
    run: |
      test -f "$PLUGIN_DIR/plugins/yf/skills/engineer_suggest_updates/SKILL.md" && echo "OK: suggest_updates skill exists"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 12: Watch-for-spec-drift rule covers PRD, EDD, and IG
  - name: "spec_drift_covers_all_types"
    run: |
      RULE="$PLUGIN_DIR/plugins/yf/rules/yf-rules.md"
      PRD=$(grep -c 'PRD' "$RULE")
      EDD=$(grep -c 'EDD' "$RULE")
      IG=$(grep -c 'IG' "$RULE")
      echo "prd=$PRD edd=$EDD ig=$IG"
      [ "$PRD" -ge 1 ] && [ "$EDD" -ge 1 ] && [ "$IG" -ge 1 ] && echo "OK: covers all spec types"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"
