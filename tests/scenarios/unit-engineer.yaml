name: "Unit: Engineer capability — preflight directories and code-gate exemption"
setup:
  - "mkdir -p .claude/rules .yoshiko-flow docs/plans docs/diary"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}'  > .yoshiko-flow/config.json"

steps:
  # Case 1: Preflight creates specification directories
  - name: "preflight_creates_spec_directories"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json" "$WORK_DIR/.yoshiko-flow/lock.json"
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -rf "$WORK_DIR/.claude/rules/yf"
      rm -rf "$WORK_DIR/docs/specifications"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
      # Verify directories created
      FAIL=false
      for dir in docs/specifications docs/specifications/EDD docs/specifications/IG; do
        if [ ! -d "$WORK_DIR/$dir" ]; then
          echo "FAIL: $dir not created"
          FAIL=true
        fi
      done
      if $FAIL; then exit 1; fi
      echo "OK: all specification directories created"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Consolidated rule file installed as symlink
  - name: "engineer_rules_installed"
    run: |
      if [ ! -L "$WORK_DIR/.claude/rules/yf/yf-rules.md" ]; then
        echo "FAIL: yf-rules.md not installed or not a symlink"
        exit 1
      fi
      # Verify consolidated rules contain engineer content
      if grep -q 'Specification Drift' "$WORK_DIR/.claude/rules/yf/yf-rules.md"; then
        echo "OK: consolidated rule installed with engineer content"
      else
        echo "FAIL: yf-rules.md missing engineer content"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Code-gate exempts docs/specifications/ when gate active
  - name: "gate_exempt_specifications"
    run: |
      echo '{"plan_idx":"34"}' > "$WORK_DIR/.yoshiko-flow/plan-gate"
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/docs/specifications/PRD.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 4: Code-gate exempts docs/specifications/EDD/ when gate active
  - name: "gate_exempt_edd_specs"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/docs/specifications/EDD/CORE.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 5: Code-gate exempts docs/specifications/IG/ when gate active
  - name: "gate_exempt_ig_specs"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/docs/specifications/IG/auth.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 6: Code-gate still blocks non-exempt files when gate active
  - name: "gate_blocks_non_exempt"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1 || true
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "2"

  # Cleanup
  - name: "cleanup_gate"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/plan-gate"
      echo "OK: cleaned up"
    assertions:
      - type: exit_code
        value: "0"

  # Case 8: Specification directory structure matches expected layout
  - name: "spec_directory_structure"
    run: |
      # After preflight, verify the expected structure
      FAIL=false
      for dir in docs/specifications docs/specifications/EDD docs/specifications/IG; do
        if [ ! -d "$WORK_DIR/$dir" ]; then
          echo "FAIL: missing $dir"
          FAIL=true
        fi
      done
      $FAIL && exit 1
      echo "OK: spec directory structure correct"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: Reconciliation config defaults to blocking
  - name: "reconciliation_config_default"
    run: |
      # Default when not set should be "blocking"
      RESULT=$(jq -r '.config.engineer.reconciliation_mode // "blocking"' "$WORK_DIR/.yoshiko-flow/config.json" 2>/dev/null || echo "blocking")
      echo "mode=$RESULT"
      [ "$RESULT" = "blocking" ] && echo "OK: default is blocking"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: Engineer reconcile skill exists
  - name: "reconcile_skill_exists"
    run: |
      test -f "$PLUGIN_DIR/plugins/yf/skills/engineer_reconcile/SKILL.md" && echo "OK: reconcile skill exists"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 11: Engineer suggest_updates skill exists
  - name: "suggest_updates_skill_exists"
    run: |
      test -f "$PLUGIN_DIR/plugins/yf/skills/engineer_suggest_updates/SKILL.md" && echo "OK: suggest_updates skill exists"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 12: Watch-for-spec-drift rule covers PRD, EDD, and IG
  - name: "spec_drift_covers_all_types"
    run: |
      RULE="$PLUGIN_DIR/plugins/yf/rules/yf-rules.md"
      PRD=$(grep -c 'PRD' "$RULE")
      EDD=$(grep -c 'EDD' "$RULE")
      IG=$(grep -c 'IG' "$RULE")
      echo "prd=$PRD edd=$EDD ig=$IG"
      [ "$PRD" -ge 1 ] && [ "$EDD" -ge 1 ] && [ "$IG" -ge 1 ] && echo "OK: covers all spec types"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 13: Default reconciliation mode is "blocking"
  - name: "reconciliation_default_blocking"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      MODE=$(yf_read_field '.config.engineer.reconciliation_mode' 2>/dev/null)
      # Null/empty → "blocking" by convention
      if [ -z "$MODE" ] || [ "$MODE" = "null" ]; then
        MODE="blocking"
      fi
      echo "mode=$MODE"
      [ "$MODE" = "blocking" ] && echo "OK: default reconciliation mode is blocking"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 14: Config with reconciliation_mode: disabled reads correctly
  - name: "reconciliation_disabled_reads"
    run: |
      echo '{"enabled":true,"config":{"engineer":{"reconciliation_mode":"disabled"}}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      MODE=$(yf_read_field '.config.engineer.reconciliation_mode')
      echo "mode=$MODE"
      [ "$MODE" = "disabled" ] && echo "OK: disabled mode reads correctly"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 15: spec-sanity-check.sh with valid specs exits 0
  - name: "spec_sanity_valid_exit_0"
    run: |
      # Create valid synthetic specs matching each other
      echo '{"enabled":true}' > "$WORK_DIR/.yoshiko-flow/config.json"
      mkdir -p "$WORK_DIR/docs/specifications/EDD" "$WORK_DIR/docs/specifications/IG"
      mkdir -p "$WORK_DIR/plugins/yf/formulas" "$WORK_DIR/tests/scenarios"
      printf '# PRD\n| ID | Req |\n| REQ-001 | First |\n\n## Functional Specifications\n- FS-011: One formula shipped: test-formula (see FS-034)\n' > "$WORK_DIR/docs/specifications/PRD.md"
      printf '# EDD\n### DD-001: First\n### NFR-001: Perf\n' > "$WORK_DIR/docs/specifications/EDD/CORE.md"
      printf '# IG\n### UC-001: First\n' > "$WORK_DIR/docs/specifications/IG/test.md"
      echo '{}' > "$WORK_DIR/plugins/yf/formulas/test-formula.formula.json"
      printf '# Test Coverage\n## Requirements (REQ-xxx)\n| ID | Summary | Test File | Status |\n| REQ-001 | First | — | untested |\n\n## Design Decisions (DD-xxx)\n| ID | Summary | Test File | Status |\n| DD-001 | First | — | untested |\n\n## Non-Functional Requirements (NFR-xxx)\n| ID | Summary | Test File | Status |\n| NFR-001 | Perf | — | untested |\n\n## Use Cases (UC-xxx)\nAligned to IG files: test (UC-001).\n| ID | Summary | IG Source | Test File | Status |\n| UC-001 | First | test | — | untested |\n\n## Coverage Summary\n| Category | Total | Tested | Existence-Only | Untested |\n|----------|-------|--------|----------------|----------|\n| REQ | 1 | 0 | 0 | 1 |\n| DD | 1 | 0 | 0 | 1 |\n| NFR | 1 | 0 | 0 | 1 |\n| UC | 1 | 0 | 0 | 1 |\n| **Total** | **4** | **0** | **0** | **4** |\n' > "$WORK_DIR/docs/specifications/test-coverage.md"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/spec-sanity-check.sh" all 2>&1)
      echo "$OUTPUT"
      echo "$OUTPUT" | grep -q "SANITY_ISSUES=0" && echo "OK: valid specs pass"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "SANITY_ISSUES=0"
      - type: output_contains
        value: "OK"

  # Case 16: spec-sanity-check.sh with mismatched counts reports failures
  - name: "spec_sanity_mismatch_reports_fail"
    run: |
      # PRD has 2 REQs but coverage only lists 1
      printf '# PRD\n| ID | Req |\n| REQ-001 | First |\n| REQ-002 | Second |\n\n## Functional Specifications\n- FS-011: One formula shipped: test-formula (see FS-034)\n' > "$WORK_DIR/docs/specifications/PRD.md"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/spec-sanity-check.sh" counts 2>&1)
      echo "$OUTPUT"
      echo "$OUTPUT" | grep -q '\[FAIL\]' && echo "OK: mismatch detected"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "[FAIL]"
      - type: output_contains
        value: "OK"
