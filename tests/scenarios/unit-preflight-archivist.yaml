name: "Unit: plugin-preflight.sh â€” archivist toggle"

setup:
  - "mkdir -p .claude/rules .yoshiko-flow docs/plans docs/diary"

steps:
  # Case 1: Archivist rules installed by default
  - name: "archivist_rules_installed_by_default"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json" "$WORK_DIR/.yoshiko-flow/lock.json"
      rm -rf "$WORK_DIR/.claude/rules/yf"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      if [ -L "$WORK_DIR/.claude/rules/yf/watch-for-archive-worthiness.md" ] && \
         [ -L "$WORK_DIR/.claude/rules/yf/plan-transition-archive.md" ]; then
        echo "OK: archivist rules installed as symlinks"
      else
        echo "FAIL: archivist rules missing"
        ls -la "$WORK_DIR/.claude/rules/" 2>/dev/null
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Archivist rules skipped when disabled
  - name: "archivist_rules_skipped_when_disabled"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json" "$WORK_DIR/.yoshiko-flow/lock.json"
      rm -rf "$WORK_DIR/.claude/rules/yf"
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":true,"config":{"artifact_dir":"docs","chronicler_enabled":true,"archivist_enabled":false}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      FAIL=false
      if [ -e "$WORK_DIR/.claude/rules/yf/watch-for-archive-worthiness.md" ] || \
         [ -L "$WORK_DIR/.claude/rules/yf/watch-for-archive-worthiness.md" ]; then
        echo "FAIL: watch-for-archive-worthiness.md should not be installed"
        FAIL=true
      fi
      if [ -e "$WORK_DIR/.claude/rules/yf/plan-transition-archive.md" ] || \
         [ -L "$WORK_DIR/.claude/rules/yf/plan-transition-archive.md" ]; then
        echo "FAIL: plan-transition-archive.md should not be installed"
        FAIL=true
      fi
      # Chronicle rules should still be installed
      if [ ! -L "$WORK_DIR/.claude/rules/yf/watch-for-chronicle-worthiness.md" ]; then
        echo "FAIL: chronicle rules should be installed"
        FAIL=true
      fi
      if $FAIL; then
        exit 1
      fi
      echo "OK: archivist rules skipped, others installed"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Archivist rules removed on reconfigure to disabled
  - name: "archivist_rules_removed_on_reconfigure"
    run: |
      # First install with archivist enabled (default)
      rm -f "$WORK_DIR/.yoshiko-flow/config.json" "$WORK_DIR/.yoshiko-flow/lock.json"
      rm -rf "$WORK_DIR/.claude/rules/yf"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      # Verify archivist rules exist
      if [ ! -L "$WORK_DIR/.claude/rules/yf/watch-for-archive-worthiness.md" ]; then
        echo "FAIL: archivist rules not installed in first pass"
        exit 1
      fi
      # Now disable archivist
      jq '. + {config: (.config + {archivist_enabled: false})}' "$WORK_DIR/.yoshiko-flow/config.json" > "$WORK_DIR/.yoshiko-flow/config.json.tmp"
      mv "$WORK_DIR/.yoshiko-flow/config.json.tmp" "$WORK_DIR/.yoshiko-flow/config.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if [ -e "$WORK_DIR/.claude/rules/yf/watch-for-archive-worthiness.md" ] || \
         [ -L "$WORK_DIR/.claude/rules/yf/watch-for-archive-worthiness.md" ]; then
        echo "FAIL: archivist rule still exists"
        exit 1
      fi
      if [ -e "$WORK_DIR/.claude/rules/yf/plan-transition-archive.md" ] || \
         [ -L "$WORK_DIR/.claude/rules/yf/plan-transition-archive.md" ]; then
        echo "FAIL: transition archive rule still exists"
        exit 1
      fi
      echo "OK: archivist rules removed"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "removed"
      - type: output_contains
        value: "OK"

  # Case 4: Non-archivist rules preserved when archivist disabled
  - name: "non_archivist_rules_preserved"
    run: |
      # Re-run preflight with archivist disabled
      echo '{"enabled":true,"config":{"archivist_enabled":false}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      if [ -L "$WORK_DIR/.claude/rules/yf/beads.md" ] && \
         [ -L "$WORK_DIR/.claude/rules/yf/engage-the-plan.md" ] && \
         [ -L "$WORK_DIR/.claude/rules/yf/watch-for-chronicle-worthiness.md" ]; then
        echo "OK: non-archivist rules preserved"
      else
        echo "FAIL: non-archivist rules missing"
        ls -la "$WORK_DIR/.claude/rules/" 2>/dev/null
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Lock file excludes archivist rules when disabled
  - name: "lock_excludes_archivist_rules"
    run: |
      TARGETS=$(jq -r '.preflight.plugins.yf.artifacts.rules[].target' "$WORK_DIR/.yoshiko-flow/lock.json")
      if echo "$TARGETS" | grep -q "archive-worthiness"; then
        echo "FAIL: archive rule in lock"
        exit 1
      fi
      if echo "$TARGETS" | grep -q "plan-transition-archive"; then
        echo "FAIL: transition archive rule in lock"
        exit 1
      fi
      echo "OK: archivist rules not in lock"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json .yoshiko-flow/lock.json"
