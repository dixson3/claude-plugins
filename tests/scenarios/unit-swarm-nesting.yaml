name: "Unit: swarm nesting (compose + depth)"
setup:
  - "mkdir -p .yoshiko-flow"

steps:
  # Case 1: feature-build formula has compose field on implement step
  - name: "feature_build_has_compose"
    run: |
      jq -r '.steps[] | select(.id == "implement") | .compose // "none"' "$PLUGIN_DIR/plugins/yf/formulas/feature-build.formula.json"
    assertions:
      - type: output_contains
        value: "build-test"

  # Case 2: swarm_run skill has depth parameter
  - name: "swarm_run_has_depth"
    run: |
      grep "depth" "$PLUGIN_DIR/plugins/yf/skills/swarm_run/SKILL.md" | head -3
    assertions:
      - type: output_contains
        value: "depth"

  # Case 3: swarm_dispatch skill documents compose detection
  - name: "dispatch_has_compose_detection"
    run: |
      grep "compose" "$PLUGIN_DIR/plugins/yf/skills/swarm_dispatch/SKILL.md" | head -3
    assertions:
      - type: output_contains
        value: "compose"

  # Case 4: swarm-nesting rule exists
  - name: "nesting_rule_exists"
    run: |
      test -f "$PLUGIN_DIR/plugins/yf/rules/swarm-nesting.md" && echo "exists"
    assertions:
      - type: output_contains
        value: "exists"

  # Case 5: Nesting rule documents max depth 2
  - name: "nesting_max_depth"
    run: |
      grep "depth.*2\|Maximum.*2\|max.*2" "$PLUGIN_DIR/plugins/yf/rules/swarm-nesting.md" | head -1
    assertions:
      - type: exit_code
        value: "0"

  # Case 6: swarm-state.sh scoped clear works
  - name: "scoped_clear"
    run: |
      rm -f .yoshiko-flow/swarm-state.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/swarm-state.sh" mark-dispatched "parent-mol/step-a"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/swarm-state.sh" mark-dispatched "other-step"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/swarm-state.sh" clear --scope "parent-mol"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/swarm-state.sh" pending
    assertions:
      - type: output_contains
        value: "other-step"

  # Case 7: Scoped clear removes scoped entries
  - name: "scoped_clear_removes_scoped"
    run: |
      rm -f .yoshiko-flow/swarm-state.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/swarm-state.sh" mark-dispatched "parent-mol/step-a"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/swarm-state.sh" mark-dispatched "parent-mol/step-b"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/swarm-state.sh" clear --scope "parent-mol"
      RESULT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/swarm-state.sh" pending)
      if [ -z "$RESULT" ]; then echo "empty"; else echo "not-empty: $RESULT"; fi
    assertions:
      - type: output_contains
        value: "empty"

  # Case 8: preflight.json includes nesting rule
  - name: "preflight_has_nesting_rule"
    run: |
      grep "swarm-nesting" "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json"
    assertions:
      - type: output_contains
        value: "swarm-nesting.md"

teardown:
  - "rm -f .yoshiko-flow/swarm-state.json"
