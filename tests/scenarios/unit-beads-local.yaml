name: "Unit: beads local-only â€” git tracking and sync removed"

steps:
  # Case 1: .gitignore contains .beads/
  - name: "gitignore_has_beads"
    run: |
      if grep -q '^\.beads/$' "$PLUGIN_DIR/.gitignore"; then
        echo "OK: .gitignore contains .beads/"
      else
        echo "FAIL: .gitignore does not contain .beads/"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: preflight.json uses --skip-hooks
  - name: "preflight_uses_skip_hooks"
    run: |
      RUN_CMD=$(jq -r '.artifacts.setup[] | select(.name == "beads") | .run' "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json")
      if echo "$RUN_CMD" | grep -q '\-\-skip-hooks'; then
        echo "OK: preflight uses --skip-hooks"
      else
        echo "FAIL: preflight run command is '$RUN_CMD', expected --skip-hooks"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: beads.md Quick Reference does NOT list "bd sync" as a command
  - name: "no_bd_sync_in_rule"
    run: |
      # The Quick Reference code block should not contain "bd sync" as a listed command
      # Informational mentions like "no bd sync step" and "Do NOT run bd sync" are fine
      if grep -A10 '## Quick Reference' "$PLUGIN_DIR/plugins/yf/rules/beads.md" | grep -q 'bd sync'; then
        echo "FAIL: beads.md Quick Reference still lists 'bd sync'"
        exit 1
      fi
      echo "OK: no 'bd sync' in Quick Reference"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: beads.md does NOT contain "Work is NOT complete until"
  - name: "no_mandatory_push"
    run: |
      if grep -q 'Work is NOT complete until' "$PLUGIN_DIR/plugins/yf/rules/beads.md"; then
        echo "FAIL: beads.md still contains mandatory push language"
        exit 1
      fi
      echo "OK: no mandatory push language in beads.md"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: beads.md contains "Beads Are Local"
  - name: "beads_local_section"
    run: |
      if grep -q 'Beads Are Local' "$PLUGIN_DIR/plugins/yf/rules/beads.md"; then
        echo "OK: beads.md contains 'Beads Are Local' section"
      else
        echo "FAIL: beads.md missing 'Beads Are Local' section"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: beads.md does NOT contain "NEVER stop before pushing"
  - name: "no_never_stop_pushing"
    run: |
      if grep -q 'NEVER stop before pushing' "$PLUGIN_DIR/plugins/yf/rules/beads.md"; then
        echo "FAIL: beads.md still contains 'NEVER stop before pushing'"
        exit 1
      fi
      echo "OK: no 'NEVER stop before pushing' in beads.md"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"
