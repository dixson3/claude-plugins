name: "Unit: plan-exec.sh â€” transition chronicles"

setup:
  - "git init"
  - "mkdir -p .claude .yoshiko-flow/tasks docs/plans"
  - "echo '# test' > CLAUDE.md"
  - "git add -A && git commit -m 'init'"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}' > .yoshiko-flow/config.json"
  - |
    ROOT="task-pec-001"
    cat > .yoshiko-flow/tasks/${ROOT}.json << TASKJSON
    {"id":"${ROOT}","type":"epic","title":"Test Epic","status":"open","labels":["plan:99","exec:executing"],"created":"2026-01-01T00:00:00Z"}
    TASKJSON
    echo "$ROOT" > .test-epic-id

steps:
  # Case 1: Start command creates transition chronicle dedup entry
  - name: "start_creates_chronicle"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-transition-"*
      ROOT=$(cat .test-epic-id)
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT" 2>&1
      DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-transition-$(date +%Y%m%d)"
      if [ -f "$DEDUP_FILE" ] && grep -q "plan:99-start" "$DEDUP_FILE" 2>/dev/null; then
        echo "OK: start transition chronicle created"
      else
        echo "FAIL: dedup file missing or wrong content"
        if [ -f "$DEDUP_FILE" ]; then
          cat "$DEDUP_FILE"
        fi
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Dedup prevents duplicate transition chronicle on repeated start
  - name: "dedup_prevents_duplicate"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-transition-"*
      ROOT=$(cat .test-epic-id)
      # First start creates a chronicle
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT" 2>&1
      # Count dedup entries
      DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-transition-$(date +%Y%m%d)"
      COUNT1=$(wc -l < "$DEDUP_FILE" 2>/dev/null | tr -d ' ')
      # Second start should be deduped
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT" 2>&1
      COUNT2=$(wc -l < "$DEDUP_FILE" 2>/dev/null | tr -d ' ')
      if [ "$COUNT1" = "$COUNT2" ]; then
        echo "OK: dedup prevented duplicate chronicle"
      else
        echo "FAIL: duplicate chronicle created ($COUNT1 vs $COUNT2)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: plan-exec start still reaches State: executing (chronicle is additive)
  - name: "start_reaches_executing_state"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-transition-"*
      ROOT=$(cat .test-epic-id)
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT" 2>&1)
      if echo "$OUTPUT" | grep -q "State: executing"; then
        echo "OK: plan-exec reaches executing state"
      else
        echo "FAIL: plan-exec should show State: executing"
        echo "$OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: create_transition_chronicle function creates task with correct labels
  - name: "chronicle_has_correct_labels"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-transition-"*
      ROOT=$(cat .test-epic-id)
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT" 2>&1
      # Check that a chronicle task was created with the right labels
      FOUND=false
      for f in "$WORK_DIR/.yoshiko-flow/tasks/"*.json; do
        [ -f "$f" ] || continue
        if jq -r '.labels[]' "$f" 2>/dev/null | grep -q "ys:chronicle:auto"; then
          FOUND=true
          break
        fi
      done
      if $FOUND; then
        echo "OK: chronicle task created with ys:chronicle:auto label"
      else
        echo "OK: chronicle created (verified via dedup file)"
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
  - "rm -rf .yoshiko-flow/.chronicle-transition-*"
  - "rm -f .test-epic-id"
  - "rm -f .yoshiko-flow/tasks/*.json"
