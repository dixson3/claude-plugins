name: "Unit: session-end.sh â€” SessionEnd auto-draft + pending marker"

setup:
  - "mkdir -p .yoshiko-flow/tasks .yoshiko-flow/chronicler"
  - "git init . >/dev/null 2>&1 || true"
  - "git config user.email 'test@test.com' && git config user.name 'Test'"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}'  > .yoshiko-flow/config.json"

steps:
  # Case 1: Exits silently when yf disabled
  - name: "exits_when_yf_disabled"
    run: |
      echo '{"enabled":false}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.pending-diary"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/session-end.sh" 2>&1)
      EXIT_CODE=$?
      if [ "$EXIT_CODE" -eq 0 ] && [ -z "$OUTPUT" ] && [ ! -f "$WORK_DIR/.yoshiko-flow/.pending-diary" ]; then
        echo "OK: exits silently when yf disabled, no marker written"
      else
        echo "FAIL: should exit 0 silently with no marker (exit=$EXIT_CODE, output=$OUTPUT)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Writes pending-diary marker when open chronicles exist
  - name: "writes_pending_marker"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.pending-diary"
      # Create open chronicle task files
      cat > "$WORK_DIR/.yoshiko-flow/chronicler/chron-end-001.json" << 'TASKJSON'
      {"id":"chron-end-001","type":"chronicle","title":"Chronicle: work","status":"open","labels":["ys:chronicle"],"created":"2026-01-01T00:00:00Z"}
      TASKJSON
      cat > "$WORK_DIR/.yoshiko-flow/chronicler/chron-end-002.json" << 'TASKJSON'
      {"id":"chron-end-002","type":"chronicle","title":"Chronicle: more","status":"open","labels":["ys:chronicle"],"created":"2026-01-01T00:00:01Z"}
      TASKJSON
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/session-end.sh" 2>&1)
      EXIT_CODE=$?
      if [ -f "$WORK_DIR/.yoshiko-flow/.pending-diary" ]; then
        MARKER_CONTENT=$(cat "$WORK_DIR/.yoshiko-flow/.pending-diary")
        echo "MARKER: $MARKER_CONTENT"
        if echo "$MARKER_CONTENT" | grep -q '"reason": "session_end"' && \
           echo "$MARKER_CONTENT" | grep -q '"chronicle_count": 2'; then
          echo "OK: marker written with correct content"
        else
          echo "FAIL: marker content incorrect"
          exit 1
        fi
      else
        echo "FAIL: pending-diary marker not created"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: No marker when no open chronicles
  - name: "no_marker_when_no_chronicles"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.pending-diary"
      # Remove chronicle files
      rm -f "$WORK_DIR/.yoshiko-flow/chronicler/"*.json
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/session-end.sh" 2>&1)
      EXIT_CODE=$?
      if [ "$EXIT_CODE" -eq 0 ] && [ ! -f "$WORK_DIR/.yoshiko-flow/.pending-diary" ]; then
        echo "OK: no marker when no open chronicles"
      else
        echo "FAIL: should not write marker (exit=$EXIT_CODE, marker_exists=$(test -f "$WORK_DIR/.yoshiko-flow/.pending-diary" && echo yes || echo no))"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Always exits 0 even on errors
  - name: "always_exits_zero"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/session-end.sh" >/dev/null 2>&1
      echo "OK: exit code $?"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Writes dirty-tree marker when tree dirty
  - name: "writes_dirty_tree_marker"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.dirty-tree"
      # Create uncommitted file to make tree dirty
      echo "dirty" > "$WORK_DIR/uncommitted.txt"
      # Remove chronicles so pending-diary doesn't interfere
      rm -f "$WORK_DIR/.yoshiko-flow/chronicler/"*.json
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/session-end.sh" 2>&1)
      EXIT_CODE=$?
      if [ -f "$WORK_DIR/.yoshiko-flow/.dirty-tree" ]; then
        MARKER=$(cat "$WORK_DIR/.yoshiko-flow/.dirty-tree")
        if echo "$MARKER" | grep -q '"reason":"session_end"' && \
           echo "$MARKER" | grep -q '"dirty_count":'; then
          echo "OK: dirty-tree marker written with correct content"
        else
          echo "FAIL: marker content incorrect: $MARKER"
          exit 1
        fi
      else
        echo "FAIL: dirty-tree marker not created"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: No dirty-tree marker when tree clean
  - name: "no_dirty_marker_when_clean"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.dirty-tree"
      rm -f "$WORK_DIR/uncommitted.txt"
      cd "$WORK_DIR"
      git add -A >/dev/null 2>&1 || true
      git commit -m "clean" --allow-empty >/dev/null 2>&1 || true
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/session-end.sh" 2>&1)
      if [ ! -f "$WORK_DIR/.yoshiko-flow/.dirty-tree" ]; then
        echo "OK: no dirty-tree marker when tree clean"
      else
        echo "FAIL: dirty-tree marker should not exist"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
  - "rm -f .yoshiko-flow/.pending-diary"
  - "rm -f .yoshiko-flow/.dirty-tree"
  - "rm -f uncommitted.txt"
  - "rm -f .yoshiko-flow/chronicler/chron-end-*"
