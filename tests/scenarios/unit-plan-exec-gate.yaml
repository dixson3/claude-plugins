name: "Unit: plan-exec.sh gate removal"
setup:
  - "git init"
  - "mkdir -p .claude .yoshiko-flow/tasks docs/plans"
  - "echo '# test' > CLAUDE.md"
  - "git add -A && git commit -m 'init'"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}' > .yoshiko-flow/config.json"
  - |
    # Create a root epic task file
    ROOT="task-exec-gate-001"
    cat > .yoshiko-flow/tasks/${ROOT}.json << TASKJSON
    {"id":"${ROOT}","type":"epic","title":"Test Epic","status":"open","labels":["ys:plan","plan:99"],"created":"2026-01-01T00:00:00Z"}
    TASKJSON
    echo "$ROOT" > .test-epic-id

steps:
  # Case 1: .plan-gate removed during start
  - name: "gate_removed_on_start"
    run: |
      echo '{"plan_idx":"99"}' > .yoshiko-flow/plan-gate
      ROOT=$(cat .test-epic-id)
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT"
    assertions:
      - type: file_not_exists
        path: ".yoshiko-flow/plan-gate"

  # Case 2: No gate â†’ no error
  - name: "no_gate_no_error"
    run: |
      ROOT=$(cat .test-epic-id)
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT"
    assertions:
      - type: exit_code
        value: "0"

  # Case 3: Gate removal message in stdout
  - name: "gate_removal_message"
    run: |
      echo '{"plan_idx":"99"}' > .yoshiko-flow/plan-gate
      ROOT=$(cat .test-epic-id)
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-exec.sh" start "$ROOT" 2>&1
    assertions:
      - type: output_contains
        value: "Plan gate removed"

teardown:
  - "rm -f .yoshiko-flow/plan-gate"
  - "rm -f .test-epic-id"
  - "rm -f .yoshiko-flow/tasks/task-exec-gate-*"
