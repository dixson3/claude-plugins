name: "Unit: plan-chronicle.sh and chronicle-validate.sh"

setup:
  - "git init"
  - "mkdir -p .claude .yoshiko-flow/tasks .yoshiko-flow/chronicler docs/plans"
  - "echo '# test' > CLAUDE.md"
  - "echo '# Plan 99: Test Plan' > docs/plans/plan-99.md"
  - "echo '**Status:** Draft' >> docs/plans/plan-99.md"
  - "echo '' >> docs/plans/plan-99.md"
  - "echo '## Overview' >> docs/plans/plan-99.md"
  - "echo 'This is a test plan for chronicle validation.' >> docs/plans/plan-99.md"
  - "git add -A && git commit -m 'init'"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}' > .yoshiko-flow/config.json"

steps:
  # Case 1: plan-chronicle.sh save creates a task with correct labels
  - name: "save_creates_chronicle_task"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-plan-"*
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-chronicle.sh" save "plan:99" "$WORK_DIR/docs/plans/plan-99.md" 2>&1
      # Verify task was created with correct labels
      FOUND=false
      for f in "$WORK_DIR/.yoshiko-flow/chronicler/"*.json; do
        [ -f "$f" ] || continue
        if jq -r '.labels[]' "$f" 2>/dev/null | grep -q "ys:chronicle:auto" && \
           jq -r '.title' "$f" 2>/dev/null | grep -q "save"; then
          FOUND=true
          break
        fi
      done
      if $FOUND; then
        echo "OK: save chronicle task created with correct title"
      else
        # Check dedup file as backup verification
        DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-plan-$(date +%Y%m%d)"
        if [ -f "$DEDUP_FILE" ] && grep -q "plan:99-save" "$DEDUP_FILE" 2>/dev/null; then
          echo "OK: save chronicle created (verified via dedup file)"
        else
          echo "FAIL: no chronicle task or dedup entry found"
          exit 1
        fi
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Dedup prevents duplicate save chronicles
  - name: "dedup_prevents_duplicate_save"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-plan-"*
      # First save
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-chronicle.sh" save "plan:99" "$WORK_DIR/docs/plans/plan-99.md" 2>&1
      DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-plan-$(date +%Y%m%d)"
      COUNT1=$(wc -l < "$DEDUP_FILE" 2>/dev/null | tr -d ' ')
      # Second save — should be deduped
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-chronicle.sh" save "plan:99" "$WORK_DIR/docs/plans/plan-99.md" 2>&1
      COUNT2=$(wc -l < "$DEDUP_FILE" 2>/dev/null | tr -d ' ')
      if [ "$COUNT1" = "$COUNT2" ]; then
        echo "OK: dedup prevented duplicate chronicle"
      else
        echo "FAIL: duplicate chronicle created ($COUNT1 vs $COUNT2)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: plan-chronicle.sh intake creates a task with plan file excerpt
  - name: "intake_creates_chronicle_with_excerpt"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-plan-"*
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-chronicle.sh" intake "plan:99" "$WORK_DIR/docs/plans/plan-99.md" 2>&1)
      if echo "$OUTPUT" | grep -q "Chronicle stub created"; then
        echo "OK: intake chronicle created"
      else
        # Check dedup file
        DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-plan-$(date +%Y%m%d)"
        if [ -f "$DEDUP_FILE" ] && grep -q "plan:99-intake" "$DEDUP_FILE" 2>/dev/null; then
          echo "OK: intake chronicle created (verified via dedup)"
        else
          echo "FAIL: intake chronicle not created"
          echo "$OUTPUT"
          exit 1
        fi
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: plan-chronicle.sh fails open on unknown command
  - name: "fails_open_on_unknown_command"
    run: |
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-chronicle.sh" badcmd "plan:99" 2>&1
      echo "OK: exited 0 on unknown command"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: chronicle-validate.sh detects missing boundaries and creates fallbacks
  - name: "validate_creates_fallbacks_for_missing"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-plan-"*
      # Clean slate
      rm -f "$WORK_DIR/.yoshiko-flow/chronicler/"*.json
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-validate.sh" "plan:98" 2>&1)
      if echo "$OUTPUT" | grep -q "created"; then
        echo "OK: fallbacks created for missing boundaries"
      else
        echo "FAIL: expected fallback creation"
        echo "$OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: chronicle-validate.sh reports full coverage when all stubs exist
  - name: "validate_reports_full_coverage"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-plan-"*
      rm -f "$WORK_DIR/.yoshiko-flow/chronicler/"*.json
      # Create all three boundary chronicles manually as task files
      YFT="$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$YFT" create --type=task --priority=3 \
        -l "ys:chronicle,ys:chronicle:auto,ys:topic:planning,plan:97" \
        --title "Chronicle (Auto): Plan plan:97 — save" 2>/dev/null
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$YFT" create --type=task --priority=3 \
        -l "ys:chronicle,ys:chronicle:auto,ys:topic:planning,plan:97" \
        --title "Chronicle (Auto): Plan plan:97 — start" 2>/dev/null
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$YFT" create --type=task --priority=3 \
        -l "ys:chronicle,ys:chronicle:auto,ys:topic:planning,plan:97" \
        --title "Chronicle (Auto): Plan plan:97 — complete" 2>/dev/null
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-validate.sh" "plan:97" 2>&1)
      if echo "$OUTPUT" | grep -q "3/3 boundaries covered"; then
        echo "OK: full coverage reported"
      else
        echo "FAIL: expected 3/3 coverage"
        echo "$OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/.chronicle-plan-*"
  - "rm -f docs/plans/plan-99.md"
  - "rm -f .yoshiko-flow/chronicler/*.json .yoshiko-flow/tasks/*.json"
