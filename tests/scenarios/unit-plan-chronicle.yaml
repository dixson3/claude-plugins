name: "Unit: plan-chronicle.sh and chronicle-validate.sh"

setup:
  - "git init"
  - "mkdir -p .claude .yoshiko-flow .beads docs/plans"
  - "echo '# test' > CLAUDE.md"
  - "echo '# Plan 99: Test Plan' > docs/plans/plan-99.md"
  - "echo '**Status:** Draft' >> docs/plans/plan-99.md"
  - "echo '' >> docs/plans/plan-99.md"
  - "echo '## Overview' >> docs/plans/plan-99.md"
  - "echo 'This is a test plan for chronicle validation.' >> docs/plans/plan-99.md"
  - "git add -A && git commit -m 'init'"
  - "bd init 2>/dev/null || true"

steps:
  # Case 1: plan-chronicle.sh save creates a bead with correct labels
  - name: "save_creates_chronicle_bead"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-plan-"*
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-chronicle.sh" save "plan:99" "$WORK_DIR/docs/plans/plan-99.md" 2>&1
      # Verify bead was created with correct labels
      BEAD=$(bd list --label=ys:chronicle:auto --status=open --limit=1 --json 2>/dev/null || echo "[]")
      COUNT=$(echo "$BEAD" | jq 'length' 2>/dev/null || echo "0")
      if [ "$COUNT" -gt 0 ]; then
        TITLE=$(echo "$BEAD" | jq -r '.[0].title' 2>/dev/null || echo "")
        if echo "$TITLE" | grep -q "save"; then
          echo "OK: save chronicle bead created with correct title"
        else
          echo "FAIL: bead title doesn't contain 'save': $TITLE"
          exit 1
        fi
      else
        # Check dedup file as backup verification
        DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-plan-$(date +%Y%m%d)"
        if [ -f "$DEDUP_FILE" ] && grep -q "plan:99-save" "$DEDUP_FILE" 2>/dev/null; then
          echo "OK: save chronicle created (verified via dedup file)"
        else
          echo "FAIL: no chronicle bead or dedup entry found"
          exit 1
        fi
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Dedup prevents duplicate save chronicles
  - name: "dedup_prevents_duplicate_save"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-plan-"*
      # First save
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-chronicle.sh" save "plan:99" "$WORK_DIR/docs/plans/plan-99.md" 2>&1
      DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-plan-$(date +%Y%m%d)"
      COUNT1=$(wc -l < "$DEDUP_FILE" 2>/dev/null | tr -d ' ')
      # Second save — should be deduped
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-chronicle.sh" save "plan:99" "$WORK_DIR/docs/plans/plan-99.md" 2>&1
      COUNT2=$(wc -l < "$DEDUP_FILE" 2>/dev/null | tr -d ' ')
      if [ "$COUNT1" = "$COUNT2" ]; then
        echo "OK: dedup prevented duplicate chronicle"
      else
        echo "FAIL: duplicate chronicle created ($COUNT1 vs $COUNT2)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: plan-chronicle.sh intake creates a bead with plan file excerpt
  - name: "intake_creates_chronicle_with_excerpt"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-plan-"*
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-chronicle.sh" intake "plan:99" "$WORK_DIR/docs/plans/plan-99.md" 2>&1)
      if echo "$OUTPUT" | grep -q "Chronicle stub created"; then
        echo "OK: intake chronicle created"
      else
        # Check dedup file
        DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-plan-$(date +%Y%m%d)"
        if [ -f "$DEDUP_FILE" ] && grep -q "plan:99-intake" "$DEDUP_FILE" 2>/dev/null; then
          echo "OK: intake chronicle created (verified via dedup)"
        else
          echo "FAIL: intake chronicle not created"
          echo "$OUTPUT"
          exit 1
        fi
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: plan-chronicle.sh fails open on unknown command
  - name: "fails_open_on_unknown_command"
    run: |
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plan-chronicle.sh" badcmd "plan:99" 2>&1
      echo "OK: exited 0 on unknown command"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: chronicle-validate.sh detects missing boundaries and creates fallbacks
  - name: "validate_creates_fallbacks_for_missing"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-plan-"*
      # Close any existing chronicles for plan:98 (clean slate)
      # Create a fresh plan with no chronicles
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-validate.sh" "plan:98" 2>&1)
      if echo "$OUTPUT" | grep -q "created"; then
        echo "OK: fallbacks created for missing boundaries"
      else
        echo "FAIL: expected fallback creation"
        echo "$OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: chronicle-validate.sh reports full coverage when all stubs exist
  - name: "validate_reports_full_coverage"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-plan-"*
      # Create all three boundary chronicles manually
      bd create --type task --priority 3 \
        --labels "ys:chronicle,ys:chronicle:auto,ys:topic:planning,plan:97" \
        --title "Chronicle (Auto): Plan plan:97 — save" \
        --description "test" --silent 2>/dev/null
      bd create --type task --priority 3 \
        --labels "ys:chronicle,ys:chronicle:auto,ys:topic:planning,plan:97" \
        --title "Chronicle (Auto): Plan plan:97 — start" \
        --description "test" --silent 2>/dev/null
      bd create --type task --priority 3 \
        --labels "ys:chronicle,ys:chronicle:auto,ys:topic:planning,plan:97" \
        --title "Chronicle (Auto): Plan plan:97 — complete" \
        --description "test" --silent 2>/dev/null
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-validate.sh" "plan:97" 2>&1)
      if echo "$OUTPUT" | grep -q "3/3 boundaries covered"; then
        echo "OK: full coverage reported"
      else
        echo "FAIL: expected 3/3 coverage"
        echo "$OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/.chronicle-plan-*"
  - "rm -f docs/plans/plan-99.md"
  - "chmod 755 .beads 2>/dev/null || true"
