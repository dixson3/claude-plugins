name: "Unit: archive-suggest.sh â€” commit scanner"

setup:
  - "mkdir -p .yoshiko-flow"
  - "git init . >/dev/null 2>&1 || true"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}'  > .yoshiko-flow/config.json"

steps:
  # Case 1: No commits found
  - name: "no_commits"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/archive-suggest.sh" --since "1 second ago" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "No commits found"; then
        echo "OK: reports no commits"
      else
        echo "FAIL: should report no commits"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Detects research keywords
  - name: "detects_research_keywords"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      # Create a commit with research keywords
      echo "test" > "$WORK_DIR/research-test.txt"
      cd "$WORK_DIR" && git add research-test.txt && git commit -m "Researched authentication libraries for Go" --allow-empty >/dev/null 2>&1
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/archive-suggest.sh" --since "5 minutes ago" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "Research activity detected"; then
        echo "OK: detected research keywords"
      else
        echo "FAIL: should detect research keywords"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Detects decision keywords
  - name: "detects_decision_keywords"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      echo "test2" > "$WORK_DIR/decision-test.txt"
      cd "$WORK_DIR" && git add decision-test.txt && git commit -m "Chose Redis for caching layer architecture" --allow-empty >/dev/null 2>&1
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/archive-suggest.sh" --since "5 minutes ago" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "Decision activity detected"; then
        echo "OK: detected decision keywords"
      else
        echo "FAIL: should detect decision keywords"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Script always exits 0
  - name: "always_exits_zero"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/archive-suggest.sh" --since "5 minutes ago" >/dev/null 2>&1
      echo "OK: exit code $?"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Script detects research keyword patterns
  - name: "detects_research_keyword_patterns"
    run: |
      SCRIPT="$PLUGIN_DIR/plugins/yf/scripts/archive-suggest.sh"
      # Verify script contains the research keyword patterns
      PATTERNS=0
      for kw in "research" "investigate" "evaluate" "compare" "analyze"; do
        grep -qi "$kw" "$SCRIPT" && PATTERNS=$((PATTERNS + 1))
      done
      echo "research_patterns=$PATTERNS"
      [ "$PATTERNS" -ge 3 ] && echo "OK: research keywords present"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: Script detects decision keyword patterns
  - name: "detects_decision_keyword_patterns"
    run: |
      SCRIPT="$PLUGIN_DIR/plugins/yf/scripts/archive-suggest.sh"
      PATTERNS=0
      for kw in "chose" "decided" "selected" "architecture" "approved"; do
        grep -qi "$kw" "$SCRIPT" && PATTERNS=$((PATTERNS + 1))
      done
      echo "decision_patterns=$PATTERNS"
      [ "$PATTERNS" -ge 3 ] && echo "OK: decision keywords present"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: Archive watch rule documents research and decision triggers
  - name: "archive_watch_rule_triggers"
    run: |
      RULE="$PLUGIN_DIR/plugins/yf/rules/yf-rules.md"
      R=$(grep -c 'research' "$RULE")
      D=$(grep -c 'decision' "$RULE")
      echo "research_triggers=$R decision_triggers=$D"
      [ "$R" -ge 1 ] && [ "$D" -ge 1 ] && echo "OK: both trigger types documented"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json research-test.txt decision-test.txt"
