name: "Unit: plan-prune.sh â€” automatic task pruning"

setup:
  - "git init"
  - "mkdir -p .yoshiko-flow/tasks docs/plans"
  - "echo '# test' > CLAUDE.md"
  - "git add -A && git commit -m 'init'"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}'  > .yoshiko-flow/config.json"

steps:
  # Case 1: Plan-scoped prune deletes closed tasks with plan label
  - name: "plan_prune_deletes_closed"
    run: |
      # Create a closed task with plan label
      cat > "$WORK_DIR/.yoshiko-flow/tasks/task-prune-001.json" << 'TASKJSON'
      {"id":"task-prune-001","type":"task","title":"Test task","status":"closed","labels":["plan:99"],"created":"2026-01-01T00:00:00Z"}
      TASKJSON
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/plan-prune.sh" plan "plan:99" 2>&1)
      echo "$OUTPUT"
      # Verify it was pruned (file should be gone)
      if [ ! -f "$WORK_DIR/.yoshiko-flow/tasks/task-prune-001.json" ]; then
        echo "OK: closed task pruned"
      else
        echo "FAIL: task still exists"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "Pruned"
      - type: output_contains
        value: "OK"

  # Case 2: Plan-scoped prune skips when on_plan_complete is false
  - name: "plan_prune_skips_when_disabled"
    run: |
      echo '{"enabled":true,"config":{"auto_prune":{"on_plan_complete":false}}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      cat > "$WORK_DIR/.yoshiko-flow/tasks/task-prune-002.json" << 'TASKJSON'
      {"id":"task-prune-002","type":"task","title":"Test task 2","status":"closed","labels":["plan:98"],"created":"2026-01-01T00:00:00Z"}
      TASKJSON
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/plan-prune.sh" plan "plan:98" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "disabled by config"; then
        echo "OK: skipped when disabled"
      else
        echo "FAIL: should have been disabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Plan-scoped prune handles empty result (no closed tasks)
  - name: "plan_prune_empty_result"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/plan-prune.sh" plan "plan:97" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "No closed tasks"; then
        echo "OK: handles empty"
      else
        echo "FAIL: unexpected output"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Global prune runs cleanup with configured threshold
  - name: "global_prune_runs_cleanup"
    run: |
      echo '{"enabled":true,"config":{"auto_prune":{"on_push":true,"older_than_days":14}}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/plan-prune.sh" global 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "Global prune"; then
        echo "OK: global prune ran"
      else
        echo "FAIL: global prune did not run"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Global prune skips when on_push is false
  - name: "global_prune_skips_when_disabled"
    run: |
      echo '{"enabled":true,"config":{"auto_prune":{"on_push":false}}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/plan-prune.sh" global 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "disabled by config"; then
        echo "OK: skipped when disabled"
      else
        echo "FAIL: should have been disabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: Both subcommands always exit 0 (fail-open)
  - name: "always_exit_zero"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      bash "$PLUGIN_DIR/plugins/yf/scripts/plan-prune.sh" plan "plan:00" 2>&1
      RC1=$?
      bash "$PLUGIN_DIR/plugins/yf/scripts/plan-prune.sh" global 2>&1
      RC2=$?
      bash "$PLUGIN_DIR/plugins/yf/scripts/plan-prune.sh" invalid 2>&1
      RC3=$?
      if [ "$RC1" -eq 0 ] && [ "$RC2" -eq 0 ] && [ "$RC3" -eq 0 ]; then
        echo "OK: all exit 0"
      else
        echo "FAIL: rc1=$RC1 rc2=$RC2 rc3=$RC3"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: --dry-run flag outputs without deleting
  - name: "dry_run_preview"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      # Create a closed task
      cat > "$WORK_DIR/.yoshiko-flow/tasks/task-prune-003.json" << 'TASKJSON'
      {"id":"task-prune-003","type":"task","title":"Dry run task","status":"closed","labels":["plan:96"],"created":"2026-01-01T00:00:00Z"}
      TASKJSON
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/plan-prune.sh" plan "plan:96" --dry-run 2>&1)
      echo "$OUTPUT"
      # Verify task still exists
      if [ -f "$WORK_DIR/.yoshiko-flow/tasks/task-prune-003.json" ] && echo "$OUTPUT" | grep -q "Dry run"; then
        echo "OK: dry run preserved task"
      else
        echo "FAIL: task was deleted or no dry run output"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: Config defaults work when no auto_prune key exists
  - name: "config_defaults"
    run: |
      echo '{"enabled":true}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      # With enabled=true but no auto_prune key, defaults should be enabled
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/plan-prune.sh" plan "plan:95" 2>&1)
      echo "$OUTPUT"
      # Should not say "disabled by config"
      if echo "$OUTPUT" | grep -q "disabled by config"; then
        echo "FAIL: should default to enabled"
        exit 1
      fi
      echo "OK: defaults to enabled"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
  - "rm -f .yoshiko-flow/tasks/task-prune-*"
