name: "Unit: plan-intake rule content"

setup:
  - "mkdir -p .claude/rules .yoshiko-flow"

steps:
  # Case 1: plan-intake.md source exists in yf plugin
  - name: "source_file_exists"
    run: |
      if [ -f "$PLUGIN_DIR/plugins/yf/rules/plan-intake.md" ]; then
        echo "OK: source exists"
      else
        echo "FAIL: source not found"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: plan_intake skill file exists
  - name: "skill_file_exists"
    run: |
      if [ -f "$PLUGIN_DIR/plugins/yf/skills/plan_intake/SKILL.md" ]; then
        echo "OK: skill file exists"
      else
        echo "FAIL: skill file not found"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Skill has user_invocable: true
  - name: "skill_is_user_invocable"
    run: |
      if grep -q "user_invocable: true" "$PLUGIN_DIR/plugins/yf/skills/plan_intake/SKILL.md"; then
        echo "OK: skill is user_invocable"
      else
        echo "FAIL: skill not user_invocable"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Rule references /yf:plan_intake skill
  - name: "rule_references_skill"
    run: |
      if grep -q '/yf:plan_intake' "$PLUGIN_DIR/plugins/yf/rules/plan-intake.md"; then
        echo "OK: rule references skill"
      else
        echo "FAIL: rule does not reference skill"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Rule contains key detection triggers
  - name: "has_detection_section"
    run: |
      if grep -q "## Detection" "$PLUGIN_DIR/plugins/yf/rules/plan-intake.md"; then
        echo "OK: detection section present"
      else
        echo "FAIL: missing detection section"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Rule references plan_create_beads
  - name: "references_plan_create_beads"
    run: |
      if grep -q "plan_create_beads" "$PLUGIN_DIR/plugins/yf/rules/plan-intake.md"; then
        echo "OK: references plan_create_beads"
      else
        echo "FAIL: missing plan_create_beads reference"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Rule references plan_execute
  - name: "references_plan_execute"
    run: |
      if grep -q "plan_execute" "$PLUGIN_DIR/plugins/yf/rules/plan-intake.md"; then
        echo "OK: references plan_execute"
      else
        echo "FAIL: missing plan_execute reference"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Rule references yf capture
  - name: "references_chronicle_capture"
    run: |
      if grep -q "yf:chronicle_capture" "$PLUGIN_DIR/plugins/yf/rules/plan-intake.md"; then
        echo "OK: references yf:chronicle_capture"
      else
        echo "FAIL: missing yf:chronicle_capture reference"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: Rule has non-triggers section
  - name: "has_non_triggers"
    run: |
      if grep -q "## Non-Triggers" "$PLUGIN_DIR/plugins/yf/rules/plan-intake.md"; then
        echo "OK: non-triggers section present"
      else
        echo "FAIL: missing non-triggers section"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: Rule is in preflight.json artifacts
  - name: "in_artifact_manifest"
    run: |
      if jq -e '.artifacts.rules[] | select(.source == "rules/plan-intake.md")' "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json" >/dev/null 2>&1; then
        echo "OK: in artifact manifest"
      else
        echo "FAIL: not in artifact manifest"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: Preflight syncs the rule
  - name: "preflight_syncs_rule"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json" "$WORK_DIR/.yoshiko-flow/lock.json"
      rm -rf "$WORK_DIR/.claude/rules/yf"
      mkdir -p "$WORK_DIR/.claude/rules" "$WORK_DIR/docs/plans" "$WORK_DIR/docs/diary"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if [ -f "$WORK_DIR/.claude/rules/yf/plan-intake.md" ]; then
        echo "OK: rule synced by preflight"
      else
        echo "FAIL: rule not synced"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "plan-intake.md"
      - type: output_contains
        value: "OK"

  # Case 9: beads.md contains chronicle capture step
  - name: "beads_has_chronicle_step"
    run: |
      if grep -q "yf:chronicle_capture topic:session-close" "$PLUGIN_DIR/plugins/yf/rules/beads.md"; then
        echo "OK: BEADS.md has chronicle capture step"
      else
        echo "FAIL: BEADS.md missing chronicle capture"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: plan_execute has chronicle capture on completion
  - name: "plan_execute_has_chronicle_capture"
    run: |
      if grep -q "yf:chronicle_capture topic:completion" "$PLUGIN_DIR/plugins/yf/skills/plan_execute/SKILL.md"; then
        echo "OK: plan_execute has chronicle capture"
      else
        echo "FAIL: plan_execute missing chronicle capture"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 11: plan_execute has diary generation on completion
  - name: "plan_execute_has_diary_generation"
    run: |
      if grep -q "yf:chronicle_diary" "$PLUGIN_DIR/plugins/yf/skills/plan_execute/SKILL.md"; then
        echo "OK: plan_execute has diary generation"
      else
        echo "FAIL: plan_execute missing diary generation"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 12: BEADS.md has diary generation step
  - name: "beads_has_diary_step"
    run: |
      if grep -q "yf:chronicle_diary" "$PLUGIN_DIR/plugins/yf/rules/beads.md"; then
        echo "OK: BEADS.md has diary generation step"
      else
        echo "FAIL: BEADS.md missing diary generation"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json .yoshiko-flow/lock.json"
