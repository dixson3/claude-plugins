name: "Unit: code-gate.sh tasks safety net"

setup:
  - "mkdir -p .claude .yoshiko-flow/tasks docs/plans"
  - "rm -f .yoshiko-flow/plan-gate .yoshiko-flow/plan-intake-skip .yoshiko-flow/.tasks-check-cache"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}'  > .yoshiko-flow/config.json"

steps:
  # Case 1: No plan files → no block, exits 0
  - name: "no_plans_no_block"
    run: |
      rm -f .yoshiko-flow/.tasks-check-cache .yoshiko-flow/plan-intake-skip
      rm -f docs/plans/plan-*.md
      OUTPUT=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1)
      EXIT=$?
      echo "$OUTPUT"
      if [ "$EXIT" -ne 0 ]; then
        echo "FAIL: unexpected non-zero exit ($EXIT)"
        exit 1
      fi
      echo "OK: no block"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Plan file with tasks → no block
  - name: "plan_with_tasks_no_block"
    run: |
      rm -f .yoshiko-flow/.tasks-check-cache .yoshiko-flow/plan-intake-skip
      printf '# Plan 99\n**Status:** Draft' > docs/plans/plan-99.md
      # Create an epic task for plan:99
      cat > "$WORK_DIR/.yoshiko-flow/tasks/task-gate-001.json" << 'TASKJSON'
      {"id":"task-gate-001","type":"epic","title":"Test Epic","status":"open","labels":["plan:99"],"created":"2026-01-01T00:00:00Z"}
      TASKJSON
      OUTPUT=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1)
      EXIT=$?
      echo "$OUTPUT"
      if [ "$EXIT" -ne 0 ]; then
        echo "FAIL: unexpected non-zero exit ($EXIT)"
        exit 1
      fi
      echo "OK: no block"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Plan file without tasks → BLOCKED (exit 2)
  - name: "plan_without_tasks_blocks"
    run: |
      rm -f .yoshiko-flow/.tasks-check-cache .yoshiko-flow/plan-intake-skip
      printf '# Plan 99\n**Status:** Draft' > docs/plans/plan-99.md
      # Remove all task files for plan:99
      rm -f "$WORK_DIR/.yoshiko-flow/tasks/task-gate-"*
      OUTPUT=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1 || true)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "BLOCKED"; then
        echo "OK: blocked as expected"
      else
        echo "FAIL: expected BLOCKED"
        exit 1
      fi
    assertions:
      - type: output_contains
        value: "BLOCKED"
      - type: output_contains
        value: "yf:plan_intake"

  # Case 4: Completed plan → no block
  - name: "completed_plan_no_block"
    run: |
      rm -f .yoshiko-flow/.tasks-check-cache .yoshiko-flow/plan-intake-skip
      printf '# Plan 99\n**Status: Completed**' > docs/plans/plan-99.md
      OUTPUT=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1)
      EXIT=$?
      echo "$OUTPUT"
      if [ "$EXIT" -ne 0 ]; then
        echo "FAIL: unexpected non-zero exit ($EXIT)"
        exit 1
      fi
      echo "OK: no block for completed plan"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Escape hatch (plan-intake-skip) bypasses block
  - name: "escape_hatch_bypasses_block"
    run: |
      rm -f .yoshiko-flow/.tasks-check-cache
      printf '# Plan 99\n**Status:** Draft' > docs/plans/plan-99.md
      touch .yoshiko-flow/plan-intake-skip
      # No task files for plan:99
      rm -f "$WORK_DIR/.yoshiko-flow/tasks/task-gate-"*
      OUTPUT=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1)
      EXIT=$?
      echo "$OUTPUT"
      if [ "$EXIT" -ne 0 ]; then
        echo "FAIL: escape hatch did not bypass block"
        exit 1
      fi
      echo "OK: escape hatch bypassed"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: Gate active takes priority over intake check (gate blocks, no intake check)
  - name: "gate_takes_priority"
    run: |
      rm -f .yoshiko-flow/.tasks-check-cache .yoshiko-flow/plan-intake-skip
      printf '# Plan 99\n**Status:** Draft' > docs/plans/plan-99.md
      echo "99" > .yoshiko-flow/plan-gate
      OUTPUT=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1 || true)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "BLOCKED"; then
        echo "OK: gate blocks as expected"
      else
        echo "FAIL: gate did not block"
        exit 1
      fi
    assertions:
      - type: output_contains
        value: "BLOCKED"

  # Case 7: Exempt file (docs/plans/*) allowed even when plan has no tasks
  - name: "exempt_file_allowed"
    run: |
      rm -f .yoshiko-flow/.tasks-check-cache .yoshiko-flow/plan-intake-skip
      printf '# Plan 99\n**Status:** Draft' > docs/plans/plan-99.md
      # No task files for plan:99
      rm -f "$WORK_DIR/.yoshiko-flow/tasks/task-gate-"*
      OUTPUT=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/docs/plans/plan-99.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1)
      EXIT=$?
      echo "$OUTPUT"
      if [ "$EXIT" -ne 0 ]; then
        echo "FAIL: exempt file was blocked"
        exit 1
      fi
      echo "OK: exempt file allowed"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: Cache TTL — second check within 60s uses cached result
  - name: "cache_ttl_respected"
    run: |
      rm -f .yoshiko-flow/.tasks-check-cache .yoshiko-flow/plan-intake-skip .yoshiko-flow/plan-gate
      printf '# Plan 99\n**Status:** Draft' > docs/plans/plan-99.md
      # Prime the cache with a "skip" result
      printf '%s\nskip\n' "$(date '+%s')" > .yoshiko-flow/.tasks-check-cache
      # Even with no task files, should use cache and not block
      OUTPUT=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1)
      EXIT=$?
      echo "$OUTPUT"
      if [ "$EXIT" -ne 0 ]; then
        echo "FAIL: cache was not used (exit $EXIT)"
        exit 1
      fi
      echo "OK: cache TTL respected"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: Completed plan with no tasks (post-prune) → no block
  - name: "completed_plan_no_tasks_no_block"
    run: |
      rm -f .yoshiko-flow/.tasks-check-cache .yoshiko-flow/plan-intake-skip
      printf '# Plan 99\n**Status: Completed**' > docs/plans/plan-99.md
      # No task files — simulates post-prune state
      rm -f "$WORK_DIR/.yoshiko-flow/tasks/task-gate-"*
      OUTPUT=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1)
      EXIT=$?
      echo "$OUTPUT"
      if [ "$EXIT" -ne 0 ]; then
        echo "FAIL: completed plan with no tasks should not block ($EXIT)"
        exit 1
      fi
      echo "OK: completed plan with no tasks allowed"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: Active plan with no tasks blocks, then Completed clears block
  - name: "active_blocks_then_completed_clears"
    run: |
      rm -f .yoshiko-flow/.tasks-check-cache .yoshiko-flow/plan-intake-skip
      printf '# Plan 99\n**Status:** Active' > docs/plans/plan-99.md
      rm -f "$WORK_DIR/.yoshiko-flow/tasks/task-gate-"*
      # First check: Active + no tasks → should block
      OUTPUT1=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1 || true)
      echo "$OUTPUT1"
      if ! echo "$OUTPUT1" | grep -q "BLOCKED"; then
        echo "FAIL: expected BLOCKED for Active plan with no tasks"
        exit 1
      fi
      # Now update status to Completed (simulates plan-exec.sh fix)
      rm -f .yoshiko-flow/.tasks-check-cache
      printf '# Plan 99\n**Status: Completed**' > docs/plans/plan-99.md
      # Second check: Completed + no tasks → should allow
      OUTPUT2=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1)
      EXIT2=$?
      echo "$OUTPUT2"
      if [ "$EXIT2" -ne 0 ]; then
        echo "FAIL: Completed plan should not block ($EXIT2)"
        exit 1
      fi
      echo "OK: Active blocked then Completed cleared"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "BLOCKED"
      - type: output_contains
        value: "OK: Active blocked then Completed cleared"

teardown:
  - "rm -f .yoshiko-flow/plan-gate .yoshiko-flow/plan-intake-skip .yoshiko-flow/.tasks-check-cache docs/plans/plan-99.md"
  - "rm -f .yoshiko-flow/tasks/task-gate-*"
