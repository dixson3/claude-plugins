name: "Unit: yf-config.sh — config reading"

setup:
  - "mkdir -p .claude/rules .yoshiko-flow docs/plans docs/diary"

steps:
  # Case 1: Missing config → defaults to disabled (fail-closed, DD-015)
  - name: "missing_defaults_disabled"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_enabled; then
        echo "FAIL: should default to disabled (no config = inactive)"
        exit 1
      else
        echo "OK: defaults to disabled"
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Reads config values
  - name: "reads_config"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      MERGED=$(yf_merged_config)
      ENABLED=$(echo "$MERGED" | jq -r '.enabled')
      ART_DIR=$(echo "$MERGED" | jq -r '.config.artifact_dir')
      if [ "$ENABLED" = "true" ] && [ "$ART_DIR" = "docs" ]; then
        echo "OK: reads config"
      else
        echo "FAIL: enabled=$ENABLED artifact_dir=$ART_DIR"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Disabled config detected
  - name: "disabled_detected"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":false,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_enabled; then
        echo "FAIL: should be disabled"
        exit 1
      fi
      echo "OK: disabled detected"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Malformed config -- fail-open on jq parse (two-condition gate)
  - name: "malformed_failopen"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo 'NOT VALID JSON!!!' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      # With malformed JSON: config exists (pass condition 1), jq fails so
      # val is empty and not "false" (pass condition 2) => enabled (fail-open on parse errors).
      if yf_is_enabled; then
        echo "OK: fail-open on malformed config"
      else
        echo "FAIL: should fail-open when config exists but is malformed"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: yf_read_field works
  - name: "read_field"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":true,"config":{"artifact_dir":"output"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      VAL=$(yf_read_field '.config.artifact_dir')
      if [ "$VAL" = "output" ]; then
        echo "OK: read_field returns value"
      else
        echo "FAIL: expected 'output', got '$VAL'"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: yf_config_exists
  - name: "config_exists_check"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_config_exists; then
        echo "FAIL: should not exist when missing"
        exit 1
      fi
      echo '{}' > "$WORK_DIR/.yoshiko-flow/config.json"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_config_exists; then
        echo "OK: exists when yf.json present"
      else
        echo "FAIL: should exist"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: prune_on_complete defaults to enabled
  - name: "prune_on_complete_default"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_complete; then
        echo "OK: defaults to enabled"
      else
        echo "FAIL: should default to enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: prune_on_complete disabled
  - name: "prune_on_complete_disabled"
    run: |
      echo '{"enabled":true,"config":{"auto_prune":{"on_plan_complete":false}}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_complete; then
        echo "FAIL: should be disabled"
        exit 1
      fi
      echo "OK: prune on complete disabled"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: prune_on_push defaults to enabled
  - name: "prune_on_push_default"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_push; then
        echo "OK: defaults to enabled"
      else
        echo "FAIL: should default to enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: prune_on_push disabled
  - name: "prune_on_push_disabled"
    run: |
      echo '{"enabled":true,"config":{"auto_prune":{"on_push":false}}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_push; then
        echo "FAIL: should be disabled"
        exit 1
      fi
      echo "OK: prune on push disabled"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 11: yf_is_enabled — two conditions all met (config exists + enabled)
  - name: "enabled_two_conditions"
    run: |
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_enabled; then
        echo "OK: enabled with both conditions"
      else
        echo "FAIL: should be enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 12: yf_merged_config returns base config when no local file (was Case 14)
  - name: "merged_config_base_only"
    run: |
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/config.local.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      MERGED=$(yf_merged_config)
      ART_DIR=$(echo "$MERGED" | jq -r '.config.artifact_dir')
      OPERATOR=$(echo "$MERGED" | jq -r '.config.operator // "null"')
      if [ "$ART_DIR" = "docs" ] && [ "$OPERATOR" = "null" ]; then
        echo "OK: base config only, no operator"
      else
        echo "FAIL: artifact_dir=$ART_DIR operator=$OPERATOR"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 15: yf_merged_config deep-merges local over base
  - name: "merged_config_local_overlay"
    run: |
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"config":{"operator":"Test User"}}' > "$WORK_DIR/.yoshiko-flow/config.local.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      MERGED=$(yf_merged_config)
      ART_DIR=$(echo "$MERGED" | jq -r '.config.artifact_dir')
      OPERATOR=$(echo "$MERGED" | jq -r '.config.operator')
      if [ "$ART_DIR" = "docs" ] && [ "$OPERATOR" = "Test User" ]; then
        echo "OK: local overlay merged (operator from local, artifact_dir from base)"
      else
        echo "FAIL: artifact_dir=$ART_DIR operator=$OPERATOR"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 16: yf_operator_name returns config value when set in local config
  - name: "operator_name_from_config"
    run: |
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"config":{"operator":"Jane Operator"}}' > "$WORK_DIR/.yoshiko-flow/config.local.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      NAME=$(yf_operator_name)
      if [ "$NAME" = "Jane Operator" ]; then
        echo "OK: operator from local config"
      else
        echo "FAIL: expected 'Jane Operator', got '$NAME'"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 17: yf_operator_name falls back to non-empty value when config field missing
  - name: "operator_name_fallback"
    run: |
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/config.local.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      unset CLAUDE_PLUGIN_ROOT
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      NAME=$(yf_operator_name)
      if [ -n "$NAME" ]; then
        echo "OK: operator fallback returned '$NAME'"
      else
        echo "FAIL: operator name is empty"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
  - "rm -f .yoshiko-flow/config.local.json"
  - "rm -rf fakehome"
