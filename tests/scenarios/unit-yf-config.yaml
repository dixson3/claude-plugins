name: "Unit: yf-config.sh — config reading"

setup:
  - "mkdir -p .claude/rules .yoshiko-flow docs/plans docs/diary"

steps:
  # Case 1: Missing config → defaults to disabled (fail-closed, DD-015)
  - name: "missing_defaults_disabled"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_enabled; then
        echo "FAIL: should default to disabled (no config = inactive)"
        exit 1
      else
        echo "OK: defaults to disabled"
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Reads config values
  - name: "reads_config"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      MERGED=$(yf_merged_config)
      ENABLED=$(echo "$MERGED" | jq -r '.enabled')
      ART_DIR=$(echo "$MERGED" | jq -r '.config.artifact_dir')
      if [ "$ENABLED" = "true" ] && [ "$ART_DIR" = "docs" ]; then
        echo "OK: reads config"
      else
        echo "FAIL: enabled=$ENABLED artifact_dir=$ART_DIR"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Disabled config detected
  - name: "disabled_detected"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":false,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_enabled; then
        echo "FAIL: should be disabled"
        exit 1
      fi
      echo "OK: disabled detected"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Malformed config -- fail-open on jq parse but requires beads
  - name: "malformed_failopen"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo 'NOT VALID JSON!!!' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      # With malformed JSON: config exists (pass condition 1), jq fails so
      # val is empty and not "false" (pass condition 2), then checks beads.
      # If bd is available, this returns enabled (fail-open on parse errors).
      if command -v bd >/dev/null 2>&1; then
        if yf_is_enabled; then
          echo "OK: fail-open on malformed (beads available)"
        else
          echo "FAIL: should fail-open when beads available"
          exit 1
        fi
      else
        echo "OK: skipped (bd not available)"
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: yf_read_field works
  - name: "read_field"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":true,"config":{"artifact_dir":"output"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      VAL=$(yf_read_field '.config.artifact_dir')
      if [ "$VAL" = "output" ]; then
        echo "OK: read_field returns value"
      else
        echo "FAIL: expected 'output', got '$VAL'"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: yf_config_exists
  - name: "config_exists_check"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_config_exists; then
        echo "FAIL: should not exist when missing"
        exit 1
      fi
      echo '{}' > "$WORK_DIR/.yoshiko-flow/config.json"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_config_exists; then
        echo "OK: exists when yf.json present"
      else
        echo "FAIL: should exist"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: prune_on_complete defaults to enabled
  - name: "prune_on_complete_default"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_complete; then
        echo "OK: defaults to enabled"
      else
        echo "FAIL: should default to enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: prune_on_complete disabled
  - name: "prune_on_complete_disabled"
    run: |
      echo '{"enabled":true,"config":{"auto_prune":{"on_plan_complete":false}}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_complete; then
        echo "FAIL: should be disabled"
        exit 1
      fi
      echo "OK: prune on complete disabled"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: prune_on_push defaults to enabled
  - name: "prune_on_push_default"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_push; then
        echo "OK: defaults to enabled"
      else
        echo "FAIL: should default to enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: prune_on_push disabled
  - name: "prune_on_push_disabled"
    run: |
      echo '{"enabled":true,"config":{"auto_prune":{"on_push":false}}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_push; then
        echo "FAIL: should be disabled"
        exit 1
      fi
      echo "OK: prune on push disabled"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 11: yf_is_enabled — three conditions all met
  - name: "enabled_three_conditions"
    run: |
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if command -v bd >/dev/null 2>&1; then
        if yf_is_enabled; then
          echo "OK: enabled with all three conditions"
        else
          echo "FAIL: should be enabled"
          exit 1
        fi
      else
        echo "OK: skipped (bd not available)"
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 12: yf_is_enabled — config exists, enabled, no beads → disabled
  - name: "enabled_no_beads_disabled"
    run: |
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      # Override HOME and PATH to hide beads
      if HOME="$WORK_DIR/fakehome" PATH="/usr/bin:/bin" yf_is_enabled; then
        echo "FAIL: should be disabled without beads"
        exit 1
      fi
      echo "OK: disabled without beads"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 13: yf_bd_available function and alias
  - name: "bd_available_function"
    run: |
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      # Test yf_bd_available with bd in PATH
      if command -v bd >/dev/null 2>&1; then
        if yf_bd_available; then
          echo "OK: yf_bd_available found bd"
        else
          echo "FAIL: should find bd"
          exit 1
        fi
        # yf_bd_available already verified above
      else
        echo "OK: skipped (bd not in test env)"
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
  - "rm -rf fakehome"
