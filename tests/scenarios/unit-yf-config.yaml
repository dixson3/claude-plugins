name: "Unit: yf-config.sh — config reading"

setup:
  - "mkdir -p .claude/rules .yoshiko-flow docs/plans docs/diary"

steps:
  # Case 1: Missing config → defaults to enabled
  - name: "missing_defaults_enabled"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_enabled; then
        echo "OK: defaults to enabled"
      else
        echo "FAIL: should default to enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Reads config values
  - name: "reads_config"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":true,"config":{"artifact_dir":"docs","chronicler_enabled":true}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      MERGED=$(yf_merged_config)
      ENABLED=$(echo "$MERGED" | jq -r '.enabled')
      ART_DIR=$(echo "$MERGED" | jq -r '.config.artifact_dir')
      if [ "$ENABLED" = "true" ] && [ "$ART_DIR" = "docs" ]; then
        echo "OK: reads config"
      else
        echo "FAIL: enabled=$ENABLED artifact_dir=$ART_DIR"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Disabled config detected
  - name: "disabled_detected"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":false,"config":{"artifact_dir":"docs","chronicler_enabled":false}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_enabled; then
        echo "FAIL: should be disabled"
        exit 1
      fi
      echo "OK: disabled detected"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Chronicler disabled detected
  - name: "chronicler_disabled"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":true,"config":{"chronicler_enabled":false}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_chronicler_on; then
        echo "FAIL: chronicler should be disabled"
        exit 1
      fi
      echo "OK: chronicler disabled"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Malformed config → fail-open
  - name: "malformed_failopen"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo 'NOT VALID JSON!!!' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_enabled; then
        echo "OK: fail-open on malformed"
      else
        echo "FAIL: should fail-open"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: yf_read_field works
  - name: "read_field"
    run: |
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":true,"config":{"artifact_dir":"output"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      VAL=$(yf_read_field '.config.artifact_dir')
      if [ "$VAL" = "output" ]; then
        echo "OK: read_field returns value"
      else
        echo "FAIL: expected 'output', got '$VAL'"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: yf_config_exists
  - name: "config_exists_check"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_config_exists; then
        echo "FAIL: should not exist when missing"
        exit 1
      fi
      echo '{}' > "$WORK_DIR/.yoshiko-flow/config.json"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_config_exists; then
        echo "OK: exists when yf.json present"
      else
        echo "FAIL: should exist"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: prune_on_complete defaults to enabled
  - name: "prune_on_complete_default"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_complete; then
        echo "OK: defaults to enabled"
      else
        echo "FAIL: should default to enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: prune_on_complete disabled
  - name: "prune_on_complete_disabled"
    run: |
      echo '{"enabled":true,"config":{"auto_prune":{"on_plan_complete":false}}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_complete; then
        echo "FAIL: should be disabled"
        exit 1
      fi
      echo "OK: prune on complete disabled"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: prune_on_push defaults to enabled
  - name: "prune_on_push_default"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_push; then
        echo "OK: defaults to enabled"
      else
        echo "FAIL: should default to enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 11: prune_on_push disabled
  - name: "prune_on_push_disabled"
    run: |
      echo '{"enabled":true,"config":{"auto_prune":{"on_push":false}}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_prune_on_push; then
        echo "FAIL: should be disabled"
        exit 1
      fi
      echo "OK: prune on push disabled"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
