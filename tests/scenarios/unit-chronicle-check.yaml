name: "Unit: chronicle-check.sh — auto-draft chronicle entries"

setup:
  - "mkdir -p .yoshiko-flow/tasks .yoshiko-flow/chronicler"
  - "git init . >/dev/null 2>&1 || true"
  - "git config user.email 'test@test.com' && git config user.name 'Test'"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}'  > .yoshiko-flow/config.json"

steps:
  # Case 1: Exits cleanly when yf disabled
  - name: "exits_when_yf_disabled"
    run: |
      echo '{"enabled":false}' > "$WORK_DIR/.yoshiko-flow/config.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-check.sh" check 2>&1)
      EXIT_CODE=$?
      if [ "$EXIT_CODE" -eq 0 ] && [ -z "$OUTPUT" ]; then
        echo "OK: exits silently when yf disabled"
      else
        echo "FAIL: should exit 0 silently (exit=$EXIT_CODE, output=$OUTPUT)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: No significant changes — no drafts
  - name: "no_significant_changes"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-drafted-"*
      # Create a trivial commit with no significant patterns or keywords
      echo "trivial" > "$WORK_DIR/trivial.txt"
      cd "$WORK_DIR" && git add trivial.txt && git commit -m "trivial change" >/dev/null 2>&1
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-check.sh" pre-push --since "5 minutes ago" 2>&1)
      EXIT_CODE=$?
      echo "$OUTPUT"
      if [ "$EXIT_CODE" -eq 0 ] && echo "$OUTPUT" | grep -q "no candidates"; then
        echo "OK: no candidates reported"
      else
        echo "FAIL: should report no candidates (exit=$EXIT_CODE)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Keyword matches in commits trigger draft creation
  - name: "keyword_matches_create_draft"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-drafted-"*
      echo "keyword-test" > "$WORK_DIR/keyword-test.txt"
      cd "$WORK_DIR" && git add keyword-test.txt && git commit -m "Decided on new architecture pattern for plugins" >/dev/null 2>&1
      # chronicle-check.sh now creates task files directly via yft_create
      # Check for chronicle files created after the run
      BEFORE_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-check.sh" pre-push --since "5 minutes ago" 2>&1)
      EXIT_CODE=$?
      echo "$OUTPUT"
      AFTER_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      if [ "$AFTER_COUNT" -gt "$BEFORE_COUNT" ]; then
        # Verify the created file has chronicle labels
        LATEST=$(ls -t "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | head -1)
        if [ -f "$LATEST" ] && jq -r '.labels[]' "$LATEST" 2>/dev/null | grep -q "ys:chronicle"; then
          echo "OK: draft task created with correct labels"
        else
          echo "FAIL: task file missing or labels wrong"
          exit 1
        fi
      else
        # Check dedup file as backup
        DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-drafted-$(date +%Y%m%d)"
        if [ -f "$DEDUP_FILE" ]; then
          echo "OK: draft created (verified via dedup file)"
        else
          echo "FAIL: no draft created"
          exit 1
        fi
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Significant file changes trigger draft creation
  - name: "significant_files_create_draft"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-drafted-"*
      # Remove previous chronicle files to get clean count
      rm -f "$WORK_DIR/.yoshiko-flow/chronicler/"*.json
      mkdir -p "$WORK_DIR/plugins/test"
      echo "sig-file" > "$WORK_DIR/plugins/test/sig.txt"
      cd "$WORK_DIR" && git add plugins/test/sig.txt && git commit -m "update test file" >/dev/null 2>&1
      BEFORE_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-check.sh" pre-push --since "5 minutes ago" 2>&1)
      EXIT_CODE=$?
      echo "$OUTPUT"
      AFTER_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      if [ "$AFTER_COUNT" -gt "$BEFORE_COUNT" ]; then
        echo "OK: draft created for significant file changes"
      else
        DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-drafted-$(date +%Y%m%d)"
        if [ -f "$DEDUP_FILE" ]; then
          echo "OK: draft created (verified via dedup)"
        else
          echo "FAIL: no draft created for significant file changes"
          exit 1
        fi
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Dedup — second run does not create duplicate drafts
  - name: "dedup_prevents_duplicates"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      # Dedup file should already exist from previous test
      BEFORE_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-check.sh" pre-push --since "5 minutes ago" 2>&1)
      EXIT_CODE=$?
      echo "$OUTPUT"
      AFTER_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      if echo "$OUTPUT" | grep -q "already drafted"; then
        echo "OK: dedup prevented duplicate"
      elif [ "$AFTER_COUNT" -eq "$BEFORE_COUNT" ]; then
        echo "OK: dedup prevented duplicate (no new task files)"
      else
        echo "FAIL: should not create duplicate drafts"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: In-progress tasks trigger draft creation (even without commits)
  - name: "in_progress_tasks_create_draft"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-drafted-"*
      rm -f "$WORK_DIR/.yoshiko-flow/chronicler/"*.json
      # Create an in-progress task
      cat > "$WORK_DIR/.yoshiko-flow/tasks/task-chk-001.json" << 'TASKJSON'
      {"id":"task-chk-001","type":"task","title":"Implement feature X","status":"in_progress","labels":[],"created":"2026-01-01T00:00:00Z"}
      TASKJSON
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-check.sh" pre-push --since "5 minutes ago" 2>&1)
      EXIT_CODE=$?
      echo "$OUTPUT"
      CHRON_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      if [ "$CHRON_COUNT" -gt 0 ] && echo "$OUTPUT" | grep -q "in-progress"; then
        echo "OK: draft task created with in-progress tasks detection"
      else
        DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-drafted-$(date +%Y%m%d)"
        if [ -f "$DEDUP_FILE" ] && grep -q "in-progress" "$DEDUP_FILE" 2>/dev/null; then
          echo "OK: draft created (verified via dedup)"
        else
          echo "FAIL: no draft created for in-progress tasks"
          exit 1
        fi
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: In-progress tasks dedup works
  - name: "in_progress_tasks_dedup"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      BEFORE_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      # Dedup file from case 6 should exist
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-check.sh" pre-push --since "1 second ago" 2>&1)
      AFTER_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      if [ "$AFTER_COUNT" -eq "$BEFORE_COUNT" ]; then
        echo "OK: dedup prevented duplicate for in-progress tasks"
      else
        echo "FAIL: should not create duplicate"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: Always exits 0
  - name: "always_exits_zero"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-check.sh" check --since "5 minutes ago" >/dev/null 2>&1
      echo "OK: exit code $?"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: Chronicle worthiness rule includes implementation adjustment triggers
  - name: "rule_has_implementation_adjustment_triggers"
    run: |
      grep -q 'implementation adjustments\|Implementation' "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md" && echo "OK: has implementation adjustment trigger"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: Chronicle worthiness rule includes swarm execution event triggers
  - name: "rule_has_swarm_execution_triggers"
    run: |
      grep -q 'swarm events\|swarm' "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md" && echo "OK: has swarm execution trigger"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 11: Chronicle worthiness rule includes plan compliance adjustment triggers
  - name: "rule_has_plan_compliance_triggers"
    run: |
      grep -q 'plan compliance\|plan' "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md" && echo "OK: has plan compliance trigger"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 12: swarm_react skill contains chronicle auto-capture content (delegated from rules)
  - name: "swarm_chronicle_bridge_in_rules"
    run: |
      grep -q 'reactive bugfix.*chronicle\|auto-capture.*chronicle\|chronicle.*auto' "$PLUGIN_DIR/plugins/yf/skills/swarm_react/SKILL.md" && echo "OK: swarm-chronicle-bridge content in swarm_react skill"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 13: Swarm chronicle bridge fires automatically (not advisory) in swarm_react skill
  - name: "swarm_chronicle_bridge_auto_fires"
    run: |
      grep -q 'NOT advisory\|fires automatically\|Auto-Capture Chronicle' "$PLUGIN_DIR/plugins/yf/skills/swarm_react/SKILL.md" && echo "OK: bridge fires automatically"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 14: swarm_react has Step 4.5 for chronicle auto-capture
  - name: "swarm_react_has_chronicle_step"
    run: |
      grep -q 'Step 4.5.*Chronicle\|Auto-Capture Chronicle' "$PLUGIN_DIR/plugins/yf/skills/swarm_react/SKILL.md" && echo "OK: swarm_react has chronicle step"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 15: Reduced frequency threshold for new categories
  - name: "reduced_frequency_for_new_categories"
    run: |
      grep -q '10-15 min\|15-20 min' "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md" && echo "OK: reduced frequency for new categories"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
  - "rm -rf .yoshiko-flow/.chronicle-drafted-* .yoshiko-flow/chronicler/*.json .yoshiko-flow/tasks/task-chk-*"
  - "rm -f trivial.txt keyword-test.txt"
  - "rm -rf plugins/test"
