name: "Unit: beads-setup.sh — doctor-driven repair"

steps:
  # Case 1: bd not available → skip
  - name: "bd_not_available"
    run: |
      # Strip bd from PATH
      CLEAN_PATH=$(echo "$PATH" | tr ':' '\n' | grep -v homebrew | tr '\n' ':')
      OUTPUT=$(PATH="$CLEAN_PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh" 2>&1)
      if echo "$OUTPUT" | grep -q "skip"; then
        echo "OK: skipped when bd not available"
      else
        echo "FAIL: expected skip, got: $OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: not a git repo → skip
  - name: "not_git_repo"
    run: |
      TMPDIR=$(mktemp -d)
      OUTPUT=$(CLAUDE_PROJECT_DIR="$TMPDIR" bash "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh" 2>&1)
      rm -rf "$TMPDIR"
      if echo "$OUTPUT" | grep -q "skip"; then
        echo "OK: skipped in non-git directory"
      else
        echo "FAIL: expected skip, got: $OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: fail-open — always exit 0 even with errors
  - name: "fail_open"
    run: |
      # Run in a non-existent directory (edge case)
      OUTPUT=$(CLAUDE_PROJECT_DIR="/nonexistent/path" bash "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh" 2>&1)
      EXIT=$?
      if [ "$EXIT" -eq 0 ]; then
        echo "OK: exit 0 even with bad project dir"
      else
        echo "FAIL: exit $EXIT, expected 0"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: script is executable
  - name: "script_executable"
    run: |
      if [ -x "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh" ]; then
        echo "OK: beads-setup.sh is executable"
      else
        echo "FAIL: beads-setup.sh is not executable"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: script sources yf-config.sh (uses yf_bd_available)
  - name: "sources_yf_config"
    run: |
      if grep -q 'yf-config.sh' "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh"; then
        echo "OK: sources yf-config.sh"
      else
        echo "FAIL: does not source yf-config.sh"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: script checks for stale metadata.json
  - name: "checks_stale_metadata"
    run: |
      if grep -q '\.db"' "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh"; then
        echo "OK: checks for stale .db references in metadata"
      else
        echo "FAIL: does not check for stale metadata"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: script normalizes database name
  - name: "normalizes_db_name"
    run: |
      if grep -q 'bd dolt set database beads' "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh"; then
        echo "OK: normalizes database name to beads"
      else
        echo "FAIL: does not normalize database name"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: script sets no-git-ops
  - name: "sets_no_git_ops"
    run: |
      if grep -q 'bd config set no-git-ops true' "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh"; then
        echo "OK: sets no-git-ops=true"
      else
        echo "FAIL: does not set no-git-ops"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: script uninstalls hooks
  - name: "uninstalls_hooks"
    run: |
      if grep -q 'bd hooks uninstall' "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh"; then
        echo "OK: uninstalls hooks"
      else
        echo "FAIL: does not uninstall hooks"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: script emits BEADS_SETUP_FAILED on unresolved must-fix
  - name: "emits_setup_failed"
    run: |
      if grep -q 'BEADS_SETUP_FAILED' "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh"; then
        echo "OK: emits BEADS_SETUP_FAILED signal"
      else
        echo "FAIL: does not emit BEADS_SETUP_FAILED"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Cases below require real bd — guarded with command -v check

  # Case 11: fresh init in git repo (requires bd)
  - name: "fresh_init"
    run: |
      if ! command -v bd >/dev/null 2>&1; then
        echo "OK: skipped (bd not available)"
        exit 0
      fi
      TMPDIR=$(mktemp -d)
      cd "$TMPDIR" && git init -q && git commit --allow-empty -m "init" -q
      OUTPUT=$(CLAUDE_PROJECT_DIR="$TMPDIR" bash "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh" 2>&1)
      RESULT=0
      if [ -d "$TMPDIR/.beads" ]; then
        echo "OK: .beads/ created in fresh git repo"
      else
        echo "FAIL: .beads/ not created"
        RESULT=1
      fi
      rm -rf "$TMPDIR"
      exit $RESULT
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 12: idempotent rerun (requires bd)
  - name: "idempotent_rerun"
    run: |
      if ! command -v bd >/dev/null 2>&1; then
        echo "OK: skipped (bd not available)"
        exit 0
      fi
      TMPDIR=$(mktemp -d)
      cd "$TMPDIR" && git init -q && git commit --allow-empty -m "init" -q
      CLAUDE_PROJECT_DIR="$TMPDIR" bash "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh" >/dev/null 2>&1
      OUTPUT=$(CLAUDE_PROJECT_DIR="$TMPDIR" bash "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh" 2>&1)
      if echo "$OUTPUT" | grep -q "healthy"; then
        echo "OK: second run reports healthy"
      else
        echo "FAIL: second run output: $OUTPUT"
        rm -rf "$TMPDIR"
        exit 1
      fi
      rm -rf "$TMPDIR"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 13: no-git-ops set after run (requires bd)
  - name: "no_git_ops_set"
    run: |
      if ! command -v bd >/dev/null 2>&1; then
        echo "OK: skipped (bd not available)"
        exit 0
      fi
      TMPDIR=$(mktemp -d)
      cd "$TMPDIR" && git init -q && git commit --allow-empty -m "init" -q
      CLAUDE_PROJECT_DIR="$TMPDIR" bash "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh" >/dev/null 2>&1
      VAL=$(cd "$TMPDIR" && bd config get no-git-ops 2>/dev/null)
      if [ "$VAL" = "true" ]; then
        echo "OK: no-git-ops is true"
      else
        echo "FAIL: no-git-ops is '$VAL'"
        rm -rf "$TMPDIR"
        exit 1
      fi
      rm -rf "$TMPDIR"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 14: database name normalized (requires bd)
  - name: "database_name_normalized"
    run: |
      if ! command -v bd >/dev/null 2>&1; then
        echo "OK: skipped (bd not available)"
        exit 0
      fi
      TMPDIR=$(mktemp -d)
      cd "$TMPDIR" && git init -q && git commit --allow-empty -m "init" -q
      CLAUDE_PROJECT_DIR="$TMPDIR" bash "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh" >/dev/null 2>&1
      DB=$(cd "$TMPDIR" && bd dolt show 2>/dev/null | grep "Database:" | awk '{print $2}')
      if [ "$DB" = "beads" ]; then
        echo "OK: database name is beads"
      else
        echo "FAIL: database name is '$DB'"
        rm -rf "$TMPDIR"
        exit 1
      fi
      rm -rf "$TMPDIR"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"
