name: "Unit: yf.json v1/v2 → yf.local.json migration (local-only)"

setup:
  - "mkdir -p .claude/rules docs/plans docs/diary"

steps:
  # Case 1: v1 yf.json with preflight → migrates to yf.local.json and deletes yf.json
  - name: "v1_migrates_to_local"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      mkdir -p "$WORK_DIR/.claude"
      cat > "$WORK_DIR/.claude/yf.json" <<'EOF'
      {
        "version": 1,
        "enabled": true,
        "config": {"artifact_dir": "docs", "chronicler_enabled": true},
        "updated": "2026-02-08T00:00:00Z",
        "preflight": {
          "plugins": {
            "yf": {
              "version": "2.1.0",
              "artifacts": {
                "rules": [{"target": ".claude/rules/yf-beads.md", "checksum": "sha256:abc123"}],
                "directories": ["docs/plans"],
                "setup": [{"name": "beads", "completed": true}]
              }
            }
          }
        }
      }
      EOF
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "migrating yf.json"

  # Case 2: After migration, yf.json is deleted
  - name: "yf_json_deleted"
    run: |
      if [ -f "$WORK_DIR/.claude/yf.json" ]; then
        echo "FAIL: yf.json should have been deleted"
        exit 1
      fi
      echo "OK: yf.json deleted"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: After migration, yf.local.json has preflight and config data
  - name: "local_has_preflight"
    run: |
      if [ ! -f "$WORK_DIR/.claude/yf.local.json" ]; then
        echo "FAIL: yf.local.json not created"
        exit 1
      fi
      HAS_PREFLIGHT=$(jq -e '.preflight.plugins.yf' "$WORK_DIR/.claude/yf.local.json" >/dev/null 2>&1 && echo "yes" || echo "no")
      echo "preflight=$HAS_PREFLIGHT"
      if [ "$HAS_PREFLIGHT" = "yes" ]; then
        echo "OK: local has preflight"
      else
        echo "FAIL: missing preflight in local"
        jq '.' "$WORK_DIR/.claude/yf.local.json"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Config values preserved through migration (in local file)
  - name: "config_preserved"
    run: |
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      if yf_is_enabled; then
        echo "OK: still enabled after migration"
      else
        echo "FAIL: disabled after migration"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: No re-migration when yf.json doesn't exist
  - name: "no_remigration"
    run: |
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "migrating yf.json"; then
        echo "FAIL: should not re-migrate"
        exit 1
      fi
      echo "OK: no re-migration"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: plugin-lock.json → yf.local.json chain migration
  - name: "chain_migration_v0_to_local"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      mkdir -p "$WORK_DIR/.claude"
      cat > "$WORK_DIR/.claude/plugin-lock.json" <<'EOF'
      {
        "version": 1,
        "updated": "2026-01-01T00:00:00Z",
        "plugins": {
          "yf": {
            "version": "2.0.0",
            "artifacts": {
              "rules": [],
              "directories": [],
              "setup": []
            }
          }
        }
      }
      EOF
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if [ ! -f "$WORK_DIR/.claude/plugin-lock.json" ] && [ -f "$WORK_DIR/.claude/yf.local.json" ] && [ ! -f "$WORK_DIR/.claude/yf.json" ]; then
        echo "OK: chain migration complete (local-only)"
      else
        echo "FAIL: chain migration incomplete"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "migrating plugin-lock.json"
      - type: output_contains
        value: "OK"

  # Case 7: v1 yf.json with custom config values preserved in local
  - name: "custom_config_preserved"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      mkdir -p "$WORK_DIR/.claude"
      cat > "$WORK_DIR/.claude/yf.json" <<'EOF'
      {
        "version": 1,
        "enabled": true,
        "config": {"artifact_dir": "output", "chronicler_enabled": false},
        "updated": "2026-02-08T00:00:00Z",
        "preflight": {"plugins": {"yf": {"version": "2.1.0", "artifacts": {"rules": [], "directories": [], "setup": []}}}}
      }
      EOF
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      # Config should be in local file now
      ART_DIR=$(jq -r '.config.artifact_dir' "$WORK_DIR/.claude/yf.local.json")
      CHRON=$(jq -r '.config.chronicler_enabled' "$WORK_DIR/.claude/yf.local.json")
      if [ "$ART_DIR" = "output" ] && [ "$CHRON" = "false" ]; then
        echo "OK: custom config preserved in local"
      else
        echo "FAIL: config lost (artifact_dir=$ART_DIR chronicler=$CHRON)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .claude/yf.json .claude/yf.local.json .claude/plugin-lock.json"
