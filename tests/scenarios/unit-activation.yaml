name: "Unit: yf-activation-check.sh — two-condition gate"

setup:
  - "mkdir -p .claude/rules .yoshiko-flow docs/plans docs/diary"

steps:
  # Case 1: No config → inactive
  - name: "no_config_inactive"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/yf-activation-check.sh")
      ACTIVE=$(echo "$OUTPUT" | jq -r '.active')
      REASON=$(echo "$OUTPUT" | jq -r '.reason // empty')
      if [ "$ACTIVE" = "false" ] && echo "$REASON" | grep -qi "config"; then
        echo "OK: no config → inactive"
      else
        echo "FAIL: active=$ACTIVE reason=$REASON"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: enabled:false → inactive
  - name: "disabled_inactive"
    run: |
      echo '{"enabled":false,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/yf-activation-check.sh")
      ACTIVE=$(echo "$OUTPUT" | jq -r '.active')
      REASON=$(echo "$OUTPUT" | jq -r '.reason // empty')
      if [ "$ACTIVE" = "false" ] && echo "$REASON" | grep -qi "disabled"; then
        echo "OK: disabled → inactive"
      else
        echo "FAIL: active=$ACTIVE reason=$REASON"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: enabled:true → active (two-condition gate: config exists + enabled)
  - name: "enabled_active"
    run: |
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/yf-activation-check.sh")
      ACTIVE=$(echo "$OUTPUT" | jq -r '.active')
      if [ "$ACTIVE" = "true" ]; then
        echo "OK: enabled → active"
      else
        echo "FAIL: active=$ACTIVE"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Script always exits 0
  - name: "always_exits_zero"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      bash "$PLUGIN_DIR/plugins/yf/scripts/yf-activation-check.sh" >/dev/null 2>&1
      echo "OK: exit code $?"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Output is valid JSON
  - name: "output_is_valid_json"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      export CLAUDE_PROJECT_DIR="$WORK_DIR"
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/yf-activation-check.sh")
      if echo "$OUTPUT" | jq . >/dev/null 2>&1; then
        echo "OK: valid JSON"
      else
        echo "FAIL: invalid JSON: $OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
