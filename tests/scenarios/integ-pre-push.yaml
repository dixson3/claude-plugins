name: "Integration: pre-push â€” landing enforcement"
type: integration

project:
  git: true
  yf_enabled: true
  plugin_link: true

steps:
  # Step 1: Verify pre-push-land.sh exists
  - name: "pre_push_exists"
    run: |
      HOOK="$PLUGIN_DIR/plugins/yf/hooks/pre-push-land.sh"
      if [ -x "$HOOK" ]; then
        echo "OK: pre-push-land.sh executable"
      else
        echo "FAIL: pre-push-land.sh missing or not executable"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Step 2: Clean tree with no in-progress tasks passes
  - name: "clean_push_succeeds"
    run: |
      # Ensure clean state
      cd "$WORK_DIR"
      git add -A && git commit -m "test commit" --allow-empty -q 2>/dev/null || true
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/pre-push-land.sh" 2>&1)
      EXIT=$?
      echo "exit=$EXIT output=$OUTPUT"
      # pre-push-land.sh should exit 0 for clean state
      if [ "$EXIT" -eq 0 ]; then
        echo "OK: clean push passes"
      else
        echo "FAIL: exit $EXIT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Step 3: In-progress tasks detected by pre-push
  - name: "in_progress_detected"
    run: |
      cd "$WORK_DIR"
      # Create an in-progress task file
      mkdir -p "$WORK_DIR/.yoshiko-flow/tasks"
      cat > "$WORK_DIR/.yoshiko-flow/tasks/task-push-001.json" << 'TASKJSON'
      {"id":"task-push-001","type":"task","title":"test blocker","status":"in_progress","labels":[],"created":"2026-01-01T00:00:00Z"}
      TASKJSON
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/pre-push-land.sh" 2>&1)
      EXIT=$?
      echo "exit=$EXIT output_preview=$(echo "$OUTPUT" | head -3)"
      # Hook may block (exit non-zero) or warn (exit 0 with message)
      if [ "$EXIT" -ne 0 ] || echo "$OUTPUT" | grep -qi "in.progress\|block\|open\|warn"; then
        echo "OK: in-progress task detected"
      else
        echo "OK: hook ran without error (advisory mode)"
      fi
      # Cleanup
      rm -f "$WORK_DIR/.yoshiko-flow/tasks/task-push-001.json"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"
