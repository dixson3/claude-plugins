name: "Unit: swarm reactive bugfix"
setup:
  - "mkdir -p .yoshiko-flow"

steps:
  # Case 1: swarm_react skill file exists
  - name: "react_skill_exists"
    run: |
      test -f "$PLUGIN_DIR/plugins/yf/skills/swarm_react/SKILL.md" && echo "exists"
    assertions:
      - type: output_contains
        value: "exists"

  # Case 2: Skill has correct name
  - name: "react_skill_name"
    run: |
      head -5 "$PLUGIN_DIR/plugins/yf/skills/swarm_react/SKILL.md" | grep "name:"
    assertions:
      - type: output_contains
        value: "yf:swarm_react"

  # Case 3: swarm_dispatch has Step 6b
  - name: "dispatch_has_step_6b"
    run: |
      grep "Step 6b" "$PLUGIN_DIR/plugins/yf/skills/swarm_dispatch/SKILL.md"
    assertions:
      - type: output_contains
        value: "Reactive"

  # Case 4: dispatch-state.sh" swarm mark-retrying works
  - name: "mark_retrying"
    run: |
      rm -f .yoshiko-flow/swarm-state.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-dispatched marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-retrying marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm is-dispatched marketplace-abc 2>/dev/null || true
    assertions:
      - type: output_contains
        value: "not-dispatched"

  # Case 5: mark-retrying is idempotent on non-existent step
  - name: "mark_retrying_idempotent"
    run: |
      rm -f .yoshiko-flow/swarm-state.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-retrying marketplace-nonexistent
    assertions:
      - type: output_contains
        value: "marked-retrying"
      - type: exit_code
        value: "0"

  # Case 6: consolidated yf-rules.md contains reactive bugfix section
  - name: "rules_has_reactive_bugfix"
    run: |
      grep -q "Reactive Bugfix" "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md" && echo "OK: reactive bugfix in consolidated rules"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: consolidated rules document design-BLOCK exclusion
  - name: "rules_design_block_excluded"
    run: |
      grep -c "design" "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md"
    assertions:
      - type: exit_code
        value: "0"

  # Case 8: preflight.json includes consolidated rule file
  - name: "preflight_has_yf_rules"
    run: |
      grep "yf-rules" "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json"
    assertions:
      - type: output_contains
        value: "yf-rules.md"

  # Case 9: swarm_react documents depth check guard rail
  - name: "react_depth_check"
    run: |
      grep -q 'depth >= 2.*skip\|depth check.*skip' "$PLUGIN_DIR/plugins/yf/skills/swarm_react/SKILL.md" && echo "OK: depth check documented"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: swarm_react documents bugfix-attempt label dedup
  - name: "react_label_dedup"
    run: |
      grep -q 'ys:bugfix-attempt' "$PLUGIN_DIR/plugins/yf/skills/swarm_react/SKILL.md" && echo "OK: dedup label documented"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 11: swarm_react documents design-BLOCK exclusion
  - name: "react_design_block_exclusion"
    run: |
      grep -q 'Design BLOCKs.*NOT eligible\|design-level concern' "$PLUGIN_DIR/plugins/yf/skills/swarm_react/SKILL.md" && echo "OK: design-BLOCK exclusion documented"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 12: swarm_react has Step 4.5 for chronicle auto-capture
  - name: "react_chronicle_auto_capture"
    run: |
      grep -q 'Step 4.5' "$PLUGIN_DIR/plugins/yf/skills/swarm_react/SKILL.md" && echo "OK: Step 4.5 exists"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 13: mark-retrying clears dispatched state
  - name: "mark_retrying_clears_dispatched"
    run: |
      rm -f .yoshiko-flow/swarm-state.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-dispatched marketplace-retry-test
      # Verify dispatched
      R1=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm is-dispatched marketplace-retry-test)
      # Mark for retry
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-retrying marketplace-retry-test
      # Should no longer be dispatched
      R2=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm is-dispatched marketplace-retry-test 2>/dev/null || true)
      echo "before=$R1 after=$R2"
      echo "$R1" | grep -q "dispatched" && echo "$R2" | grep -q "not-dispatched" && echo "OK: retrying clears dispatched"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 14: mark-retrying after mark-done is a no-op (step already completed)
  - name: "mark_retrying_after_done_noop"
    run: |
      rm -f .yoshiko-flow/swarm-state.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-dispatched marketplace-done-test
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-done marketplace-done-test
      # mark-retrying on a done step — entry already removed, should succeed silently
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-retrying marketplace-done-test
      # Verify step is still not in pending
      PENDING=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm pending)
      echo "pending=$PENDING"
      echo "$PENDING" | grep -qv "marketplace-done-test" && echo "OK: retrying after done is no-op"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 15: Full retry cycle — dispatch, retry, re-dispatch succeeds
  - name: "full_retry_cycle"
    run: |
      rm -f .yoshiko-flow/swarm-state.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-dispatched marketplace-cycle-test
      # Verify dispatched
      R1=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm is-dispatched marketplace-cycle-test)
      # Mark retrying
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-retrying marketplace-cycle-test
      # Re-dispatch
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm mark-dispatched marketplace-cycle-test
      R2=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" swarm is-dispatched marketplace-cycle-test)
      echo "before=$R1 after=$R2"
      [ "$R1" = "dispatched" ] && [ "$R2" = "dispatched" ] && echo "OK: full retry cycle works"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 16: mark-retrying is no-op for pump store
  - name: "mark_retrying_pump_noop"
    run: |
      rm -f .yoshiko-flow/task-pump.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" pump mark-dispatched pump-test
      RESULT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" pump mark-retrying pump-test)
      echo "result=$RESULT"
      # Pump retrying is a no-op, entry should still be dispatched
      R=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/dispatch-state.sh" pump is-dispatched pump-test)
      [ "$RESULT" = "no-op" ] && [ "$R" = "dispatched" ] && echo "OK: pump retrying is no-op"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/swarm-state.json .yoshiko-flow/task-pump.json"
