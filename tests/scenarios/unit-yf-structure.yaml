name: "Unit: yf plugin â€” merged structure verification"

steps:
  # Case 1: yf plugin directory exists
  - name: "yf_plugin_exists"
    run: |
      if [ -d "$PLUGIN_DIR/plugins/yf" ]; then
        echo "OK: plugins/yf/ exists"
      else
        echo "FAIL: plugins/yf/ not found"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Artifacts declared in preflight.json has consolidated rule
  - name: "artifacts_has_consolidated_rule"
    run: |
      RULE_COUNT=$(jq -r '(.artifacts.rules // []) | length' "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json")
      if [ "$RULE_COUNT" -lt 1 ]; then
        echo "FAIL: expected at least 1 artifact rule, got $RULE_COUNT"
        exit 1
      fi
      # Verify it's the consolidated file
      RULE_NAME=$(jq -r '.artifacts.rules[0].source' "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json")
      if [ "$RULE_NAME" = "rules/yf-rules.md" ]; then
        echo "OK: consolidated yf-rules.md declared"
      else
        echo "FAIL: unexpected rule: $RULE_NAME"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: yf rule files exist in plugins/yf/rules/
  - name: "rule_files_exist"
    run: |
      MISSING=""
      for rule in yf-rules.md; do
        if [ ! -f "$PLUGIN_DIR/plugins/yf/rules/$rule" ]; then
          MISSING="$MISSING $rule"
        fi
      done
      if [ -n "$MISSING" ]; then
        echo "FAIL: missing rule files:$MISSING"
        exit 1
      fi
      echo "OK: all expected rule files exist in plugins/yf/rules/"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Agents have yf_ prefix with correct names
  - name: "agents_have_yf_prefix"
    run: |
      FOUND_OLD=""
      for agent in "$PLUGIN_DIR"/plugins/yf/agents/*.md; do
        [ -f "$agent" ] || continue
        BASENAME=$(basename "$agent" .md)
        if echo "$BASENAME" | grep -q '^chronicler_'; then
          FOUND_OLD="$FOUND_OLD $BASENAME"
        fi
        # Also check for old unprefixed agent names
        case "$BASENAME" in
          yf_recall|yf_diary|yf_archivist)
            FOUND_OLD="$FOUND_OLD $BASENAME"
            ;;
        esac
      done
      if [ -n "$FOUND_OLD" ]; then
        echo "FAIL: agents still use old names:$FOUND_OLD"
        exit 1
      fi
      # Verify expected yf_ agents exist
      MISSING=""
      for expected in yf_chronicle_recall yf_chronicle_diary yf_archive_process; do
        if [ ! -f "$PLUGIN_DIR/plugins/yf/agents/${expected}.md" ]; then
          MISSING="$MISSING $expected"
        fi
      done
      if [ -n "$MISSING" ]; then
        echo "FAIL: missing expected agents:$MISSING"
        exit 1
      fi
      YF_COUNT=0
      for agent in "$PLUGIN_DIR"/plugins/yf/agents/yf_*.md; do
        [ -f "$agent" ] && YF_COUNT=$((YF_COUNT + 1))
      done
      echo "OK: $YF_COUNT agents with yf_ prefix, expected agents present"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: No old workflows plugin directory
  - name: "no_old_workflows_dir"
    run: |
      if [ -d "$PLUGIN_DIR/plugins/workflows" ]; then
        echo "FAIL: plugins/workflows/ still exists"
        exit 1
      fi
      echo "OK: plugins/workflows/ does not exist"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: No old chronicler plugin directory
  - name: "no_old_chronicler_dir"
    run: |
      if [ -d "$PLUGIN_DIR/plugins/chronicler" ]; then
        echo "FAIL: plugins/chronicler/ still exists"
        exit 1
      fi
      echo "OK: plugins/chronicler/ does not exist"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: marketplace.json has yf entry
  - name: "marketplace_has_yf"
    run: |
      if jq -e '.plugins[] | select(.name == "yf")' "$PLUGIN_DIR/.claude-plugin/marketplace.json" >/dev/null 2>&1; then
        echo "OK: marketplace.json has yf entry"
      else
        echo "FAIL: marketplace.json missing yf entry"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: marketplace.json has no workflows entry
  - name: "marketplace_no_workflows"
    run: |
      if jq -e '.plugins[] | select(.name == "workflows")' "$PLUGIN_DIR/.claude-plugin/marketplace.json" >/dev/null 2>&1; then
        echo "FAIL: marketplace.json still has workflows entry"
        exit 1
      fi
      echo "OK: marketplace.json has no workflows entry"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: marketplace.json has no chronicler entry
  - name: "marketplace_no_chronicler"
    run: |
      if jq -e '.plugins[] | select(.name == "chronicler")' "$PLUGIN_DIR/.claude-plugin/marketplace.json" >/dev/null 2>&1; then
        echo "FAIL: marketplace.json still has chronicler entry"
        exit 1
      fi
      echo "OK: marketplace.json has no chronicler entry"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"
