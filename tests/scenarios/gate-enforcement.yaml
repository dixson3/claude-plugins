name: "Integration: Gate Enforcement"
setup:
  - "git init"
  - "mkdir -p .claude/rules docs/plans src"
  - "echo '# Test Project' > CLAUDE.md"
  - "echo 'print(\"hello\")' > src/main.py"
  - "echo '{}' > .claude/settings.json"
  - "git add -A && git commit -m 'init'"

steps:
  # Step 1: Verify plugin loads (establishes session)
  - name: "plugin_loads"
    prompt: "Read src/main.py and tell me what it contains. Only use the Read tool."
    max_turns: 2
    allowed_tools: ["Read"]
    assertions:
      - type: output_contains
        value: "hello"

  # Step 2: Create gate (shell step, no claude)
  - name: "create_gate"
    run: |
      echo '{"plan_idx":"01","plan_file":"docs/plans/plan-01.md"}' > .claude/.plan-gate
    assertions:
      - type: file_exists
        path: ".claude/.plan-gate"

  # Step 3: Try to edit (should be blocked — session continues)
  - name: "edit_blocked"
    prompt: "Use the Edit tool to change 'hello' to 'world' in src/main.py."
    max_turns: 2
    allowed_tools: ["Edit", "Read"]
    assertions:
      - type: file_contains
        path: "src/main.py"
        value: "hello"
      - type: file_not_contains
        path: "src/main.py"
        value: "world"

  # Step 4: Try exempt file (should work)
  - name: "exempt_edit_works"
    prompt: "Use the Edit tool to change 'Test Project' to 'Updated Project' in CLAUDE.md."
    max_turns: 2
    allowed_tools: ["Edit", "Read"]
    assertions:
      - type: file_contains
        path: "CLAUDE.md"
        value: "Updated Project"

  # Step 5: Remove gate (shell step)
  - name: "remove_gate"
    run: "rm .claude/.plan-gate"
    assertions:
      - type: file_not_exists
        path: ".claude/.plan-gate"

  # Step 6: Edit now works (session remembers previous context)
  - name: "edit_allowed_after_gate_removal"
    prompt: "Now try again — use the Edit tool to change 'hello' to 'world' in src/main.py."
    max_turns: 3
    allowed_tools: ["Edit", "Read"]
    assertions:
      - type: file_contains
        path: "src/main.py"
        value: "world"
