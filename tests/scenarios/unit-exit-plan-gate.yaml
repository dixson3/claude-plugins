name: "Unit: exit-plan-gate.sh"
setup:
  - "mkdir -p .claude .yoshiko-flow docs/plans"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}'  > .yoshiko-flow/config.json"

steps:
  # Case 1: Gate already exists → idempotent skip
  - name: "idempotent_skip"
    run: |
      echo '{"plan_idx":"01"}' > .yoshiko-flow/plan-gate
      mkdir -p .claude/plans && echo '# plan' > .claude/plans/test.md
      HOME="$WORK_DIR" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/exit-plan-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 2: No .claude/plans/ directory → exit 0, no gate
  - name: "no_plans_dir"
    run: |
      rm -f .yoshiko-flow/plan-gate
      rm -rf .claude/plans
      HOME="$WORK_DIR" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/exit-plan-gate.sh"
    assertions:
      - type: exit_code
        value: "0"
      - type: file_not_exists
        path: ".yoshiko-flow/plan-gate"

  # Case 3: Empty .claude/plans/ → exit 0, no gate
  - name: "empty_plans_dir"
    run: |
      mkdir -p .claude/plans
      HOME="$WORK_DIR" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/exit-plan-gate.sh"
    assertions:
      - type: exit_code
        value: "0"
      - type: file_not_exists
        path: ".yoshiko-flow/plan-gate"

  # Case 4: Plan file, no existing docs → creates plan-NNNN-xxxxx.md + gate + _index.md
  - name: "creates_plan_01"
    run: |
      rm -rf docs/plans
      rm -f .yoshiko-flow/plan-gate
      echo '# My Plan' > .claude/plans/test-plan.md
      HOME="$WORK_DIR" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/exit-plan-gate.sh"
      # Verify a plan file was created with hybrid idx-hash name
      PLAN_COUNT=$(ls docs/plans/plan-*.md 2>/dev/null | wc -l | tr -d ' ')
      if [ "$PLAN_COUNT" -eq 1 ]; then
        PLAN_FILE=$(ls docs/plans/plan-*.md)
        PLAN_BASE=$(basename "$PLAN_FILE")
        # Verify hybrid format: plan-NNNN-xxxxx.md
        if echo "$PLAN_BASE" | grep -qE '^plan-[0-9]{4}-[a-z0-9]{5}\.md$'; then
          echo "OK: hybrid name $PLAN_BASE"
        else
          echo "FAIL: expected plan-NNNN-xxxxx.md, got $PLAN_BASE"
          exit 1
        fi
        if grep -q "My Plan" "$PLAN_FILE"; then
          echo "OK: plan created with content"
        else
          echo "FAIL: plan content missing"
          exit 1
        fi
      else
        echo "FAIL: expected 1 plan file, got $PLAN_COUNT"
        exit 1
      fi
      # Verify _index.md was created
      if [ -f docs/plans/_index.md ]; then
        if grep -q "My Plan" docs/plans/_index.md; then
          echo "OK: _index.md entry created"
        else
          echo "FAIL: _index.md missing plan entry"
          exit 1
        fi
      else
        echo "FAIL: _index.md not created"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: file_exists
        path: ".yoshiko-flow/plan-gate"
      - type: file_exists
        path: "docs/plans/_index.md"
      - type: output_contains
        value: "OK: plan created"

  # Case 5: Existing plan files → creates new hash-based plan (no collision)
  - name: "increments_index"
    run: |
      rm -f .yoshiko-flow/plan-gate
      echo '# Next Plan' > .claude/plans/another.md
      BEFORE=$(ls docs/plans/plan-*.md 2>/dev/null | wc -l | tr -d ' ')
      HOME="$WORK_DIR" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/exit-plan-gate.sh"
      AFTER=$(ls docs/plans/plan-*.md 2>/dev/null | wc -l | tr -d ' ')
      if [ "$AFTER" -gt "$BEFORE" ]; then
        echo "OK: new plan created"
      else
        echo "FAIL: no new plan file"
        exit 1
      fi
    assertions:
      - type: output_contains
        value: "OK"
      - type: file_contains
        path: ".yoshiko-flow/plan-gate"
        value: "plan_idx"

  # Case 6: Gate JSON has required fields
  - name: "gate_json_structure"
    run: |
      python3 -c "
      import json
      with open('.yoshiko-flow/plan-gate') as f:
          d = json.load(f)
      assert 'plan_idx' in d, 'missing plan_idx'
      assert 'plan_file' in d, 'missing plan_file'
      assert 'created' in d, 'missing created'
      print('OK')
      "
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: Plan content is preserved (compare latest plan with source)
  - name: "content_preserved"
    run: |
      LATEST_PLAN=$(ls -t docs/plans/plan-*.md | head -1)
      diff .claude/plans/another.md "$LATEST_PLAN"
    assertions:
      - type: exit_code
        value: "0"

  # Case 8: Auto-chain signal in output
  - name: "auto_chain_output"
    run: |
      rm -f .yoshiko-flow/plan-gate
      rm -rf docs/plans
      echo '# Auto Plan' > .claude/plans/auto.md
      HOME="$WORK_DIR" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/exit-plan-gate.sh"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "Auto-chaining plan lifecycle..."
      - type: output_contains
        value: "PLAN_IDX="
      - type: output_contains
        value: "PLAN_FILE=docs/plans/plan-"

teardown:
  - "rm -f .yoshiko-flow/plan-gate"
  - "rm -rf .claude/plans"
