name: "Unit: exit-plan-gate.sh"
setup:
  - "mkdir -p .claude docs/plans"

steps:
  # Case 1: Gate already exists → idempotent skip
  - name: "idempotent_skip"
    run: |
      echo '{"plan_idx":"01"}' > .claude/.plan-gate
      mkdir -p .claude/plans && echo '# plan' > .claude/plans/test.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/workflows/hooks/exit-plan-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 2: No .claude/plans/ directory → exit 0, no gate
  - name: "no_plans_dir"
    run: |
      rm -f .claude/.plan-gate
      rm -rf .claude/plans
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/workflows/hooks/exit-plan-gate.sh"
    assertions:
      - type: exit_code
        value: "0"
      - type: file_not_exists
        path: ".claude/.plan-gate"

  # Case 3: Empty .claude/plans/ → exit 0, no gate
  - name: "empty_plans_dir"
    run: |
      mkdir -p .claude/plans
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/workflows/hooks/exit-plan-gate.sh"
    assertions:
      - type: exit_code
        value: "0"
      - type: file_not_exists
        path: ".claude/.plan-gate"

  # Case 4: Plan file, no existing docs → creates plan-01.md + gate
  - name: "creates_plan_01"
    run: |
      rm -rf docs/plans
      rm -f .claude/.plan-gate
      echo '# My Plan' > .claude/plans/test-plan.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/workflows/hooks/exit-plan-gate.sh"
    assertions:
      - type: exit_code
        value: "0"
      - type: file_exists
        path: "docs/plans/plan-01.md"
      - type: file_exists
        path: ".claude/.plan-gate"
      - type: file_contains
        path: "docs/plans/plan-01.md"
        value: "My Plan"

  # Case 5: Existing plan-03.md → creates plan-04.md
  - name: "increments_index"
    run: |
      rm -f .claude/.plan-gate
      mkdir -p docs/plans
      touch docs/plans/plan-03.md
      echo '# Next Plan' > .claude/plans/another.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/workflows/hooks/exit-plan-gate.sh"
    assertions:
      - type: file_exists
        path: "docs/plans/plan-04.md"
      - type: file_contains
        path: ".claude/.plan-gate"
        value: "plan_idx"

  # Case 6: Gate JSON has required fields
  - name: "gate_json_structure"
    run: |
      python3 -c "
      import json
      with open('.claude/.plan-gate') as f:
          d = json.load(f)
      assert 'plan_idx' in d, 'missing plan_idx'
      assert 'plan_file' in d, 'missing plan_file'
      assert 'created' in d, 'missing created'
      print('OK')
      "
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: Plan content is preserved
  - name: "content_preserved"
    run: |
      diff .claude/plans/another.md docs/plans/plan-04.md
    assertions:
      - type: exit_code
        value: "0"

teardown:
  - "rm -f .claude/.plan-gate"
  - "rm -rf .claude/plans"
