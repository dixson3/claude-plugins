name: "Unit: plugin-preflight.sh â€” chronicler toggle"

setup:
  - "mkdir -p .claude/rules docs/plans docs/diary"

steps:
  # Case 1: All rules installed when chronicler enabled (default)
  - name: "all_rules_with_chronicler"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      if [ -L "$WORK_DIR/.claude/rules/yf-watch-for-chronicle-worthiness.md" ] && \
         [ -L "$WORK_DIR/.claude/rules/yf-plan-transition-chronicle.md" ]; then
        echo "OK: chronicle rules installed as symlinks"
      else
        echo "FAIL: chronicle rules missing"
        ls -la "$WORK_DIR/.claude/rules/" 2>/dev/null
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Chronicle rules skipped when chronicler disabled via local config
  - name: "chronicle_rules_skipped_when_disabled"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      mkdir -p "$WORK_DIR/.claude"
      echo '{"enabled":true,"config":{"artifact_dir":"docs","chronicler_enabled":false}}' > "$WORK_DIR/.claude/yf.local.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      FAIL=false
      if [ -e "$WORK_DIR/.claude/rules/yf-watch-for-chronicle-worthiness.md" ] || \
         [ -L "$WORK_DIR/.claude/rules/yf-watch-for-chronicle-worthiness.md" ]; then
        echo "FAIL: yf-watch-for-chronicle-worthiness.md should not be installed"
        FAIL=true
      fi
      if [ -e "$WORK_DIR/.claude/rules/yf-plan-transition-chronicle.md" ] || \
         [ -L "$WORK_DIR/.claude/rules/yf-plan-transition-chronicle.md" ]; then
        echo "FAIL: yf-plan-transition-chronicle.md should not be installed"
        FAIL=true
      fi
      # Non-chronicle rules should still be installed
      if [ ! -L "$WORK_DIR/.claude/rules/yf-beads.md" ]; then
        echo "FAIL: yf-beads.md should be installed as symlink"
        FAIL=true
      fi
      if $FAIL; then
        exit 1
      fi
      echo "OK: chronicle rules skipped, others installed"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Chronicle rules removed when reconfiguring to disabled
  - name: "chronicle_rules_removed_on_reconfigure"
    run: |
      # First install with chronicler enabled
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      # Verify chronicle rules exist
      if [ ! -L "$WORK_DIR/.claude/rules/yf-watch-for-chronicle-worthiness.md" ]; then
        echo "FAIL: chronicle rules not installed in first pass"
        exit 1
      fi
      # Now disable chronicler via local config
      jq '. + {config: (.config + {chronicler_enabled: false})}' "$WORK_DIR/.claude/yf.local.json" > "$WORK_DIR/.claude/yf.local.json.tmp"
      mv "$WORK_DIR/.claude/yf.local.json.tmp" "$WORK_DIR/.claude/yf.local.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if [ -e "$WORK_DIR/.claude/rules/yf-watch-for-chronicle-worthiness.md" ] || \
         [ -L "$WORK_DIR/.claude/rules/yf-watch-for-chronicle-worthiness.md" ]; then
        echo "FAIL: chronicle rule still exists"
        exit 1
      fi
      if [ -e "$WORK_DIR/.claude/rules/yf-plan-transition-chronicle.md" ] || \
         [ -L "$WORK_DIR/.claude/rules/yf-plan-transition-chronicle.md" ]; then
        echo "FAIL: chronicle transition rule still exists"
        exit 1
      fi
      echo "OK: chronicle rules removed"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "removed"
      - type: output_contains
        value: "OK"

  # Case 4: pre-push-diary exits 0 when chronicler disabled via local config
  - name: "pre_push_diary_exits_chronicler_disabled"
    run: |
      echo '{"config":{"chronicler_enabled":false}}' > "$WORK_DIR/.claude/yf.local.json"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/pre-push-diary.sh"
      echo "OK: pre-push-diary exited 0"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Non-chronicle rules still present after chronicler disable
  - name: "non_chronicle_rules_preserved"
    run: |
      # Re-run preflight with chronicler disabled to get back to a consistent state
      echo '{"enabled":true,"config":{"chronicler_enabled":false}}' > "$WORK_DIR/.claude/yf.local.json"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      if [ -L "$WORK_DIR/.claude/rules/yf-beads.md" ] && \
         [ -L "$WORK_DIR/.claude/rules/yf-engage-the-plan.md" ]; then
        echo "OK: non-chronicle rules preserved"
      else
        echo "FAIL: non-chronicle rules missing"
        ls -la "$WORK_DIR/.claude/rules/" 2>/dev/null
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: Lock file doesn't contain chronicle rules when disabled
  - name: "lock_excludes_chronicle_rules"
    run: |
      TARGETS=$(jq -r '.preflight.plugins.yf.artifacts.rules[].target' "$WORK_DIR/.claude/yf.local.json")
      if echo "$TARGETS" | grep -q "chronicle-worthiness"; then
        echo "FAIL: chronicle rule in lock"
        exit 1
      fi
      if echo "$TARGETS" | grep -q "plan-transition-chronicle"; then
        echo "FAIL: transition chronicle rule in lock"
        exit 1
      fi
      echo "OK: chronicle rules not in lock"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .claude/yf.json .claude/yf.local.json"
