name: "Unit: plugin-preflight.sh — core symlink sync"

setup:
  - "mkdir -p .claude/rules docs/plans docs/diary"

steps:
  # Case 1: No config → installs all rules as symlinks
  - name: "fresh_install_creates_symlinks"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/yf-"*.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "installed"

  # Case 2: Installed rules are symlinks (not regular files)
  - name: "rules_are_symlinks"
    run: |
      FAIL=false
      for f in "$WORK_DIR/.claude/rules"/yf-*.md; do
        [ -e "$f" ] || continue
        if [ ! -L "$f" ]; then
          echo "FAIL: $(basename "$f") is not a symlink"
          FAIL=true
        fi
      done
      if $FAIL; then exit 1; fi
      echo "OK: all rules are symlinks"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Symlinks point to plugin source (relative when in-tree, absolute otherwise)
  - name: "symlinks_point_to_plugin_source"
    run: |
      LINK=$(readlink "$WORK_DIR/.claude/rules/yf-beads.md")
      if echo "$LINK" | grep -q "plugins/yf/rules/yf-beads.md"; then
        echo "OK: symlink target correct: $LINK"
      else
        echo "FAIL: unexpected target: $LINK"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Lock has mode:symlink and link fields (not checksums)
  - name: "lock_has_symlink_mode"
    run: |
      if [ ! -f "$WORK_DIR/.claude/yf.json" ]; then
        echo "FAIL: yf.json not created"
        exit 1
      fi
      MODE=$(jq -r '.preflight.plugins.yf.mode' "$WORK_DIR/.claude/yf.json")
      LINK=$(jq -r '.preflight.plugins.yf.artifacts.rules[0].link' "$WORK_DIR/.claude/yf.json")
      CHECKSUM=$(jq -r '.preflight.plugins.yf.artifacts.rules[0].checksum // "absent"' "$WORK_DIR/.claude/yf.json" 2>/dev/null)
      if [ "$MODE" = "symlink" ] && echo "$LINK" | grep -q "plugins/yf/rules/" && [ "$CHECKSUM" = "absent" ]; then
        echo "OK: mode=symlink, link field present, no checksum"
      else
        echo "FAIL: mode=$MODE link=$LINK checksum=$CHECKSUM"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Fast path — second run with no changes
  - name: "fast_path_up_to_date"
    run: |
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "up to date"

  # Case 6: Missing symlink gets reinstalled
  - name: "reinstall_missing_symlink"
    run: |
      rm -f "$WORK_DIR/.claude/rules/yf-beads.md"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "installed .claude/rules/yf-beads.md"

  # Case 7: Directories created when missing
  - name: "creates_missing_directories"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json"
      rm -rf "$WORK_DIR/docs/plans" "$WORK_DIR/docs/diary"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if [ -d "$WORK_DIR/docs/plans" ] && [ -d "$WORK_DIR/docs/diary" ]; then
        echo "OK: directories created"
      else
        echo "FAIL: directories missing"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: Fail-open on bad CLAUDE_PROJECT_DIR
  - name: "failopen_bad_project_dir"
    run: |
      CLAUDE_PROJECT_DIR="/nonexistent/path" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "warn"

teardown:
  - "rm -f .claude/yf.json .claude/yf.local.json"
