name: "Unit: plugin-preflight.sh — core symlink sync"

setup:
  - "mkdir -p .claude/rules .yoshiko-flow docs/plans docs/diary"

steps:
  # Case 1: With config → installs all rules as symlinks
  - name: "fresh_install_creates_symlinks"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json" "$WORK_DIR/.yoshiko-flow/lock.json" "$WORK_DIR/.claude/yf.local.json"
      rm -rf "$WORK_DIR/.claude/rules/yf"
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "installed"

  # Case 2: Installed rules are symlinks (not regular files)
  - name: "rules_are_symlinks"
    run: |
      FAIL=false
      for f in "$WORK_DIR/.claude/rules/yf"/*.md; do
        [ -e "$f" ] || continue
        if [ ! -L "$f" ]; then
          echo "FAIL: $(basename "$f") is not a symlink"
          FAIL=true
        fi
      done
      if $FAIL; then exit 1; fi
      echo "OK: all rules are symlinks"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Symlinks point to plugin source (relative when in-tree, absolute otherwise)
  - name: "symlinks_point_to_plugin_source"
    run: |
      LINK=$(readlink "$WORK_DIR/.claude/rules/yf/yf-rules.md")
      if echo "$LINK" | grep -q "plugins/yf/rules/yf-rules.md"; then
        echo "OK: symlink target correct: $LINK"
      else
        echo "FAIL: unexpected target: $LINK"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Lock has mode:symlink and link fields (not checksums)
  - name: "lock_has_symlink_mode"
    run: |
      if [ ! -f "$WORK_DIR/.yoshiko-flow/lock.json" ]; then
        echo "FAIL: lock.json not created"
        exit 1
      fi
      MODE=$(jq -r '.preflight.plugins.yf.mode' "$WORK_DIR/.yoshiko-flow/lock.json")
      LINK=$(jq -r '.preflight.plugins.yf.artifacts.rules[0].link' "$WORK_DIR/.yoshiko-flow/lock.json")
      CHECKSUM=$(jq -r '.preflight.plugins.yf.artifacts.rules[0].checksum // "absent"' "$WORK_DIR/.yoshiko-flow/lock.json" 2>/dev/null)
      if [ "$MODE" = "symlink" ] && echo "$LINK" | grep -q "plugins/yf/rules/" && [ "$CHECKSUM" = "absent" ]; then
        echo "OK: mode=symlink, link field present, no checksum"
      else
        echo "FAIL: mode=$MODE link=$LINK checksum=$CHECKSUM"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Fast path — second run with no changes
  - name: "fast_path_up_to_date"
    run: |
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "up to date"

  # Case 6: Missing symlink gets reinstalled
  - name: "reinstall_missing_symlink"
    run: |
      rm -f "$WORK_DIR/.claude/rules/yf/yf-rules.md"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "installed .claude/rules/yf/yf-rules.md"

  # Case 7: Directories created when missing (requires config)
  - name: "creates_missing_directories"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/lock.json"
      rm -rf "$WORK_DIR/docs/plans" "$WORK_DIR/docs/diary"
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if [ -d "$WORK_DIR/docs/plans" ] && [ -d "$WORK_DIR/docs/diary" ]; then
        echo "OK: directories created"
      else
        echo "FAIL: directories missing"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: Config with extra fields is accepted (no pruning needed)
  - name: "config_extra_fields_accepted"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/lock.json"
      echo '{"enabled":true,"config":{"artifact_dir":"docs"}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      # Verify enabled and artifact_dir are preserved
      ENABLED=$(jq -r '.enabled' "$WORK_DIR/.yoshiko-flow/config.json")
      ART_DIR=$(jq -r '.config.artifact_dir' "$WORK_DIR/.yoshiko-flow/config.json")
      if [ "$ENABLED" = "true" ] && [ "$ART_DIR" = "docs" ]; then
        echo "OK: config fields preserved"
      else
        echo "FAIL: enabled=$ENABLED artifact_dir=$ART_DIR"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: Fail-open on bad CLAUDE_PROJECT_DIR
  - name: "failopen_bad_project_dir"
    run: |
      CLAUDE_PROJECT_DIR="/nonexistent/path" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "warn"

  # Case 10: No config → exits early, no rules installed (fail-closed activation)
  - name: "no_config_exits_early"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json" "$WORK_DIR/.yoshiko-flow/lock.json"
      rm -rf "$WORK_DIR/.claude/rules/yf"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "YF_SETUP_NEEDED"; then
        # Verify no rules were installed
        COUNT=0
        for f in "$WORK_DIR/.claude/rules/yf"/*.md; do
          [ -e "$f" ] || [ -L "$f" ] || continue
          COUNT=$((COUNT + 1))
        done
        if [ "$COUNT" -eq 0 ]; then
          echo "OK: no config → no rules installed"
        else
          echo "FAIL: $COUNT rules installed without config"
          exit 1
        fi
      else
        echo "FAIL: missing YF_SETUP_NEEDED signal"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 11: Beads dependency missing → emits signal
  - name: "beads_dependency_signal"
    run: |
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/lock.json"
      OUTPUT=$(HOME="$WORK_DIR/fakehome" PATH="/usr/bin:/bin" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "YF_DEPENDENCY_MISSING"; then
        echo "OK: beads dependency signal emitted"
      else
        echo "FAIL: missing dependency signal"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 12: bd prime hooks removal is handled by beads-setup.sh (not preflight)
  - name: "bd_prime_in_beads_setup"
    run: |
      # bd prime removal was consolidated into beads-setup.sh — verify it's there
      if grep -q 'bd prime' "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh" && \
         grep -q 'bd setup claude --remove --project' "$PLUGIN_DIR/plugins/yf/scripts/beads-setup.sh"; then
        echo "OK: bd prime hook removal logic in beads-setup.sh"
      else
        echo "FAIL: beads-setup.sh missing bd prime removal logic"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 13: preflight does NOT duplicate bd prime removal (consolidated in beads-setup.sh)
  - name: "no_bd_prime_in_preflight"
    run: |
      if grep -q 'bd prime' "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh"; then
        echo "FAIL: plugin-preflight.sh still contains bd prime logic (should be in beads-setup.sh only)"
        exit 1
      fi
      echo "OK: bd prime removal not duplicated in preflight"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json .yoshiko-flow/lock.json .claude/yf.local.json"
  - "rm -rf fakehome"
