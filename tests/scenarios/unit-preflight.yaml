name: "Unit: plugin-preflight.sh — core sync"

setup:
  - "mkdir -p .claude/rules docs/plans docs/diary"

steps:
  # Case 1: No lock file → installs all rules
  - name: "fresh_install_creates_rules"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json"
      rm -f "$WORK_DIR/.claude/rules/yf-beads.md"
      rm -f "$WORK_DIR/.claude/rules/yf-beads-drive-tasks.md"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "installed"

  # Case 2: Lock file created after preflight
  - name: "lock_file_created"
    run: |
      if [ ! -f "$WORK_DIR/.claude/yf.json" ]; then
        echo "FAIL: lock file not created"
        exit 1
      fi
      jq -r '.version' "$WORK_DIR/.claude/yf.json"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "1"

  # Case 3: Lock file contains yf plugin
  - name: "lock_has_yf_plugin"
    run: |
      YF=$(jq -r '.preflight.plugins.yf.version' "$WORK_DIR/.claude/yf.json")
      if [ -z "$YF" ] || [ "$YF" = "null" ]; then
        echo "FAIL: yf not in lock"
        exit 1
      fi
      echo "OK: yf=$YF"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Fast path — second run with no changes
  - name: "fast_path_up_to_date"
    run: |
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "up to date"

  # Case 5: Missing rule gets reinstalled
  - name: "reinstall_missing_rule"
    run: |
      rm -f "$WORK_DIR/.claude/rules/yf-beads.md"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "installed .claude/rules/yf-beads.md"

  # Case 6: Single plugin processed correctly
  - name: "single_plugin_processed"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "yf"; then
        echo "OK: yf plugin processed"
      else
        echo "FAIL: yf not found in output"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: Directories created when missing
  - name: "creates_missing_directories"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json"
      rm -rf "$WORK_DIR/docs/plans" "$WORK_DIR/docs/diary"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if [ -d "$WORK_DIR/docs/plans" ] && [ -d "$WORK_DIR/docs/diary" ]; then
        echo "OK: directories created"
      else
        echo "FAIL: directories missing"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: Checksums recorded in lock
  - name: "checksums_in_lock"
    run: |
      CKSUM=$(jq -r '.preflight.plugins.yf.artifacts.rules[0].checksum' "$WORK_DIR/.claude/yf.json")
      if echo "$CKSUM" | grep -q '^sha256:'; then
        echo "OK: checksum format correct: $CKSUM"
      else
        echo "FAIL: bad checksum: $CKSUM"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: Fail-open on bad CLAUDE_PROJECT_DIR
  - name: "failopen_bad_project_dir"
    run: |
      CLAUDE_PROJECT_DIR="/nonexistent/path" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "warn"

teardown:
  - "rm -f .claude/yf.json"
