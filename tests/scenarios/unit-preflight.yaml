name: "Unit: plugin-preflight.sh — core sync"

setup:
  - "mkdir -p .claude/rules docs/plans docs/diary"

steps:
  # Case 1: No lock file → installs all rules
  - name: "fresh_install_creates_rules"
    run: |
      rm -f "$WORK_DIR/.claude/plugin-lock.json"
      rm -f "$WORK_DIR/.claude/rules/BEADS.md"
      rm -f "$WORK_DIR/.claude/rules/beads-drive-tasks.md"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "installed"

  # Case 2: Lock file created after preflight
  - name: "lock_file_created"
    run: |
      if [ ! -f "$WORK_DIR/.claude/plugin-lock.json" ]; then
        echo "FAIL: lock file not created"
        exit 1
      fi
      jq -r '.version' "$WORK_DIR/.claude/plugin-lock.json"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "1"

  # Case 3: Lock file contains both plugins
  - name: "lock_has_both_plugins"
    run: |
      WF=$(jq -r '.plugins.workflows.version' "$WORK_DIR/.claude/plugin-lock.json")
      CH=$(jq -r '.plugins.chronicler.version' "$WORK_DIR/.claude/plugin-lock.json")
      if [ -z "$WF" ] || [ "$WF" = "null" ]; then
        echo "FAIL: workflows not in lock"
        exit 1
      fi
      if [ -z "$CH" ] || [ "$CH" = "null" ]; then
        echo "FAIL: chronicler not in lock"
        exit 1
      fi
      echo "OK: workflows=$WF chronicler=$CH"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Fast path — second run with no changes
  - name: "fast_path_up_to_date"
    run: |
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "up to date"

  # Case 5: Missing rule gets reinstalled
  - name: "reinstall_missing_rule"
    run: |
      rm -f "$WORK_DIR/.claude/rules/BEADS.md"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "installed .claude/rules/BEADS.md"

  # Case 6: Dependency ordering — workflows before chronicler
  - name: "dependency_ordering"
    run: |
      rm -f "$WORK_DIR/.claude/plugin-lock.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      # workflows lines should appear before chronicler lines
      WF_LINE=$(echo "$OUTPUT" | grep -n "workflows" | head -1 | cut -d: -f1)
      CH_LINE=$(echo "$OUTPUT" | grep -n "chronicler" | head -1 | cut -d: -f1)
      if [ -n "$WF_LINE" ] && [ -n "$CH_LINE" ] && [ "$WF_LINE" -lt "$CH_LINE" ]; then
        echo "OK: workflows before chronicler"
      elif [ -z "$CH_LINE" ]; then
        echo "OK: only workflows had changes (chronicler up to date)"
      else
        echo "FAIL: ordering wrong"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: Directories created when missing
  - name: "creates_missing_directories"
    run: |
      rm -f "$WORK_DIR/.claude/plugin-lock.json"
      rm -rf "$WORK_DIR/docs/plans" "$WORK_DIR/docs/diary"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      if [ -d "$WORK_DIR/docs/plans" ] && [ -d "$WORK_DIR/docs/diary" ]; then
        echo "OK: directories created"
      else
        echo "FAIL: directories missing"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: Checksums recorded in lock
  - name: "checksums_in_lock"
    run: |
      CKSUM=$(jq -r '.plugins.workflows.artifacts.rules[0].checksum' "$WORK_DIR/.claude/plugin-lock.json")
      if echo "$CKSUM" | grep -q '^sha256:'; then
        echo "OK: checksum format correct: $CKSUM"
      else
        echo "FAIL: bad checksum: $CKSUM"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: Fail-open on bad CLAUDE_PROJECT_DIR
  - name: "failopen_bad_project_dir"
    run: |
      CLAUDE_PROJECT_DIR="/nonexistent/path" bash "$PLUGIN_DIR/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "warn"

teardown:
  - "rm -f .claude/plugin-lock.json"
