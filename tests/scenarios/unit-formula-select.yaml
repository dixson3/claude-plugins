name: "Unit: formula_select skill"
setup:
  - "mkdir -p plugins/yf/skills/formula_select"

steps:
  # Case 1: Skill file exists with correct frontmatter
  - name: "skill_file_exists"
    run: |
      test -f "$PLUGIN_DIR/plugins/yf/skills/formula_select/SKILL.md" && echo "exists"
    assertions:
      - type: output_contains
        value: "exists"

  # Case 2: Skill has correct name in frontmatter
  - name: "skill_name_correct"
    run: |
      head -5 "$PLUGIN_DIR/plugins/yf/skills/formula_select/SKILL.md" | grep "name:"
    assertions:
      - type: output_contains
        value: "yf:formula_select"

  # Case 3: Consolidated rules contain formula selection content
  - name: "rules_has_formula_selection"
    run: |
      grep -q "Formula-Labeled Tasks" "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md" && echo "exists"
    assertions:
      - type: output_contains
        value: "exists"

  # Case 4: Consolidated rules document formula dispatch
  - name: "rules_has_formula_dispatch"
    run: |
      grep -c "formula.*formula_execute\|formula_execute.*formula" "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md"
    assertions:
      - type: exit_code
        value: "0"

  # Case 5: plan_create_tasks has Step 8b
  - name: "plan_create_tasks_has_step_8b"
    run: |
      grep "Step 8b" "$PLUGIN_DIR/plugins/yf/skills/plan_create_tasks/SKILL.md"
    assertions:
      - type: output_contains
        value: "Formula Selection"

  # Case 6: Skill references idempotency check
  - name: "skill_idempotent"
    run: |
      grep -c "formula:\*" "$PLUGIN_DIR/plugins/yf/skills/formula_select/SKILL.md" || echo "0"
    assertions:
      - type: exit_code
        value: "0"

  # Case 7: preflight.json includes consolidated rule file
  - name: "preflight_has_rule"
    run: |
      grep "yf-rules" "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json"
    assertions:
      - type: output_contains
        value: "yf-rules.md"
