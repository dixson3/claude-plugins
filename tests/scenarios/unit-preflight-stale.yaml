name: "Unit: plugin-preflight.sh â€” stale artifact removal"

setup:
  - "mkdir -p .claude/rules docs/plans docs/diary"

steps:
  # Case 1: Stale rule gets removed
  - name: "stale_rule_removed"
    run: |
      # First, do a clean preflight to get a lock file
      rm -f "$WORK_DIR/.claude/yf.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      # Inject a fake stale entry into the lock
      LOCK=$(cat "$WORK_DIR/.claude/yf.json")
      echo "$LOCK" | jq '.preflight.plugins.yf.artifacts.rules += [{"target": ".claude/rules/deprecated-rule.md", "checksum": "sha256:fakefake"}]' > "$WORK_DIR/.claude/yf.json"
      # Create the file
      echo "# deprecated" > "$WORK_DIR/.claude/rules/deprecated-rule.md"
      # Run preflight
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      # Verify file removed
      if [ ! -f "$WORK_DIR/.claude/rules/deprecated-rule.md" ]; then
        echo "OK: stale file removed"
      else
        echo "FAIL: stale file still exists"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "removed stale"
      - type: output_contains
        value: "OK"

  # Case 2: Stale entry no longer in lock after cleanup
  - name: "stale_entry_gone_from_lock"
    run: |
      TARGETS=$(jq -r '.preflight.plugins.yf.artifacts.rules[].target' "$WORK_DIR/.claude/yf.json")
      if echo "$TARGETS" | grep -q 'deprecated-rule.md'; then
        echo "FAIL: deprecated-rule.md still in lock"
        exit 1
      fi
      echo "OK: stale entry removed from lock"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Lock only contains yf plugin after sync
  - name: "lock_only_has_yf"
    run: |
      PLUGINS=$(jq -r '.preflight.plugins | keys[]' "$WORK_DIR/.claude/yf.json")
      if [ "$PLUGINS" = "yf" ]; then
        echo "OK: only yf in lock"
      else
        echo "FAIL: unexpected plugins: $PLUGINS"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Multiple stale rules removed in one pass
  - name: "multiple_stale_removed"
    run: |
      LOCK=$(cat "$WORK_DIR/.claude/yf.json")
      echo "$LOCK" | jq '.preflight.plugins.yf.artifacts.rules += [{"target": ".claude/rules/old-a.md", "checksum": "sha256:aaa"}, {"target": ".claude/rules/old-b.md", "checksum": "sha256:bbb"}]' > "$WORK_DIR/.claude/yf.json"
      echo "# old-a" > "$WORK_DIR/.claude/rules/old-a.md"
      echo "# old-b" > "$WORK_DIR/.claude/rules/old-b.md"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      FAIL=false
      if [ -f "$WORK_DIR/.claude/rules/old-a.md" ]; then FAIL=true; fi
      if [ -f "$WORK_DIR/.claude/rules/old-b.md" ]; then FAIL=true; fi
      if $FAIL; then
        echo "FAIL: stale files remain"
        exit 1
      fi
      echo "OK: multiple stale rules removed"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "removed stale"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .claude/yf.json"
  - "rm -f .claude/rules/deprecated-rule.md .claude/rules/old-a.md .claude/rules/old-b.md"
