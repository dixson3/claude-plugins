name: "Unit: plugin-preflight.sh â€” stale artifact removal"

setup:
  - "mkdir -p .claude/rules docs/plans docs/diary"

steps:
  # Case 1: Stale symlink gets removed
  - name: "stale_symlink_removed"
    run: |
      # First, do a clean preflight to get lock files
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      # Inject a fake stale entry into the local lock
      LOCAL=$(cat "$WORK_DIR/.claude/yf.json")
      echo "$LOCAL" | jq '.preflight.plugins.yf.artifacts.rules += [{"target": ".claude/rules/deprecated-rule.md", "link": "../../plugins/yf/rules/deprecated-rule.md"}]' > "$WORK_DIR/.claude/yf.json"
      # Create the stale symlink
      ln -sf "../../plugins/yf/rules/deprecated-rule.md" "$WORK_DIR/.claude/rules/deprecated-rule.md"
      # Run preflight
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      # Verify symlink removed
      if [ ! -e "$WORK_DIR/.claude/rules/deprecated-rule.md" ] && [ ! -L "$WORK_DIR/.claude/rules/deprecated-rule.md" ]; then
        echo "OK: stale symlink removed"
      else
        echo "FAIL: stale symlink still exists"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "removed stale"
      - type: output_contains
        value: "OK"

  # Case 2: Stale entry no longer in lock after cleanup
  - name: "stale_entry_gone_from_lock"
    run: |
      TARGETS=$(jq -r '.preflight.plugins.yf.artifacts.rules[].target' "$WORK_DIR/.claude/yf.json")
      if echo "$TARGETS" | grep -q 'deprecated-rule.md'; then
        echo "FAIL: deprecated-rule.md still in lock"
        exit 1
      fi
      echo "OK: stale entry removed from lock"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Lock only contains yf plugin after sync
  - name: "lock_only_has_yf"
    run: |
      PLUGINS=$(jq -r '.preflight.plugins | keys[]' "$WORK_DIR/.claude/yf.json")
      if [ "$PLUGINS" = "yf" ]; then
        echo "OK: only yf in lock"
      else
        echo "FAIL: unexpected plugins: $PLUGINS"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Multiple stale symlinks removed in one pass
  - name: "multiple_stale_removed"
    run: |
      LOCAL=$(cat "$WORK_DIR/.claude/yf.json")
      echo "$LOCAL" | jq '.preflight.plugins.yf.artifacts.rules += [{"target": ".claude/rules/old-a.md", "link": "../../plugins/yf/rules/old-a.md"}, {"target": ".claude/rules/old-b.md", "link": "../../plugins/yf/rules/old-b.md"}]' > "$WORK_DIR/.claude/yf.json"
      ln -sf "../../plugins/yf/rules/old-a.md" "$WORK_DIR/.claude/rules/old-a.md"
      ln -sf "../../plugins/yf/rules/old-b.md" "$WORK_DIR/.claude/rules/old-b.md"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      FAIL=false
      if [ -e "$WORK_DIR/.claude/rules/old-a.md" ] || [ -L "$WORK_DIR/.claude/rules/old-a.md" ]; then FAIL=true; fi
      if [ -e "$WORK_DIR/.claude/rules/old-b.md" ] || [ -L "$WORK_DIR/.claude/rules/old-b.md" ]; then FAIL=true; fi
      if $FAIL; then
        echo "FAIL: stale symlinks remain"
        exit 1
      fi
      echo "OK: multiple stale symlinks removed"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "removed stale"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .claude/yf.json .claude/yf.local.json"
  - "rm -f .claude/rules/deprecated-rule.md .claude/rules/old-a.md .claude/rules/old-b.md"
