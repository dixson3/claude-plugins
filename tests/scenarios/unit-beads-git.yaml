name: "Unit: beads dolt backend — no sync, no hooks"

steps:
  # Case 1: setup-project.sh generates .gitignore without .beads/ in managed block
  - name: "gitignore_no_beads"
    run: |
      rm -f "$WORK_DIR/.gitignore"
      mkdir -p "$WORK_DIR/.yoshiko-flow"
      echo '{"enabled": true}' > "$WORK_DIR/.yoshiko-flow/config.json"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/setup-project.sh" gitignore 2>&1
      MANAGED=$(awk '/# >>> yf-managed >>>/,/# <<< yf-managed <<</' "$WORK_DIR/.gitignore" 2>/dev/null || echo "")
      if echo "$MANAGED" | grep -q '\.beads/'; then
        echo "FAIL: .gitignore yf-managed block still contains .beads/"
        exit 1
      fi
      echo "OK: .gitignore yf-managed block does not contain .beads/"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: preflight.json setup uses beads-setup.sh (consolidated setup)
  - name: "preflight_uses_beads_setup_sh"
    run: |
      RUN_CMD=$(jq -r '.artifacts.setup[] | select(.name == "beads-setup") | .run' "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json")
      if echo "$RUN_CMD" | grep -q 'beads-setup.sh'; then
        echo "OK: preflight uses beads-setup.sh"
      else
        echo "FAIL: preflight setup is '$RUN_CMD', expected beads-setup.sh"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: preflight.json does NOT include bd hooks install (dolt mode — hooks are no-ops)
  - name: "preflight_no_hooks_install"
    run: |
      RUN_CMD=$(jq -r '.artifacts.setup[] | select(.name == "beads-setup") | .run' "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json")
      if echo "$RUN_CMD" | grep -q 'bd hooks install'; then
        echo "FAIL: preflight still includes bd hooks install"
        exit 1
      fi
      echo "OK: preflight does not include bd hooks install"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: yf-rules.md Quick Reference does NOT contain sync reference (dolt persists immediately)
  - name: "rules_no_bd_sync"
    run: |
      if grep -A15 '## Quick Reference\|### 4.1' "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md" | grep -q 'sync'; then
        echo "FAIL: yf-rules.md Quick Reference still includes sync reference"
        exit 1
      fi
      echo "OK: yf-rules.md Quick Reference does not include sync reference"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: yf-rules.md contains beads session protocol
  - name: "rules_has_session_protocol"
    run: |
      if grep -q 'SESSION PROTOCOL' "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md"; then
        echo "OK: yf-rules.md contains session protocol"
      else
        echo "FAIL: yf-rules.md missing session protocol"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: yf-rules.md does NOT contain "Beads Are Local"
  - name: "rules_no_local_section"
    run: |
      if grep -q 'Beads Are Local' "$PLUGIN_DIR/plugins/yf/rules/yf-rules.md"; then
        echo "FAIL: yf-rules.md still contains 'Beads Are Local' section"
        exit 1
      fi
      echo "OK: yf-rules.md does not contain 'Beads Are Local'"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: README.md no longer says "local-only"
  - name: "readme_no_local_only"
    run: |
      if grep -q 'local-only' "$PLUGIN_DIR/plugins/yf/README.md"; then
        echo "FAIL: README.md still says 'local-only'"
        exit 1
      fi
      echo "OK: README.md does not say 'local-only'"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: custom beads push hook removed from plugin-preflight.sh (bd hooks manage pre-push)
  - name: "no_custom_push_hook"
    run: |
      if grep -q "install_beads_push_hook\|BEADS-SYNC-PUSH" "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh"; then
        echo "FAIL: custom beads push hook still present in plugin-preflight.sh"
        exit 1
      fi
      echo "OK: custom beads push hook removed, bd hooks manage pre-push"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: setup-project.sh MANAGED_BLOCK does not include .beads/
  - name: "setup_project_no_beads"
    run: |
      if grep -A5 'MANAGED_BLOCK=' "$PLUGIN_DIR/plugins/yf/scripts/setup-project.sh" | grep -q '\.beads/'; then
        echo "FAIL: setup-project.sh MANAGED_BLOCK still includes .beads/"
        exit 1
      fi
      echo "OK: setup-project.sh MANAGED_BLOCK does not include .beads/"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: preflight.json does NOT contain sync.branch config
  - name: "preflight_no_sync_branch"
    run: |
      RUN_CMD=$(jq -r '.artifacts.setup[] | select(.name == "beads-setup") | .run' "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json")
      if echo "$RUN_CMD" | grep -q 'sync.branch'; then
        echo "FAIL: preflight still references sync.branch"
        exit 1
      fi
      echo "OK: preflight does not reference sync.branch"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 11: post-push-prune.sh does NOT contain bd sync
  - name: "post_push_prune_no_sync"
    run: |
      if grep -q 'bd sync' "$PLUGIN_DIR/plugins/yf/hooks/post-push-prune.sh"; then
        echo "FAIL: post-push-prune.sh still contains bd sync"
        exit 1
      fi
      echo "OK: post-push-prune.sh does not contain bd sync"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 12: preflight setup check validates both .beads dir AND no-git-ops
  - name: "preflight_setup_check_validates_both"
    run: |
      CHECK_CMD=$(jq -r '.artifacts.setup[] | select(.name == "beads-setup") | .check' "$PLUGIN_DIR/plugins/yf/.claude-plugin/preflight.json")
      if echo "$CHECK_CMD" | grep -q 'test -d .beads' && echo "$CHECK_CMD" | grep -q 'no-git-ops'; then
        echo "OK: preflight check validates .beads dir and no-git-ops"
      else
        echo "FAIL: preflight check is '$CHECK_CMD', expected both .beads and no-git-ops"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"
