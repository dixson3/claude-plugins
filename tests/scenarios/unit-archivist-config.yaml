name: "Unit: yf-config.sh â€” archivist toggle"

setup:
  - "mkdir -p .yoshiko-flow"

steps:
  # Case 1: Missing config defaults to enabled (true)
  - name: "archivist_default_enabled"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      export _YF_PROJECT_DIR="$WORK_DIR"
      export _YF_JSON="$WORK_DIR/.yoshiko-flow/config.json"
      if yf_is_archivist_on; then
        echo "OK: defaults to enabled"
      else
        echo "FAIL: should default to enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Explicit true returns enabled
  - name: "archivist_explicit_true"
    run: |
      echo '{"config":{"archivist_enabled":true}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      export _YF_PROJECT_DIR="$WORK_DIR"
      export _YF_JSON="$WORK_DIR/.yoshiko-flow/config.json"
      if yf_is_archivist_on; then
        echo "OK: explicit true is enabled"
      else
        echo "FAIL: explicit true should be enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Explicit false returns disabled
  - name: "archivist_explicit_false"
    run: |
      echo '{"config":{"archivist_enabled":false}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      export _YF_PROJECT_DIR="$WORK_DIR"
      export _YF_JSON="$WORK_DIR/.yoshiko-flow/config.json"
      if yf_is_archivist_on; then
        echo "FAIL: explicit false should be disabled"
        exit 1
      else
        echo "OK: explicit false is disabled"
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Malformed config (no archivist key) defaults to enabled
  - name: "archivist_missing_key"
    run: |
      echo '{"config":{"chronicler_enabled":true}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      . "$PLUGIN_DIR/plugins/yf/scripts/yf-config.sh"
      export _YF_PROJECT_DIR="$WORK_DIR"
      export _YF_JSON="$WORK_DIR/.yoshiko-flow/config.json"
      if yf_is_archivist_on; then
        echo "OK: missing key defaults to enabled"
      else
        echo "FAIL: missing key should default to enabled"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
