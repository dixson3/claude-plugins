name: "Unit: session-recall.sh â€” SessionStart chronicle recovery"

setup:
  - "mkdir -p .yoshiko-flow .beads"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}'  > .yoshiko-flow/config.json"

steps:
  # Case 1: Exits silently when yf disabled
  - name: "exits_when_yf_disabled"
    run: |
      echo '{"enabled":false}' > "$WORK_DIR/.yoshiko-flow/config.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/session-recall.sh" 2>&1)
      EXIT_CODE=$?
      if [ "$EXIT_CODE" -eq 0 ] && [ -z "$OUTPUT" ]; then
        echo "OK: exits silently when yf disabled"
      else
        echo "FAIL: should exit 0 silently (exit=$EXIT_CODE, output=$OUTPUT)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: Silent when no open chronicles and no marker
  - name: "silent_when_no_chronicles"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.beads/.pending-diary"
      mkdir -p "$WORK_DIR/mock-bin"
      cat > "$WORK_DIR/mock-bin/bd" << 'MOCK'
      #!/bin/bash
      if [ "$1" = "list" ]; then
        echo "[]"
        exit 0
      fi
      echo "{}"
      MOCK
      chmod +x "$WORK_DIR/mock-bin/bd"
      OUTPUT=$(PATH="$WORK_DIR/mock-bin:$PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/session-recall.sh" 2>&1)
      EXIT_CODE=$?
      if [ "$EXIT_CODE" -eq 0 ] && [ -z "$OUTPUT" ]; then
        echo "OK: silent when no chronicles and no marker"
      else
        echo "FAIL: should be silent (exit=$EXIT_CODE, output=$OUTPUT)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Outputs summary when open chronicles exist
  - name: "outputs_summary_with_chronicles"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.beads/.pending-diary"
      cat > "$WORK_DIR/mock-bin/bd" << 'MOCK'
      #!/bin/bash
      if [ "$1" = "list" ]; then
        echo '[{"id":"test-001","title":"Chronicle: test context"},{"id":"test-002","title":"Chronicle: more context"}]'
        exit 0
      fi
      echo "{}"
      MOCK
      chmod +x "$WORK_DIR/mock-bin/bd"
      OUTPUT=$(PATH="$WORK_DIR/mock-bin:$PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/session-recall.sh" 2>&1)
      EXIT_CODE=$?
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "CHRONICLER: 2 open chronicle(s) detected" && \
         echo "$OUTPUT" | grep -q "test-001" && \
         echo "$OUTPUT" | grep -q "chronicle_recall"; then
        echo "OK: outputs chronicle summary with recall suggestion"
      else
        echo "FAIL: missing expected output"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Detects and consumes pending-diary marker
  - name: "detects_pending_diary_marker"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      mkdir -p "$WORK_DIR/.beads"
      cat > "$WORK_DIR/.beads/.pending-diary" << 'MARKER'
      {"created":"2026-02-09T14:30:00Z","reason":"session_end","chronicle_count":3,"draft_created":true}
      MARKER
      cat > "$WORK_DIR/mock-bin/bd" << 'MOCK'
      #!/bin/bash
      if [ "$1" = "list" ]; then
        echo '[{"id":"test-001","title":"Chronicle: test context"}]'
        exit 0
      fi
      echo "{}"
      MOCK
      chmod +x "$WORK_DIR/mock-bin/bd"
      OUTPUT=$(PATH="$WORK_DIR/mock-bin:$PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/session-recall.sh" 2>&1)
      EXIT_CODE=$?
      echo "$OUTPUT"
      # Check marker was consumed
      if [ -f "$WORK_DIR/.beads/.pending-diary" ]; then
        echo "FAIL: marker was not consumed"
        exit 1
      fi
      if echo "$OUTPUT" | grep -q "DEFERRED DIARY" && \
         echo "$OUTPUT" | grep -q "chronicle_diary"; then
        echo "OK: detects pending-diary and suggests diary generation"
      else
        echo "FAIL: missing expected pending-diary output"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Shows pending-diary even with zero current chronicles
  - name: "pending_diary_with_no_current_chronicles"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      mkdir -p "$WORK_DIR/.beads"
      cat > "$WORK_DIR/.beads/.pending-diary" << 'MARKER'
      {"created":"2026-02-09T14:30:00Z","reason":"session_end","chronicle_count":2,"draft_created":false}
      MARKER
      cat > "$WORK_DIR/mock-bin/bd" << 'MOCK'
      #!/bin/bash
      if [ "$1" = "list" ]; then
        echo "[]"
        exit 0
      fi
      echo "{}"
      MOCK
      chmod +x "$WORK_DIR/mock-bin/bd"
      OUTPUT=$(PATH="$WORK_DIR/mock-bin:$PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/session-recall.sh" 2>&1)
      EXIT_CODE=$?
      echo "$OUTPUT"
      if [ -f "$WORK_DIR/.beads/.pending-diary" ]; then
        echo "FAIL: marker was not consumed"
        exit 1
      fi
      if echo "$OUTPUT" | grep -q "DEFERRED DIARY"; then
        echo "OK: shows deferred diary notice even with no current chronicles"
      else
        echo "FAIL: should show deferred diary notice"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: Always exits 0
  - name: "always_exits_zero"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.beads/.pending-diary"
      # Use a bd that fails
      cat > "$WORK_DIR/mock-bin/bd" << 'MOCK'
      #!/bin/bash
      exit 1
      MOCK
      chmod +x "$WORK_DIR/mock-bin/bd"
      PATH="$WORK_DIR/mock-bin:$PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/session-recall.sh" >/dev/null 2>&1
      echo "OK: exit code $?"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: Warns about plan without beads
  - name: "plan_without_beads_warns"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.beads/.pending-diary"
      mkdir -p "$WORK_DIR/docs/plans"
      printf '# Plan 99\n**Status:** Draft' > "$WORK_DIR/docs/plans/plan-99.md"
      cat > "$WORK_DIR/mock-bin/bd" << 'MOCK'
      #!/bin/bash
      if [ "$1" = "list" ]; then
        echo "[]"
        exit 0
      fi
      echo "{}"
      MOCK
      chmod +x "$WORK_DIR/mock-bin/bd"
      OUTPUT=$(PATH="$WORK_DIR/mock-bin:$PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/session-recall.sh" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "WARNING.*Plan 99.*no beads"; then
        echo "OK: warns about plan without beads"
      else
        echo "FAIL: should warn about plan without beads"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 8: No warning for completed plan
  - name: "completed_plan_no_warning"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.beads/.pending-diary"
      mkdir -p "$WORK_DIR/docs/plans"
      printf '# Plan 99\n**Status: Completed**' > "$WORK_DIR/docs/plans/plan-99.md"
      cat > "$WORK_DIR/mock-bin/bd" << 'MOCK'
      #!/bin/bash
      if [ "$1" = "list" ]; then
        echo "[]"
        exit 0
      fi
      echo "{}"
      MOCK
      chmod +x "$WORK_DIR/mock-bin/bd"
      OUTPUT=$(PATH="$WORK_DIR/mock-bin:$PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/session-recall.sh" 2>&1)
      if [ -z "$OUTPUT" ]; then
        echo "OK: no warning for completed plan"
      else
        echo "FAIL: unexpected output: $OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 9: Detects and consumes dirty-tree marker
  - name: "detects_dirty_tree_marker"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.beads/.pending-diary"
      rm -rf "$WORK_DIR/docs/plans"
      mkdir -p "$WORK_DIR/.beads"
      echo '{"created":"2026-02-18T10:00:00Z","reason":"session_end","dirty_count":5}' > "$WORK_DIR/.beads/.dirty-tree"
      cat > "$WORK_DIR/mock-bin/bd" << 'MOCK'
      #!/bin/bash
      if [ "$1" = "list" ]; then
        echo "[]"
        exit 0
      fi
      echo "{}"
      MOCK
      chmod +x "$WORK_DIR/mock-bin/bd"
      OUTPUT=$(PATH="$WORK_DIR/mock-bin:$PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/session-recall.sh" 2>&1)
      echo "$OUTPUT"
      # Marker should be consumed
      if [ -f "$WORK_DIR/.beads/.dirty-tree" ]; then
        echo "FAIL: dirty-tree marker was not consumed"
        exit 1
      fi
      if echo "$OUTPUT" | grep -q "DIRTY TREE" && \
         echo "$OUTPUT" | grep -q "5 uncommitted"; then
        echo "OK: detects dirty-tree marker and warns"
      else
        echo "FAIL: missing dirty-tree warning"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 10: No dirty-tree warning when no marker
  - name: "no_dirty_tree_without_marker"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.beads/.pending-diary"
      rm -f "$WORK_DIR/.beads/.dirty-tree"
      rm -rf "$WORK_DIR/docs/plans"
      cat > "$WORK_DIR/mock-bin/bd" << 'MOCK'
      #!/bin/bash
      if [ "$1" = "list" ]; then
        echo "[]"
        exit 0
      fi
      echo "{}"
      MOCK
      chmod +x "$WORK_DIR/mock-bin/bd"
      OUTPUT=$(PATH="$WORK_DIR/mock-bin:$PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/session-recall.sh" 2>&1)
      if [ -z "$OUTPUT" ]; then
        echo "OK: silent when no dirty-tree marker"
      else
        echo "FAIL: unexpected output: $OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
  - "rm -f .beads/.pending-diary"
  - "rm -f .beads/.dirty-tree"
  - "rm -rf mock-bin"
  - "rm -rf docs/plans"
