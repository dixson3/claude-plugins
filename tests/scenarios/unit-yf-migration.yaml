name: "Unit: plugin-lock.json â†’ yf.local.json migration"

setup:
  - "mkdir -p .claude/rules docs/plans docs/diary"

steps:
  # Case 1: Old lock file migrates to new format
  - name: "migrate_old_lock"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/plugin-lock.json"
      # Create old-format lock file
      cat > "$WORK_DIR/.claude/plugin-lock.json" <<'LOCK'
      {
        "version": 1,
        "updated": "2026-02-08T00:00:00Z",
        "plugins": {
          "workflows": {
            "version": "1.7.0",
            "artifacts": {
              "rules": [{"target": ".claude/rules/BEADS.md", "checksum": "sha256:abc"}],
              "directories": ["docs/plans"],
              "setup": [{"name": "beads", "completed": true}]
            }
          }
        }
      }
      LOCK
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "migrating"

  # Case 2: After migration, config is in yf.local.json (no yf.json)
  - name: "config_in_local_only"
    run: |
      if [ -f "$WORK_DIR/.claude/yf.json" ]; then
        echo "FAIL: yf.json should not exist (local-only model)"
        exit 1
      fi
      if [ ! -f "$WORK_DIR/.claude/yf.local.json" ]; then
        echo "FAIL: yf.local.json not found"
        exit 1
      fi
      MODE=$(jq -r '.preflight.plugins.yf.mode' "$WORK_DIR/.claude/yf.local.json")
      if [ "$MODE" = "symlink" ]; then
        echo "OK: config in yf.local.json with symlink mode"
      else
        echo "FAIL: mode=$MODE"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Old lock file deleted
  - name: "old_lock_deleted"
    run: |
      if [ -f "$WORK_DIR/.claude/plugin-lock.json" ]; then
        echo "FAIL: old lock still exists"
        exit 1
      fi
      echo "OK: old lock deleted"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Preflight data in yf.local.json after migration
  - name: "preflight_in_local"
    run: |
      if jq -e '.preflight.plugins' "$WORK_DIR/.claude/yf.local.json" >/dev/null 2>&1; then
        echo "OK: preflight in local file"
      else
        echo "FAIL: preflight missing from local"
        jq '.' "$WORK_DIR/.claude/yf.local.json"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: No migration needed when yf.local.json already exists
  - name: "no_migration_when_exists"
    run: |
      # yf.local.json already exists from previous steps
      # Create a dummy old lock to see if it gets ignored
      echo '{"version":1,"plugins":{}}' > "$WORK_DIR/.claude/plugin-lock.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      # Old lock should NOT have been deleted since yf.local.json already existed
      if [ -f "$WORK_DIR/.claude/plugin-lock.json" ]; then
        echo "OK: old lock untouched when yf.local.json exists"
      else
        echo "FAIL: old lock was deleted even though yf.local.json exists"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: Fresh install creates yf.local.json only
  - name: "fresh_install_structure"
    run: |
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/plugin-lock.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      HAS_YF_JSON=$(test -f "$WORK_DIR/.claude/yf.json" && echo "yes" || echo "no")
      HAS_LOCAL=$(jq -e '.preflight.plugins.yf' "$WORK_DIR/.claude/yf.local.json" >/dev/null 2>&1 && echo "yes" || echo "no")
      echo "yf_json=$HAS_YF_JSON preflight_local=$HAS_LOCAL"
      if [ "$HAS_YF_JSON" = "no" ] && [ "$HAS_LOCAL" = "yes" ]; then
        echo "OK: local-only structure"
      else
        echo "FAIL: wrong structure"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .claude/yf.json .claude/yf.local.json .claude/plugin-lock.json"
