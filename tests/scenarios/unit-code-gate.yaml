name: "Unit: code-gate.sh"
setup:
  - "mkdir -p src .claude .yoshiko-flow .claude-plugin .beads docs/plans"
  - "echo '# test' > README.md"
  - "echo '# changelog' > CHANGELOG.md"
  - "echo '# memory' > MEMORY.md"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}'  > .yoshiko-flow/config.json"

steps:
  # Case 1: No gate file → allow
  - name: "no_gate_allows"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 2: Gate + exempt docs/plans → allow
  - name: "gate_exempt_docs_plans"
    run: |
      echo '{"plan_idx":"05"}' > .yoshiko-flow/plan-gate
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/docs/plans/plan-01.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 3: Gate + exempt .claude/ → allow
  - name: "gate_exempt_claude_dir"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/.claude/rules/foo.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 4: Gate + exempt CHANGELOG.md → allow
  - name: "gate_exempt_changelog"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/CHANGELOG.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 5: Gate + exempt README.md → allow
  - name: "gate_exempt_readme"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/README.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 6: Gate + exempt .beads/ → allow
  - name: "gate_exempt_beads"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/.beads/issues.jsonl"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 7: Gate + exempt .claude-plugin/*.json → allow
  - name: "gate_exempt_plugin_json"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/.claude-plugin/plugin.json"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 8: Gate + exempt MEMORY.md → allow
  - name: "gate_exempt_memory"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/MEMORY.md"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 9: Gate + non-exempt source file → block (exit 2)
  - name: "gate_blocks_source"
    run: |
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>/dev/null
    assertions:
      - type: exit_code
        value: "2"

  # Case 10: Gate + empty file_path → fail-open
  - name: "gate_failopen_empty_path"
    run: |
      echo '{"tool_input":{}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 11: Gate + invalid JSON → fail-open
  - name: "gate_failopen_bad_json"
    run: |
      echo 'not json at all' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh"
    assertions:
      - type: exit_code
        value: "0"

  # Case 12: Chronicle nudge when stale (no gate, in-progress beads, no recent chronicle)
  - name: "chronicle_nudge_warning"
    run: |
      rm -f .yoshiko-flow/plan-gate
      rm -f .yoshiko-flow/.chronicle-nudge
      rm -f .yoshiko-flow/plan-intake-ok
      rm -rf docs/plans/plan-*.md
      mkdir -p "$WORK_DIR/mock-bin"
      cat > "$WORK_DIR/mock-bin/bd" << 'MOCK'
      #!/bin/bash
      if [ "$1" = "list" ]; then
        if echo "$@" | grep -q "in_progress"; then
          echo '[{"id":"t1","title":"Work","status":"in_progress"}]'
          exit 0
        fi
        if echo "$@" | grep -q "chronicle"; then
          echo "[]"
          exit 0
        fi
        echo "[]"
        exit 0
      fi
      echo "{}"
      MOCK
      chmod +x "$WORK_DIR/mock-bin/bd"
      OUTPUT=$(echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/main.py"}}' | \
        PATH="$WORK_DIR/mock-bin:$PATH" CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>&1)
      echo "$OUTPUT"
      if echo "$OUTPUT" | grep -q "NOTE:"; then
        echo "OK: nudge warning emitted"
      else
        echo "OK: nudge may not fire (timing dependent)"
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 13: Block output contains BLOCKED message
  - name: "gate_block_message"
    run: |
      echo '{"plan_idx":"05"}' > .yoshiko-flow/plan-gate
      echo '{"tool_input":{"file_path":"'"$WORK_DIR"'/src/app.js"}}' | \
        CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/hooks/code-gate.sh" 2>/dev/null || true
    assertions:
      - type: output_contains
        value: "BLOCKED"
      - type: output_not_contains
        value: "dismiss_gate"

teardown:
  - "rm -f .yoshiko-flow/plan-gate .yoshiko-flow/.chronicle-nudge"
  - "rm -rf mock-bin"
