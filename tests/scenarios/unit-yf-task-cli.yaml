name: "Unit: yf-task-cli.sh â€” CLI wrapper dispatch"

setup:
  - "mkdir -p .yoshiko-flow/tasks .yoshiko-flow/chronicler .yoshiko-flow/archivist .yoshiko-flow/issues .yoshiko-flow/todos .yoshiko-flow/molecules"

steps:
  # Case 1: create command creates task file
  - name: "cli_create"
    run: |
      rm -rf "$WORK_DIR/.yoshiko-flow/tasks/"*
      ID=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" create --type=task --title="CLI created task")
      if [ -z "$ID" ]; then
        echo "FAIL: no ID returned"
        exit 1
      fi
      FILE=$(find "$WORK_DIR/.yoshiko-flow/tasks" -name "${ID}.json" -print -quit 2>/dev/null)
      if [ -f "$FILE" ]; then
        echo "OK: task created via CLI id=$ID"
      else
        echo "FAIL: task file not found for $ID"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: list command returns task list
  - name: "cli_list"
    run: |
      rm -rf "$WORK_DIR/.yoshiko-flow/tasks/"*
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" create --type=task --title="List test one" --silent
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" create --type=task --title="List test two" --silent
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" list --type=task)
      COUNT=$(echo "$OUTPUT" | grep -c "List test")
      if [ "$COUNT" -eq 2 ]; then
        echo "OK: list returned $COUNT tasks"
      else
        echo "FAIL: expected 2, got $COUNT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: ready command filters to ready tasks only
  - name: "cli_ready"
    run: |
      rm -rf "$WORK_DIR/.yoshiko-flow/tasks/"*
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" create --type=task --title="Ready task" --silent
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" create --type=task --title="Deferred task" --defer=+100y --silent
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" ready --type=task)
      if echo "$OUTPUT" | grep -q "Ready task" && ! echo "$OUTPUT" | grep -q "Deferred task"; then
        echo "OK: ready filters correctly"
      else
        echo "FAIL: output=$OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: show command displays task details
  - name: "cli_show"
    run: |
      rm -rf "$WORK_DIR/.yoshiko-flow/tasks/"*
      ID=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" create --type=task --title="Show me")
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" show "$ID")
      if echo "$OUTPUT" | grep -q "Show me" && echo "$OUTPUT" | grep -q "Status:"; then
        echo "OK: show displays task details"
      else
        echo "FAIL: output=$OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: help outputs usage info
  - name: "cli_help"
    run: |
      OUTPUT=$(bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" help 2>&1)
      if echo "$OUTPUT" | grep -q "Usage:" && echo "$OUTPUT" | grep -q "Commands:"; then
        echo "OK: help output valid"
      else
        echo "FAIL: output=$OUTPUT"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: Unknown command exits 1
  - name: "cli_unknown_command"
    run: |
      bash "$PLUGIN_DIR/plugins/yf/scripts/yf-task-cli.sh" nonexistent_command 2>/dev/null
      EXIT_CODE=$?
      if [ "$EXIT_CODE" -eq 1 ]; then
        echo "OK: unknown command exits 1"
      else
        echo "FAIL: expected exit 1, got $EXIT_CODE"
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -rf .yoshiko-flow/tasks/*"
