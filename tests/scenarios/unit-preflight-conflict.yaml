name: "Unit: plugin-preflight.sh — conflict detection"

setup:
  - "mkdir -p .claude/rules docs/plans docs/diary"

steps:
  # Case 1: User-modified rule is not overwritten
  - name: "conflict_skips_user_modified"
    run: |
      # Clean install
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      # User modifies a rule
      echo "# User customization" >> "$WORK_DIR/.claude/rules/yf-engage-the-plan.md"
      # Modify the source too (simulate plugin update)
      cp "$PLUGIN_DIR/plugins/yf/rules/yf-engage-the-plan.md" /tmp/engage-backup.md
      echo "" >> "$PLUGIN_DIR/plugins/yf/rules/yf-engage-the-plan.md"
      # Run preflight
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      # Restore source
      cp /tmp/engage-backup.md "$PLUGIN_DIR/plugins/yf/rules/yf-engage-the-plan.md"
      rm /tmp/engage-backup.md
      # User's modification should still be there
      if grep -q "User customization" "$WORK_DIR/.claude/rules/yf-engage-the-plan.md"; then
        echo "OK: user modification preserved"
      else
        echo "FAIL: user modification lost"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "CONFLICT"
      - type: output_contains
        value: "OK"

  # Case 2: Source-only change updates rule (user hasn't modified)
  - name: "source_change_updates_rule"
    run: |
      # Clean install
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      # Modify only the source (simulate plugin update)
      cp "$PLUGIN_DIR/plugins/yf/rules/yf-engage-the-plan.md" /tmp/engage-backup.md
      echo "# Plugin update v2" >> "$PLUGIN_DIR/plugins/yf/rules/yf-engage-the-plan.md"
      # Run preflight
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
      # Restore source
      cp /tmp/engage-backup.md "$PLUGIN_DIR/plugins/yf/rules/yf-engage-the-plan.md"
      rm /tmp/engage-backup.md
      # Installed should have the update
      if grep -q "Plugin update v2" "$WORK_DIR/.claude/rules/yf-engage-the-plan.md"; then
        echo "OK: rule updated from source"
      else
        echo "FAIL: rule not updated"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "updated"
      - type: output_contains
        value: "OK"

  # Case 3: Identical files are no-op
  - name: "identical_is_noop"
    run: |
      # Clean install
      rm -f "$WORK_DIR/.claude/yf.json" "$WORK_DIR/.claude/yf.local.json"
      rm -f "$WORK_DIR/.claude/rules/"*.md
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" >/dev/null 2>&1
      # Run again — everything matches
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/plugin-preflight.sh" 2>&1)
      echo "$OUTPUT"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "up to date"

teardown:
  - "rm -f .claude/yf.json .claude/yf.local.json"
