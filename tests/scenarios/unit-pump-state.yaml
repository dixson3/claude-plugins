name: "Unit: pump-state.sh"
setup:
  - "mkdir -p .claude"

steps:
  # Case 1: Missing file â€” is-dispatched returns not-dispatched
  - name: "missing_file_not_dispatched"
    run: |
      rm -f .claude/.task-pump.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" is-dispatched marketplace-abc 2>/dev/null || true
    assertions:
      - type: output_contains
        value: "not-dispatched"

  # Case 2: Mark dispatched then check
  - name: "mark_then_check_dispatched"
    run: |
      rm -f .claude/.task-pump.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" mark-dispatched marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" is-dispatched marketplace-abc
    assertions:
      - type: output_contains
        value: "dispatched"
      - type: exit_code
        value: "0"

  # Case 3: Duplicate mark is idempotent
  - name: "duplicate_mark_idempotent"
    run: |
      rm -f .claude/.task-pump.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" mark-dispatched marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" mark-dispatched marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" is-dispatched marketplace-abc
    assertions:
      - type: output_contains
        value: "dispatched"

  # Case 4: Mark done removes from dispatched
  - name: "mark_done_removes_dispatched"
    run: |
      rm -f .claude/.task-pump.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" mark-dispatched marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" mark-done marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" is-dispatched marketplace-abc 2>/dev/null || true
    assertions:
      - type: output_contains
        value: "not-dispatched"

  # Case 5: Pending lists dispatched but not done
  - name: "pending_lists_dispatched"
    run: |
      rm -f .claude/.task-pump.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" mark-dispatched marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" mark-dispatched marketplace-def
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" mark-done marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" pending
    assertions:
      - type: output_contains
        value: "marketplace-def"

  # Case 6: Clear resets all state
  - name: "clear_resets_all"
    run: |
      rm -f .claude/.task-pump.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" mark-dispatched marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" clear
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" pending
    assertions:
      - type: exit_code
        value: "0"

  # Case 7: Clear output is empty pending
  - name: "clear_empty_pending"
    run: |
      rm -f .claude/.task-pump.json
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" mark-dispatched marketplace-abc
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" clear
      RESULT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/pump-state.sh" pending)
      if [ -z "$RESULT" ]; then echo "empty"; else echo "not-empty"; fi
    assertions:
      - type: output_contains
        value: "empty"

teardown:
  - "rm -f .claude/.task-pump.json"
