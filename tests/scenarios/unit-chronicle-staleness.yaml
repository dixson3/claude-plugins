name: "Unit: chronicle-staleness.sh — checkpoint chronicles for stale sessions"

setup:
  - "mkdir -p .yoshiko-flow/tasks .yoshiko-flow/chronicler"
  - "printf '%s' '{\"enabled\":true,\"config\":{\"artifact_dir\":\"docs\"}}'  > .yoshiko-flow/config.json"

steps:
  # Case 1: Exits cleanly when yf disabled
  - name: "exits_when_yf_disabled"
    run: |
      echo '{"enabled":false}' > "$WORK_DIR/.yoshiko-flow/config.json"
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-staleness.sh" 2>&1)
      EXIT_CODE=$?
      if [ "$EXIT_CODE" -eq 0 ] && [ -z "$OUTPUT" ]; then
        echo "OK: exits silently when yf disabled"
      else
        echo "FAIL: should exit 0 silently (exit=$EXIT_CODE, output=$OUTPUT)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 2: No in-progress tasks — no checkpoint created
  - name: "no_in_progress_tasks"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-staleness-"*
      # Ensure no in-progress tasks
      rm -f "$WORK_DIR/.yoshiko-flow/tasks/"*.json
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-staleness.sh" 2>&1)
      EXIT_CODE=$?
      if [ "$EXIT_CODE" -eq 0 ] && [ -z "$OUTPUT" ]; then
        echo "OK: no checkpoint when no in-progress tasks"
      else
        echo "FAIL: should exit silently (exit=$EXIT_CODE, output=$OUTPUT)"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 3: Stale detection — in-progress tasks + no chronicle creates checkpoint
  - name: "stale_creates_checkpoint"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-staleness-"*
      rm -f "$WORK_DIR/.yoshiko-flow/chronicler/"*.json
      # Create an in-progress task
      cat > "$WORK_DIR/.yoshiko-flow/tasks/task-stale-001.json" << 'TASKJSON'
      {"id":"task-stale-001","type":"task","title":"Test task","status":"in_progress","labels":[],"created":"2026-01-01T00:00:00Z"}
      TASKJSON
      BEFORE_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-staleness.sh" 2>&1)
      EXIT_CODE=$?
      AFTER_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      if [ "$AFTER_COUNT" -gt "$BEFORE_COUNT" ]; then
        LATEST=$(ls -t "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | head -1)
        if [ -f "$LATEST" ] && jq -r '.labels[]' "$LATEST" 2>/dev/null | grep -q "ys:chronicle:checkpoint"; then
          echo "OK: checkpoint task created with correct labels"
        else
          echo "FAIL: task labels wrong"
          exit 1
        fi
      else
        # Check dedup file as backup
        DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-staleness-$(date +%Y%m%d)"
        if [ -f "$DEDUP_FILE" ]; then
          echo "OK: checkpoint created (verified via dedup)"
        else
          echo "FAIL: no checkpoint created"
          exit 1
        fi
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 4: Recent chronicle — no checkpoint created
  - name: "recent_chronicle_skips"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-staleness-"*
      NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)
      # Keep in-progress task
      cat > "$WORK_DIR/.yoshiko-flow/tasks/task-stale-001.json" << 'TASKJSON'
      {"id":"task-stale-001","type":"task","title":"Test task","status":"in_progress","labels":[],"created":"2026-01-01T00:00:00Z"}
      TASKJSON
      # Create a recent chronicle
      cat > "$WORK_DIR/.yoshiko-flow/chronicler/chron-stale-001.json" << TASKJSON
      {"id":"chron-stale-001","type":"chronicle","title":"Recent chronicle","status":"open","labels":["ys:chronicle"],"created":"${NOW}"}
      TASKJSON
      BEFORE_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-staleness.sh" 2>&1)
      AFTER_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      if [ "$AFTER_COUNT" -eq "$BEFORE_COUNT" ]; then
        echo "OK: no checkpoint when recent chronicle exists"
      else
        echo "FAIL: should not create checkpoint with recent chronicle"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 5: Dedup prevents duplicate checkpoints in same hour
  - name: "dedup_prevents_duplicates"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      # Write dedup entry for current hour
      DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-staleness-$(date +%Y%m%d)"
      echo "staleness-check-$(date +%H)" > "$DEDUP_FILE"
      # Remove recent chronicle so staleness would normally trigger
      rm -f "$WORK_DIR/.yoshiko-flow/chronicler/chron-stale-"*
      BEFORE_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-staleness.sh" 2>&1)
      AFTER_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      if [ "$AFTER_COUNT" -eq "$BEFORE_COUNT" ]; then
        echo "OK: dedup prevented duplicate checkpoint"
      else
        echo "FAIL: should not create duplicate"
        exit 1
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 6: Custom threshold via --threshold flag
  - name: "custom_threshold"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      rm -f "$WORK_DIR/.yoshiko-flow/.chronicle-staleness-"*
      rm -f "$WORK_DIR/.yoshiko-flow/chronicler/"*.json
      # Keep in-progress task
      cat > "$WORK_DIR/.yoshiko-flow/tasks/task-stale-001.json" << 'TASKJSON'
      {"id":"task-stale-001","type":"task","title":"Test task","status":"in_progress","labels":[],"created":"2026-01-01T00:00:00Z"}
      TASKJSON
      # Use threshold of 0 hours — should always trigger with no chronicle
      BEFORE_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      OUTPUT=$(CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-staleness.sh" --threshold 0 2>&1)
      AFTER_COUNT=$(ls "$WORK_DIR/.yoshiko-flow/chronicler/"*.json 2>/dev/null | wc -l | tr -d ' ')
      if [ "$AFTER_COUNT" -gt "$BEFORE_COUNT" ]; then
        echo "OK: custom threshold works"
      else
        DEDUP_FILE="$WORK_DIR/.yoshiko-flow/.chronicle-staleness-$(date +%Y%m%d)"
        if [ -f "$DEDUP_FILE" ]; then
          echo "OK: custom threshold works (verified via dedup)"
        else
          echo "FAIL: custom threshold should trigger checkpoint"
          exit 1
        fi
      fi
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

  # Case 7: Always exits 0 (fail-open)
  - name: "always_exits_zero"
    run: |
      rm -f "$WORK_DIR/.yoshiko-flow/config.json"
      echo '{"enabled":true,"config":{}}' > "$WORK_DIR/.yoshiko-flow/config.json"
      CLAUDE_PROJECT_DIR="$WORK_DIR" bash "$PLUGIN_DIR/plugins/yf/scripts/chronicle-staleness.sh" 2>/dev/null
      echo "OK: exit code $?"
    assertions:
      - type: exit_code
        value: "0"
      - type: output_contains
        value: "OK"

teardown:
  - "rm -f .yoshiko-flow/config.json"
  - "rm -rf .yoshiko-flow/.chronicle-staleness-* .yoshiko-flow/chronicler/*.json .yoshiko-flow/tasks/task-stale-*"
